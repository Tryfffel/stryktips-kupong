<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèÜ Stryktipset ‚Äì Min Kupong</title>
<style>
/* ‚ïê‚ïê‚ïê DESIGN SYSTEM ‚Äî PREMIUM SPORTS ‚ïê‚ïê‚ïê */
:root {
  --navy:   #0d1e3d;
  --blue:   #1d4ed8;
  --blue2:  #3b82f6;
  --green:  #059669;
  --purple: #6d28d9;
  --amber:  #d97706;
  --red:    #dc2626;
  --bg:     #f0f4f9;
  --card:   #ffffff;
  --text:   #0f172a;
  --muted:  #64748b;
  --border: #e2e8f0;
  --sh:     0 4px 24px rgba(13,30,61,.09);
}

/* ‚ïê‚ïê‚ïê RESET & BASE ‚ïê‚ïê‚ïê */
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
header {
  background: linear-gradient(135deg, #0d1e3d 0%, #1e3a8a 100%);
  padding: 22px 24px 18px; text-align: center; color: #fff;
  border-bottom: 3px solid #f59e0b;
}
header h1 { font-size: 2rem; font-weight: 900; letter-spacing: -0.5px; text-shadow: 0 2px 8px rgba(0,0,0,.3); }
header p  { font-size: .95rem; opacity: .75; margin-top: 4px; }
#paste-btn {
  margin-top: 12px; padding: 8px 22px; border-radius: 30px;
  border: 2px solid rgba(245,158,11,.7); background: rgba(245,158,11,.12);
  color: #fde68a; font-size: .85rem; font-weight: 700; cursor: pointer;
  transition: background .15s; letter-spacing: .3px;
}
#paste-btn:hover { background: rgba(245,158,11,.25); }
#fetch-btn {
  margin-top: 8px; padding: 8px 22px; border-radius: 30px;
  border: 2px solid rgba(52,211,153,.7); background: rgba(52,211,153,.12);
  color: #6ee7b7; font-size: .85rem; font-weight: 700; cursor: pointer;
  transition: background .15s; letter-spacing: .3px;
}
#fetch-btn:hover { background: rgba(52,211,153,.25); }
#fetch-btn:disabled { opacity: .5; cursor: not-allowed; }
#round-picker {
  margin-top: 8px; padding: 8px 16px 8px 14px; border-radius: 30px;
  border: 2px solid rgba(167,139,250,.7); background-color: rgba(167,139,250,.12);
  color: #c4b5fd; font-size: .85rem; font-weight: 700; cursor: pointer;
  transition: background .15s; letter-spacing: .3px;
  appearance: none; -webkit-appearance: none; max-width: 260px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23c4b5fd' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 12px center; padding-right: 30px;
}
#round-picker:hover { background-color: rgba(167,139,250,.25); }
#round-picker option { background: #1e3a8a; color: #fff; }

/* ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê */
#submit-timer { position:sticky; top:0; z-index:100; background:linear-gradient(135deg,#0d1e3d,#1e40af); color:#fff; padding:10px 24px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between; box-shadow:0 3px 16px rgba(13,30,61,.3); }
#submit-timer.warning { background:linear-gradient(135deg,#78350f,#b45309); }
#submit-timer.ok      { background:linear-gradient(135deg,#064e3b,#059669); }
#submit-timer.danger  { background:linear-gradient(135deg,#7f1d1d,#dc2626); animation:pulse-red .8s infinite alternate; }
@keyframes pulse-red { from{opacity:1} to{opacity:.8} }
.timer-left  { font-size:.8rem; opacity:.75; }
.timer-clock { font-size:1.4rem; font-weight:900; letter-spacing:1px; font-variant-numeric:tabular-nums; }
.timer-msg   { font-size:.82rem; font-weight:700; }
.timer-hint  { font-size:.7rem; opacity:.65; }

/* ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê */
#tabs { display: flex; background: #0d1e3d; }
.tab-btn { flex: 1; padding: 14px 12px; background: none; border: none; color: rgba(255,255,255,.45); font-size: .92rem; font-weight: 700; cursor: pointer; transition: all .15s; border-bottom: 3px solid transparent; }
.tab-btn:hover  { color: rgba(255,255,255,.8); }
.tab-btn.active { color: #f59e0b; border-bottom-color: #f59e0b; }

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.wrap { max-width: 900px; margin: 0 auto; padding: 0 16px; }
footer { text-align: center; padding: 24px; color: #94a3b8; font-size: .76rem; }

/* ‚ïê‚ïê‚ïê SORT BAR + COPY BUTTON ‚ïê‚ïê‚ïê */
.sort-btn {
  padding: 4px 12px; border-radius: 20px; font-size: .72rem; font-weight: 700;
  border: 1.5px solid #e2e8f0; background: #fff; color: #64748b;
  cursor: pointer; transition: all .15s; white-space: nowrap;
}
.sort-btn:hover { background: #f1f5f9; color: #334155; }
.sort-btn-active { background: #0d1e3d; color: #fff; border-color: #0d1e3d; }
.copy-kupong-btn {
  padding: 4px 14px; border-radius: 20px; font-size: .72rem; font-weight: 700;
  border: 1.5px solid rgba(245,158,11,.6); background: rgba(245,158,11,.1);
  color: #92400e; cursor: pointer; transition: all .15s; white-space: nowrap;
}
.copy-kupong-btn:hover { background: rgba(245,158,11,.2); }

/* ‚ïê‚ïê‚ïê GUIDE BANNER ‚ïê‚ïê‚ïê */
#guide {
  background: #fff; border-bottom: 1px solid var(--border);
  padding: 12px 20px; display: flex; gap: 10px; justify-content: center;
  flex-wrap: wrap; align-items: center;
}
.step {
  display: flex; align-items: center; gap: 8px;
  background: #eff6ff; border-radius: 30px; padding: 7px 16px;
  font-size: .85rem; font-weight: 600; color: #1d4ed8;
}
.step-num {
  background: #1d4ed8; color: #fff; border-radius: 50%;
  width: 22px; height: 22px; display: flex; align-items: center;
  justify-content: center; font-size: .75rem; font-weight: 900; flex-shrink: 0;
}
.step-arrow { color: #cbd5e1; font-size: 1.2rem; }

/* ‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê */
#legend {
  background: #fffbeb; border-left: 4px solid #f59e0b;
  border-radius: 0 12px 12px 0; padding: 12px 16px;
  font-size: .88rem; line-height: 1.65; color: #451a03;
}
#legend strong { color: #92400e; }
#legend .lg { display: inline-flex; align-items: center; gap: 5px; margin: 0 10px 0 0; }
.lbadge { display: inline-block; border-radius: 6px; padding: 2px 10px; font-weight: 800; font-size: .82rem; }
.lb1 { background: #dbeafe; color: #1e3a8a; }
.lbX { background: #ede9fe; color: #4c1d95; }
.lb2 { background: #d1fae5; color: #064e3b; }

/* ‚ïê‚ïê‚ïê ACTION BUTTONS ‚ïê‚ïê‚ïê */
.big-btn {
  flex: 1; padding: 12px 14px; border-radius: 12px; border: none;
  font-size: .88rem; font-weight: 700; cursor: pointer;
  transition: transform .12s, box-shadow .15s, filter .12s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
  min-width: 120px;
}
.big-btn:hover  { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.12); }
.big-btn:active { transform: translateY(0); filter: brightness(.96); }
.btn-auto    { background: #dbeafe; color: #1e3a8a; }
.btn-value   { background: #d1fae5; color: #064e3b; }
.btn-explain { background: #ede9fe; color: #4c1d95; }
.btn-share   { background: #fef3c7; color: #78350f; }
.btn-reset   { background: #f1f5f9; color: #475569; border: 1.5px solid #e2e8f0; }

/* ‚ïê‚ïê‚ïê PRICE ROW ‚ïê‚ïê‚ïê */
#price-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
#price-row label { font-size: .88rem; font-weight: 600; color: #475569; }
#price-input { width: 70px; padding: 6px 10px; border: 2px solid #93c5fd; border-radius: 8px; font-size: 1rem; font-weight: 700; text-align: center; color: var(--blue); outline: none; }
#price-input:focus { border-color: var(--blue2); }

/* ‚ïê‚ïê‚ïê STATS PANEL (chans-kort) ‚ïê‚ïê‚ïê */
.chance-card {
  background: var(--card); border-radius: 20px; padding: 20px 22px;
  box-shadow: var(--sh); display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr; gap: 14px; align-items: center;
  border: 1.5px solid var(--border);
}
@media(max-width:600px){ .chance-card { grid-template-columns: 1fr 1fr; } }
.cstat { text-align: center; }
.cstat-emoji { font-size: 1.8rem; line-height: 1; margin-bottom: 4px; }
.cstat-label { font-size: .68rem; text-transform: uppercase; letter-spacing: .8px; color: #94a3b8; margin-bottom: 2px; font-weight: 600; }
.cstat-value { font-size: 1.25rem; font-weight: 900; color: var(--text); }
.cstat-sub   { font-size: .72rem; color: #94a3b8; }
.chance-bar-wrap { grid-column: 1 / -1; margin-top: 4px; }
.chance-bar-track { background: #e2e8f0; border-radius: 8px; height: 12px; overflow: hidden; }
.chance-bar-fill  { height: 100%; border-radius: 8px; transition: width .5s cubic-bezier(.4,0,.2,1), background .4s; }
.chance-bar-label { font-size: .82rem; color: #64748b; margin-top: 6px; text-align: center; font-weight: 600; }

/* ‚ïê‚ïê‚ïê DIN RAD-BOX ‚ïê‚ïê‚ïê */
.rad-box { background: var(--card); border-radius: 20px; padding: 18px 22px; box-shadow: var(--sh); border: 1.5px solid var(--border); }
.rad-box h3 { font-size: .75rem; text-transform: uppercase; letter-spacing: 1.2px; color: #94a3b8; margin-bottom: 10px; font-weight: 700; }
#rad-chips { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 12px; }
.rad-chip { border-radius: 8px; padding: 4px 10px; font-size: .83rem; font-weight: 700; border: 1.5px solid transparent; }
.rc-1   { background:#dbeafe; color:#1e40af; border-color:#93c5fd; }
.rc-X   { background:#ede9fe; color:#4c1d95; border-color:#a5b4fc; }
.rc-2   { background:#d1fae5; color:#065f46; border-color:#6ee7b7; }
.rc-1X  { background:#e0e7ff; color:#3730a3; border-color:#a5b4fc; }
.rc-X2  { background:#ccfbf1; color:#134e4a; border-color:#5eead4; }
.rc-12  { background:#e0f2fe; color:#0c4a6e; border-color:#7dd3fc; }
.rc-1X2 { background:#f8fafc; color:#475569; border-color:#cbd5e1; }
.rc-num { font-size: .65rem; opacity: .5; margin-right: 2px; }
#profile-row { display: flex; gap: 20px; padding-top: 12px; border-top: 1px solid var(--border); flex-wrap: wrap; }
.pitem { text-align: center; }
.pcnt  { font-size: 1.5rem; font-weight: 900; }
.plbl  { font-size: .65rem; text-transform: uppercase; color: #94a3b8; font-weight: 600; }
#prof-warn { font-size: .82rem; color: #92400e; margin-top: 8px; font-weight: 600; }

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
#share-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(60px); background: #0d1e3d; color: #fff; padding: 12px 26px; border-radius: 30px; font-size: .9rem; font-weight: 700; box-shadow: 0 8px 32px rgba(13,30,61,.35); transition: transform .3s cubic-bezier(.4,0,.2,1), opacity .3s; opacity: 0; pointer-events: none; z-index: 999; }
#share-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* ‚ïê‚ïê‚ïê EXPLAIN PANEL ‚ïê‚ïê‚ïê */
#explain-panel { background: #eff6ff; border-left: 4px solid #93c5fd; border-radius: 0 14px 14px 0; padding: 16px 20px; display: none; line-height: 1.7; font-size: .9rem; }
#explain-panel h4 { color: var(--blue); font-size: .95rem; margin-bottom: 10px; font-weight: 800; }
#explain-panel .erow { margin-bottom: 8px; }
.e-lock { color: var(--blue); font-weight: 700; }
.e-half { color: var(--purple); font-weight: 700; }
.e-full { color: var(--green); font-weight: 700; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MATCHKORT ‚Äî NYT PREMIUM DESIGN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.match-card {
  background: var(--card); border-radius: 20px; margin-bottom: 12px;
  box-shadow: var(--sh); border: 1.5px solid var(--border);
  overflow: hidden; transition: box-shadow .2s, transform .15s;
}
.match-card:hover { box-shadow: 0 8px 32px rgba(13,30,61,.14); transform: translateY(-1px); }
.match-card.value-match { border-color: #a7f3d0; }
.match-card.risky-match { border-color: #fde68a; }
.match-card.contrarian-match { border-color: #c4b5fd; }

/* ‚îÄ‚îÄ MATCH DATA-TABELL (odds + folk) ‚îÄ‚îÄ‚îÄ */
.mc-data {
  display: grid; grid-template-columns: auto 1fr 1fr 1fr;
  gap: 0; margin: 0 14px 4px; border-radius: 10px;
  overflow: hidden; border: 1px solid #e2e8f0; font-size: .76rem;
}
.mc-data-hdr {
  background: #f8fafc; padding: 3px 6px; font-weight: 800;
  font-size: .65rem; color: #64748b; text-align: center; border-bottom: 1px solid #e2e8f0;
}
.mc-data-lbl {
  padding: 4px 8px; font-weight: 700; font-size: .68rem;
  color: #475569; border-right: 1px solid #e2e8f0;
  display: flex; align-items: center; background: #f8fafc;
}
.mc-data-cell {
  padding: 4px 4px; text-align: center; font-weight: 700;
  border-right: 1px solid #f1f5f9; font-size: .78rem;
}
.mc-data-row { display: contents; }
.mc-data-row:not(:last-child) .mc-data-lbl,
.mc-data-row:not(:last-child) .mc-data-cell { border-bottom: 1px solid #f1f5f9; }
.mc-d1  { color: #2563eb; }
.mc-dx  { color: #64748b; }
.mc-d2  { color: #d97706; }

/* Folk-bar under tabellen */
.mc-folk-bar-row {
  display: flex; margin: 0 14px 4px; height: 5px; border-radius: 3px; overflow: hidden;
}
.mc-folk-1 { background: #3b82f6; }
.mc-folk-x { background: #94a3b8; }
.mc-folk-2 { background: #f59e0b; }

/* Info-rad: liga + tid + badges */
.mc-info {
  display: flex; align-items: center; gap: 5px; flex-wrap: wrap;
  padding: 3px 14px 5px; font-size: .7rem;
}
.mc-liga-tag {
  background: #e0e7ff; border-radius: 5px; padding: 1px 6px;
  font-weight: 700; font-size: .67rem; color: #3730a3; white-space: nowrap;
}
.mc-time { font-size: .67rem; color: #94a3b8; white-space: nowrap; font-weight: 600; }
.badge-drift { background: #fef3c7; color: #92400e; border-radius: 5px; padding: 1px 6px; font-size: .66rem; font-weight: 700; }
.badge-contrarian { background: #ede9fe; color: #5b21b6; border-radius: 5px; padding: 1px 6px; font-size: .66rem; font-weight: 700; }

/* Sportslig analys */
.mc-analysis {
  margin: 0 14px 6px; padding: 6px 10px; border-radius: 8px;
  font-size: .72rem; color: #334155; background: #f8fafc;
  border-left: 3px solid #cbd5e1; line-height: 1.45;
}
.mc-analysis.ana-value  { border-color: #34d399; background: #f0fdf4; color: #064e3b; }
.mc-analysis.ana-risk   { border-color: #fbbf24; background: #fffbeb; color: #78350f; }
.mc-analysis.ana-contra { border-color: #a78bfa; background: #f5f3ff; color: #4c1d95; }

/* Simulerings-panel */
.mc-sim-btn {
  font-size:.71rem; padding:3px 10px; border-radius:20px;
  border:1.5px solid #c7d2fe; background:#eef2ff; color:#4338ca;
  font-weight:700; cursor:pointer; transition:background .15s; white-space:nowrap;
}
.mc-sim-btn:hover { background:#e0e7ff; }
.mc-sim-btn.active { background:#4338ca; color:#fff; border-color:#4338ca; }
.mc-sim-panel {
  display:none; padding:8px 14px 10px; background:#f0f4ff;
  border-top:1px solid #e0e7ff;
}
.mc-sim-panel.open { display:block; }
.mc-sim-grid {
  display:grid; grid-template-columns:16px 1fr 44px 46px; gap:3px 6px; align-items:center;
}
.mc-sim-lbl { font-size:.75rem; font-weight:900; }
.mc-sim-bar-wrap { background:#dde3f0; border-radius:3px; height:7px; overflow:hidden; }
.mc-sim-bar { height:100%; border-radius:3px; }
.mc-sim-pct { font-size:.71rem; font-weight:700; color:#1e3a8a; text-align:right; }
.mc-sim-vg  { font-size:.68rem; font-weight:700; text-align:right; border-radius:4px; padding:1px 4px; }
.mc-sim-vg.pos { background:#d1fae5; color:#065f46; }
.mc-sim-vg.neg { background:#fee2e2; color:#991b1b; }
.mc-sim-vg.neu { background:#e2e8f0; color:#64748b; }
.mc-sim-rec { margin-top:6px; padding:5px 8px; border-radius:7px; font-size:.71rem; font-weight:700; }
.mc-sim-rec.good { background:#d1fae5; color:#064e3b; }
.mc-sim-rec.ok   { background:#dbeafe; color:#1e3a8a; }
.mc-sim-rec.warn { background:#fef3c7; color:#78350f; }

/* Kort-huvud */
.mc-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px 0; gap: 8px;
}
.match-num {
  background: #0d1e3d; color: #f59e0b; border-radius: 50%;
  width: 30px; height: 30px; display: flex; align-items: center;
  justify-content: center; font-weight: 900; font-size: .82rem; flex-shrink: 0;
}
.match-badges { display: flex; gap: 5px; flex-wrap: wrap; }
.badge { font-size: .7rem; border-radius: 20px; padding: 3px 10px; font-weight: 700; }
.badge-value { background: #d1fae5; color: #065f46; }
.badge-folk  { background: #fef3c7; color: #78350f; }

/* Lagnamn */
.mc-teams {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 16px 12px; flex-wrap: nowrap;
}
.mc-team { flex: 1; font-size: .95rem; font-weight: 800; line-height: 1.2; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.mc-team.home { text-align: left; color: #0f172a; }
.mc-team.away { text-align: right; color: #0f172a; }
.mc-vs {
  font-size: .72rem; font-weight: 900; color: #94a3b8;
  background: #f1f5f9; border-radius: 20px; padding: 4px 10px; flex-shrink: 0;
}

/* Tre stora v√§lj-knappar */
.mc-outcomes {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  border-top: 1.5px solid var(--border);
}
.mc-btn {
  position: relative; border: none; padding: 14px 6px 12px;
  cursor: pointer; display: flex; flex-direction: column;
  align-items: center; gap: 2px;
  transition: background .15s, transform .1s;
  background: #fafbfc;
}
.mc-btn:not(:last-child) { border-right: 1.5px solid var(--border); }
.mc-btn:hover { background: #f0f4f9; }
.mc-btn:active { transform: scale(.97); }

/* Valda knappar ‚Äì bl√•/lila/gr√∂n */
.mc-btn.sel-1 { background: #eff6ff; }
.mc-btn.sel-X { background: #f5f3ff; }
.mc-btn.sel-2 { background: #ecfdf5; }

/* Bock-indikator */
.mc-btn.sel-1::after,
.mc-btn.sel-X::after,
.mc-btn.sel-2::after {
  content: '‚úì';
  position: absolute; top: 6px; right: 8px;
  font-size: .72rem; font-weight: 900;
}
.mc-btn.sel-1::after { color: #1d4ed8; }
.mc-btn.sel-X::after { color: #6d28d9; }
.mc-btn.sel-2::after { color: #059669; }

.mc-sign {
  font-size: 1.45rem; font-weight: 900; line-height: 1;
  transition: color .15s;
}
.mc-btn-1 .mc-sign { color: #1d4ed8; }
.mc-btn-X .mc-sign { color: #6d28d9; }
.mc-btn-2 .mc-sign { color: #059669; }

.mc-lbl { font-size: .65rem; color: #64748b; font-weight: 600; margin-top: 1px; }
.mc-odds { font-size: .98rem; font-weight: 900; color: #0f172a; margin-top: 3px; }
.mc-folk { font-size: .65rem; color: #94a3b8; margin-top: 1px; }

/* Folk-stapel inuti knapp */
.mc-bar-wrap { width: 90%; height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 5px; overflow: hidden; }
.mc-bar-fill { height: 100%; border-radius: 2px; transition: width .5s; }
.mc-btn-1 .mc-bar-fill { background: #3b82f6; }
.mc-btn-X .mc-bar-fill { background: #7c3aed; }
.mc-btn-2 .mc-bar-fill { background: #10b981; }

/* V√§rde-tag */
.mc-value { font-size: .6rem; font-weight: 700; color: #059669; display: block; margin-top: 2px; }

/* Garderingshint */
.mc-footer {
  padding: 8px 16px; border-top: 1px solid #f1f5f9;
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 6px;
}
.mc-sel-badge {
  font-size: .75rem; font-weight: 700; color: #475569;
  background: #f1f5f9; border-radius: 20px; padding: 3px 10px;
}
.mc-hint { font-size: .7rem; color: #94a3b8; }

/* Sport-input */
.sport-toggle { background: #e0f2fe; border: 1.5px solid #7dd3fc; color: #0369a1; border-radius: 8px; padding: 4px 11px; font-size: .72rem; font-weight: 700; cursor: pointer; display: inline-block; }
.sport-toggle:hover { background: #bae6fd; }
.sport-toggle.active { background: #0ea5e9; color: #fff; border-color: #0284c7; }
.sport-input-row { display: none; background: #f0f9ff; border-radius: 10px; padding: 10px 14px; margin-top: 6px; border: 1.5px solid #bae6fd; flex-wrap: wrap; gap: 14px; align-items: center; }
.sport-input-row.open { display: flex; }
.sport-field { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.sport-field label { font-size: .7rem; color: #0369a1; font-weight: 800; letter-spacing: .5px; }
.sport-field input { width: 58px; padding: 5px 6px; border: 2px solid #7dd3fc; border-radius: 8px; font-size: .92rem; font-weight: 700; text-align: center; color: #0c4a6e; outline: none; }
.sport-field input:focus { border-color: #0ea5e9; }
.sport-hint { font-size: .73rem; color: #0369a1; flex: 1; min-width: 150px; line-height: 1.5; }

/* ‚ïê‚ïê‚ïê HISTORIK ‚ïê‚ïê‚ïê */
#history-panel { display: none; }
#history-panel h2 { font-size: 1.1rem; font-weight: 900; margin-bottom: 14px; color: var(--text); }
.hist-card { background: #fff; border-radius: 16px; padding: 14px 18px; margin-bottom: 10px; box-shadow: var(--sh); border: 1.5px solid var(--border); }
.hist-top  { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px; }
.hist-round { font-weight: 800; font-size: .95rem; color: var(--text); }
.hist-date  { font-size: .76rem; color: #94a3b8; }
.hist-chips { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px; }
.hist-meta  { font-size: .78rem; color: #94a3b8; }
.hist-del   { background: none; border: 1px solid #fca5a5; color: #dc2626; border-radius: 6px; padding: 3px 10px; font-size: .74rem; cursor: pointer; }
.hist-del:hover { background: #fff1f2; }
#hist-empty { text-align: center; padding: 40px 20px; color: #94a3b8; font-size: .95rem; }

/* ‚ïê‚ïê‚ïê MER (VERKTYG + R-SYSTEM) ‚ïê‚ïê‚ïê */
#mer-panel { display: none; padding-bottom: 30px; }
.tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media(max-width: 720px) { .tools-grid { grid-template-columns: 1fr; } }
.tools-section-title { font-size: .72rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin: 20px 0 10px; font-weight: 700; }

.marginal-card,.budget-card,.ev-card,.msys-card { background:#fff; border-radius:18px; padding:18px 22px; box-shadow:var(--sh); border:1.5px solid var(--border); }
.marginal-card h3,.budget-card h3,.ev-card h3,.msys-card h3 { font-size:.95rem; font-weight:800; color:var(--text); margin-bottom:3px; }
.marginal-card .card-sub,.budget-card .card-sub,.ev-card .card-sub,.msys-card .card-sub { font-size:.8rem; color:#94a3b8; margin-bottom:14px; line-height:1.4; }

.marg-row { display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
.marg-row:last-child { border-bottom:none; }
.marg-rank { background:#0d1e3d; color:#f59e0b; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-size:.72rem; font-weight:800; flex-shrink:0; }
.marg-match { font-size:.83rem; font-weight:600; flex:1; min-width:100px; }
.marg-sign { border-radius:6px; padding:2px 9px; font-size:.8rem; font-weight:800; flex-shrink:0; }
.marg-sign-1  { background:#dbeafe; color:#1e3a8a; }
.marg-sign-X  { background:#ede9fe; color:#4c1d95; }
.marg-sign-2  { background:#d1fae5; color:#065f46; }
.marg-delta { font-size:.78rem; color:#059669; font-weight:700; flex-shrink:0; }
.marg-cost  { font-size:.75rem; color:#94a3b8; flex-shrink:0; }
.marg-btn { background:#d1fae5; border:none; border-radius:7px; padding:4px 12px; font-size:.78rem; font-weight:700; color:#065f46; cursor:pointer; flex-shrink:0; }
.marg-btn:hover { background:#a7f3d0; }
#marg-empty { font-size:.85rem; color:#94a3b8; padding:10px 0; }
.btn-refresh-marg { background:#f1f5f9; border:1.5px solid var(--border); border-radius:8px; padding:6px 14px; font-size:.8rem; font-weight:700; color:#475569; cursor:pointer; margin-bottom:12px; }
.btn-refresh-marg:hover { background:#e2e8f0; }

#budget-input-row { display:flex; align-items:center; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
#budget-input-row label { font-size:.9rem; font-weight:600; color:#475569; }
#budget-val { width:80px; padding:6px 10px; border:2px solid #93c5fd; border-radius:8px; font-size:1rem; font-weight:700; text-align:center; color:var(--blue); outline:none; }
.btn-run-budget { background:var(--blue); color:#fff; border:none; border-radius:10px; padding:9px 18px; font-size:.9rem; font-weight:700; cursor:pointer; }
.btn-run-budget:hover { background:#1e40af; }
#budget-result { background:#f8fafc; border-radius:12px; padding:14px 16px; font-size:.85rem; line-height:1.7; display:none; border:1.5px solid var(--border); }
#budget-result.show { display:block; }
.budget-chips { display:flex; gap:4px; flex-wrap:wrap; margin:8px 0; }
.btn-apply-budget { background:#d1fae5; color:#065f46; border:none; border-radius:8px; padding:8px 18px; font-size:.88rem; font-weight:700; cursor:pointer; margin-top:6px; display:block; width:100%; }
.btn-apply-budget:hover { background:#a7f3d0; }

.ev-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:14px 0; }
@media(max-width:500px){ .ev-grid { grid-template-columns:1fr; } }
.ev-stat { background:#f8fafc; border-radius:12px; padding:12px 14px; border:1px solid var(--border); }
.ev-stat-label { font-size:.7rem; text-transform:uppercase; letter-spacing:.7px; color:#94a3b8; margin-bottom:4px; font-weight:600; }
.ev-stat-value { font-size:1.3rem; font-weight:900; color:var(--text); }
.ev-stat-sub { font-size:.72rem; color:#94a3b8; margin-top:2px; }
.ev-bar-wrap { margin:8px 0; }
.ev-bar-track { background:#e2e8f0; border-radius:6px; height:10px; overflow:hidden; }
.ev-bar-fill { height:100%; border-radius:6px; transition:width .5s; }
.ev-insight { font-size:.83rem; padding:10px 14px; border-radius:10px; line-height:1.6; margin-top:10px; }
.ev-insight.good { background:#ecfdf5; border-left:4px solid #34d399; color:#064e3b; }
.ev-insight.bad  { background:#fffbeb; border-left:4px solid #fbbf24; color:#78350f; }
.ev-insight.neut { background:#f8fafc; border-left:4px solid #94a3b8; color:#334155; }
.ev-input-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
.ev-input-row label { font-size:.88rem; font-weight:600; color:#475569; }
.ev-input-row input { width:90px; padding:5px 8px; border:2px solid #93c5fd; border-radius:8px; font-size:.95rem; font-weight:700; text-align:center; color:var(--blue); outline:none; }

.gar-card { background:#fff; border-radius:18px; padding:18px 22px; box-shadow:var(--sh); border:1.5px solid var(--border); grid-column:1/-1; }
.gar-card h3 { font-size:.95rem; font-weight:800; color:var(--text); margin-bottom:3px; }
.gar-card .card-sub { font-size:.8rem; color:#94a3b8; margin-bottom:14px; line-height:1.4; }
.gar-scenario { display:flex; gap:8px; align-items:center; padding:8px 10px; border-radius:10px; margin-bottom:6px; font-size:.83rem; flex-wrap:wrap; }
.gar-bar { flex:1; min-width:80px; background:#e2e8f0; border-radius:6px; height:9px; overflow:hidden; }
.gar-bar-fill { height:100%; border-radius:6px; transition:width .5s; }
.gar-pct { font-weight:700; font-size:.82rem; min-width:42px; text-align:right; }
.gar-label { min-width:90px; color:#475569; font-weight:600; }
.gar-count { font-size:.75rem; color:#94a3b8; min-width:60px; }

.corr-chip { display:inline-flex; align-items:center; gap:7px; background:#f8fafc; border:1.5px solid var(--border); border-radius:20px; padding:6px 14px; font-size:.82rem; font-weight:600; color:#475569; cursor:pointer; user-select:none; transition:background .15s; }
.corr-chip:hover { background:#e2e8f0; }
.corr-chip input { accent-color:var(--blue); width:15px; height:15px; cursor:pointer; }

.kelly-row { display:flex; align-items:center; gap:8px; padding:7px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
.kelly-row:last-child { border-bottom:none; }
.kelly-sign-badge { border-radius:6px; padding:2px 10px; font-size:.82rem; font-weight:800; flex-shrink:0; }
.kelly-edge-pos { color:#059669; font-weight:700; font-size:.82rem; }
.kelly-edge-neg { color:#dc2626; font-weight:700; font-size:.82rem; }
.kelly-bet  { background:#dbeafe; color:#1e40af; border-radius:8px; padding:3px 10px; font-size:.8rem; font-weight:700; margin-left:auto; }

.pop-score-ring { width:90px; height:90px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-direction:column; font-weight:900; flex-shrink:0; border:5px solid; }
.pop-match-row { display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
.pop-match-row:last-child { border-bottom:none; }
.pop-folk-bar { flex:1; min-width:60px; background:#e2e8f0; border-radius:4px; height:7px; overflow:hidden; }
.pop-folk-fill { height:100%; border-radius:4px; }
.pop-diff { font-size:.75rem; font-weight:700; min-width:55px; text-align:right; }

.ctx-match { background:#fff; border-radius:12px; padding:12px 16px; margin-bottom:8px; box-shadow:var(--sh); border:1.5px solid var(--border); display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.ctx-match-name { font-size:.85rem; font-weight:700; flex:1; min-width:140px; }
.ctx-flags { display:flex; gap:6px; flex-wrap:wrap; }
.ctx-flag { border:none; border-radius:20px; padding:4px 11px; font-size:.75rem; font-weight:700; cursor:pointer; transition:all .15s; opacity:.4; }
.ctx-flag.active { opacity:1; transform:scale(1.08); }
.ctx-cup   { background:#fef3c7; color:#78350f; }
.ctx-wet   { background:#dbeafe; color:#1e3a8a; }
.ctx-derby { background:#fee2e2; color:#7f1d1d; }
.ctx-degrad{ background:#d1fae5; color:#065f46; }
.ctx-tired { background:#ede9fe; color:#4c1d95; }

.msys-system { border-radius:14px; padding:14px 16px; margin-bottom:10px; }
.msys-A { background:#eff6ff; border-left:5px solid #3b82f6; }
.msys-B { background:#ecfdf5; border-left:5px solid #34d399; }
.msys-C { background:#f5f3ff; border-left:5px solid #a78bfa; }
.msys-title { font-size:.88rem; font-weight:800; margin-bottom:6px; }
.msys-chips { display:flex; gap:3px; flex-wrap:wrap; margin:6px 0; }
.msys-meta  { font-size:.75rem; color:#94a3b8; }
.btn-apply-sys { border:none; border-radius:8px; padding:5px 13px; font-size:.78rem; font-weight:700; cursor:pointer; margin-top:6px; }
.btn-apply-A { background:#dbeafe; color:#1e3a8a; }
.btn-apply-B { background:#d1fae5; color:#065f46; }
.btn-apply-C { background:#ede9fe; color:#4c1d95; }

/* Gamla klasser beh√•lls f√∂r kompatibilitet */
.odds-row,.sign-row,.sign-btn,.sign-btn-tip,.odds-item,.card-top,.match-name { display:none!important; }

/* ‚ïê‚ïê‚ïê V√ÑRDE-INDIKATOR ‚ïê‚ïê‚ïê */
.vi-wrap { border-top: 1px solid #f1f5f9; padding: 10px 16px 6px; }
.vi-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.vi-title { font-size: .67rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: .8px; }
.vi-conf { display: inline-flex; align-items: center; gap: 4px; border-radius: 16px; padding: 2px 9px; font-size: .7rem; font-weight: 800; }
.vi-conf.hi { background: #d1fae5; color: #065f46; }
.vi-conf.md { background: #fef3c7; color: #78350f; }
.vi-conf.lo { background: #f1f5f9; color: #64748b; }
.vi-row { display: flex; align-items: center; gap: 7px; margin-bottom: 4px; }
.vi-sign { font-size: .7rem; font-weight: 800; width: 12px; text-align: center; color: #64748b; }
.vi-track { flex: 1; height: 7px; background: #f1f5f9; border-radius: 4px; overflow: hidden; display: flex; }
.vi-base { background: #cbd5e1; height: 100%; }
.vi-gap-pos { background: #10b981; height: 100%; }
.vi-gap-neg { background: #f87171; height: 100%; }
.vi-pct { font-size: .67rem; font-weight: 700; width: 34px; text-align: right; }
.vi-pct.pos { color: #059669; }
.vi-pct.neg { color: #dc2626; }
.vi-pct.neu { color: #94a3b8; }

/* ‚ïê‚ïê‚ïê SYSTEM-TIPS I KUPONG ‚ïê‚ïê‚ïê */
#sys-tip-bar { background: linear-gradient(135deg,#ecfdf5,#f0fdf4); border: 1.5px solid #6ee7b7; border-radius: 14px; padding: 11px 16px; font-size: .82rem; display: none; margin-top: 0; color: #065f46; font-weight: 600; line-height: 1.6; }
#sys-tip-bar.show { display: block; }
#sys-tip-bar strong { color: #064e3b; }
#sys-tip-bar a { color: #059669; font-weight: 800; text-decoration: none; }
/* ‚ïê‚ïê‚ïê KUPONG-BETYG ‚ïê‚ïê‚ïê */
#kupong-grade-wrap { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
#kupong-grade-wrap h3 { margin:0; }
#kupong-grade { display:inline-flex; align-items:center; gap:5px; border-radius:20px; padding:4px 14px; font-size:.82rem; font-weight:900; transition:all .2s; }
#kupong-grade.g-Ap { background:#d1fae5; color:#065f46; }
#kupong-grade.g-A  { background:#dcfce7; color:#166534; }
#kupong-grade.g-Bp { background:#dbeafe; color:#1e40af; }
#kupong-grade.g-B  { background:#e0f2fe; color:#075985; }
#kupong-grade.g-C  { background:#fef3c7; color:#78350f; }
#kupong-grade.g-D  { background:#ffedd5; color:#7c2d12; }
#kupong-grade.g-F  { background:#fee2e2; color:#7f1d1d; }
/* ‚ïê‚ïê‚ïê TOPPTIPS-STRIP ‚ïê‚ïê‚ïê */
#topptips-strip { background:linear-gradient(135deg,#0d1e3d,#1e3a8a); border-radius:12px 12px 0 0; padding:12px 18px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
#ev-row-strip   { border-radius:0 !important; }
#elo-row-strip  { border-radius:0 !important; }
#combi-strip    { border-radius:0 !important; }
#smart-strip    { border-radius:0 !important; }
#poisson-strip  { border-radius:0 0 12px 12px !important; }
#topptips-strip .tt-label { font-size:.68rem; font-weight:800; color:#f59e0b; text-transform:uppercase; letter-spacing:.8px; white-space:nowrap; }
#topptips-strip .tt-chips { display:flex; gap:3px; flex-wrap:wrap; flex:1; }
#topptips-strip .tt-btn { background:#f59e0b; color:#0d1e3d; border:none; border-radius:20px; padding:5px 14px; font-size:.76rem; font-weight:800; cursor:pointer; white-space:nowrap; transition:background .15s; }
#topptips-strip .tt-btn:hover { background:#fbbf24; }
/* ‚ïê‚ïê‚ïê CHIP V√ÑRDE-DOT ‚ïê‚ïê‚ïê */
.rc-dot { display:inline-block; width:5px; height:5px; border-radius:50%; margin-left:3px; vertical-align:middle; position:relative; top:-1px; }
.rc-dot-p { background:#10b981; }
.rc-dot-n { background:#f87171; }

/* ‚ïê‚ïê‚ïê R-SYSTEM FLIK ‚ïê‚ïê‚ïê */
#system-panel { display:none; padding:20px 0 40px; }
.sys-header { max-width:720px; margin:0 auto 18px; padding:0 16px; }
.sys-header h2 { font-size:1.3rem; font-weight:900; color:var(--navy); margin-bottom:5px; }
.sys-header p  { color:var(--muted); font-size:.87rem; line-height:1.6; }
.sys-info-box  { max-width:720px; margin:0 auto 16px; padding:11px 16px; background:#eff6ff; border-radius:10px; border-left:4px solid #3b82f6; font-size:.88rem; color:#1e3a8a; font-weight:600; }
.sys-table-wrap { max-width:720px; margin:0 auto; padding:0 16px; overflow-x:auto; }
.sys-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.sys-table th { background:#0d1e3d; color:#fff; padding:9px 12px; text-align:left; font-weight:700; white-space:nowrap; }
.sys-table td { padding:8px 12px; border-bottom:1px solid #e2e8f0; white-space:nowrap; }
.sys-table tr:nth-child(even) td { background:#f8fafc; }
.sys-row-match td { background:#fffbeb!important; border-left:3px solid #f59e0b; font-weight:700; }
.sys-row-best  td { background:#ecfdf5!important; border-left:3px solid #059669; color:#065f46; font-weight:700; }
.sys-gar12 { color:#059669; font-weight:800; }
.sys-gar11 { color:#d97706; font-weight:700; }
.sys-rec   { max-width:720px; margin:18px auto 0; padding:0 16px; }
.sys-rec-box { background:linear-gradient(135deg,#1d4ed8,#6d28d9); border-radius:12px; padding:16px 20px; color:#fff; }
.sys-rec-box h3 { font-size:1rem; font-weight:900; margin-bottom:6px; }
.sys-rec-box p  { font-size:.85rem; opacity:.9; line-height:1.6; }

/* ‚îÄ‚îÄ RAD-EV KALKYLATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.rev-info { background:#f0fdf4; border-radius:10px; border-left:4px solid #22c55e;
  padding:11px 16px; font-size:.85rem; color:#14532d; font-weight:600; margin-bottom:14px; }
.rev-table-wrap { overflow-x:auto; margin-bottom:12px; }
.rev-table { width:100%; border-collapse:collapse; font-size:.8rem; }
.rev-table th { background:#0d1e3d; color:#fff; padding:8px 11px; font-weight:700; white-space:nowrap; text-align:left; }
.rev-table td { padding:7px 11px; border-bottom:1px solid #e2e8f0; white-space:nowrap; }
.rev-table tr.rev-top td { background:#fefce8; }
.rev-table tr:nth-child(even):not(.rev-top) td { background:#f8fafc; }
.rev-ev-bar { display:inline-block; height:7px; border-radius:4px;
  background:linear-gradient(90deg,#22c55e,#16a34a); vertical-align:middle; margin-left:6px; }
.rev-signs { font-family:monospace; letter-spacing:.08em; font-size:.84rem; font-weight:700; }
.rev-top-badge { display:inline-block; background:linear-gradient(135deg,#f59e0b,#f97316);
  color:#fff; font-size:.62rem; font-weight:800; padding:2px 6px; border-radius:4px;
  margin-left:5px; vertical-align:middle; }

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#start-panel { display:none; padding-bottom:40px; }
.dash-hero {
  background: linear-gradient(135deg,#0d1e3d 0%,#1d4ed8 100%);
  border-radius: 22px; padding: 28px 24px 22px;
  margin: 16px auto 0; max-width: 680px;
  color: #fff; box-shadow: 0 8px 32px rgba(13,30,61,.35);
  position: relative; overflow: hidden;
}
.dash-hero::before {
  content:''; position:absolute; inset:0;
  background:radial-gradient(ellipse at 80% 20%,rgba(245,158,11,.18) 0%,transparent 60%);
  pointer-events:none;
}
.dash-hero-label { font-size:.72rem; font-weight:800; letter-spacing:.12em; text-transform:uppercase; color:#93c5fd; margin-bottom:6px; }
.dash-hero-grade {
  font-size:3.4rem; font-weight:900; line-height:1;
  background:linear-gradient(135deg,#f59e0b,#fcd34d);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.dash-hero-sub { font-size:.88rem; color:#bfdbfe; margin-top:4px; margin-bottom:18px; }
.dash-hero-chips { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:20px; }
.dash-hero-chip {
  background:rgba(255,255,255,.13); border-radius:8px;
  padding:5px 10px; font-size:.8rem; font-weight:700; color:#e0f2fe;
  border:1.5px solid rgba(255,255,255,.18);
}
.dash-cta-row { display:flex; gap:10px; flex-wrap:wrap; }
.dash-cta {
  flex:1; min-width:120px; padding:11px 18px; border-radius:12px;
  border:none; cursor:pointer; font-size:.9rem; font-weight:800;
  transition:transform .12s,box-shadow .12s;
}
.dash-cta:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.25); }
.dash-cta-primary { background:linear-gradient(135deg,#f59e0b,#f97316); color:#fff; }
.dash-cta-secondary { background:rgba(255,255,255,.15); color:#e0f2fe; border:1.5px solid rgba(255,255,255,.25); }
.dash-cards { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:16px auto 0; max-width:680px; }
@media(max-width:480px){ .dash-cards{ grid-template-columns:1fr; } }
.dash-card { background:#fff; border-radius:18px; padding:18px 20px; box-shadow:0 4px 24px rgba(13,30,61,.09); }
.dash-card-label { font-size:.7rem; font-weight:800; letter-spacing:.1em; text-transform:uppercase; color:#93b8d8; margin-bottom:6px; }
.dash-card-value { font-size:1.6rem; font-weight:900; color:#0d1e3d; line-height:1.1; }
.dash-card-sub { font-size:.8rem; color:#64748b; margin-top:4px; }
.dash-card-rec { margin-top:10px; padding:8px 12px; background:#f0f9ff; border-radius:10px; font-size:.82rem; color:#0c4a6e; font-weight:600; }

/* ‚îÄ‚îÄ COMPACT MATCH CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.match-card { padding: 0 !important; margin-bottom: 10px !important; }
.mc-head { padding: 8px 14px 0 !important; margin-bottom: 0 !important; }
.mc-teams { font-size: .9rem !important; margin: 4px 14px 0 !important; padding-bottom: 4px !important; }
.mc-footer { margin-top: 0 !important; padding: 6px 14px !important; font-size: .77rem !important; }
.mc-btn { padding: 10px 4px 8px !important; gap: 2px !important; }
.mc-sign { font-size: 1.3rem !important; }
.mc-odds { font-size: .92rem !important; margin-top: 1px !important; }
.mc-bar-wrap { width: 85% !important; height: 4px !important; margin-top: 3px !important; }

/* ‚îÄ‚îÄ FOLK-ROW: folk% och vg-chip p√• samma rad ‚îÄ‚îÄ */
.mc-folk-row { display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 2px; }
.mc-folk { font-size: .65rem !important; color: #64748b; }

/* ‚îÄ‚îÄ VG-CHIP: kompakt v√§rdechip ‚îÄ‚îÄ */
.vg-chip { display: inline-block; font-size: .6rem; font-weight: 800; border-radius: 6px; padding: 1px 4px; line-height: 1.4; }
.vg-chip-pos { background: #d1fae5; color: #065f46; }
.vg-chip-neg { background: #fee2e2; color: #991b1b; }
.vg-chip-neu { background: #f1f5f9; color: #64748b; }

/* ‚îÄ‚îÄ POISSON-PANEL PER MATCHKORT ‚îÄ‚îÄ */
.mc-poisson-btn {
  font-size:.71rem; padding:3px 10px; border-radius:20px;
  border:1.5px solid #99f6e4; background:#f0fdfa; color:#134e4a;
  font-weight:700; cursor:pointer; transition:background .15s; white-space:nowrap;
}
.mc-poisson-btn:hover { background:#ccfbf1; }
.mc-poisson-btn.active { background:#0f766e; color:#ccfbf1; border-color:#0f766e; }
.mc-poisson-panel {
  display:none; padding:10px 16px 12px; background:#f0fdfa;
  border-top:1px solid #99f6e4;
}
.mc-poisson-panel.open { display:block; }
.poisson-inputs { display:grid; grid-template-columns:1fr 1fr; gap:6px 12px; margin-bottom:8px; }
.poisson-field { display:flex; flex-direction:column; gap:2px; }
.poisson-field label { font-size:.65rem; font-weight:700; color:#134e4a; text-transform:uppercase; letter-spacing:.5px; }
.poisson-inp {
  width:100%; padding:5px 8px; border:1.5px solid #99f6e4; border-radius:8px;
  font-size:.9rem; font-weight:700; text-align:center; color:#134e4a; outline:none;
  background:#fff;
}
.poisson-inp:focus { border-color:#0f766e; }
.poisson-calc-btn {
  width:100%; padding:6px; border:none; border-radius:8px;
  background:#0f766e; color:#ccfbf1; font-weight:800; font-size:.78rem;
  cursor:pointer; transition:background .15s; margin-bottom:8px;
}
.poisson-calc-btn:hover { background:#134e4a; }
.poisson-result {
  display:grid; grid-template-columns:1fr 1fr 1fr;
  gap:4px; text-align:center;
}
.poisson-res-cell {
  background:#134e4a; border-radius:10px; padding:8px 4px;
  color:#ccfbf1;
}
.poisson-res-sign { font-size:.72rem; font-weight:700; opacity:.7; }
.poisson-res-pct  { font-size:1.25rem; font-weight:900; color:#fff; line-height:1.1; }
.poisson-res-lambda { font-size:.62rem; opacity:.55; margin-top:1px; }
.poisson-res-vg { font-size:.68rem; font-weight:700; border-radius:5px; padding:1px 5px; margin-top:3px; display:inline-block; }
.poisson-vg-pos { background:#d1fae5; color:#065f46; }
.poisson-vg-neg { background:#fee2e2; color:#991b1b; }
.poisson-vg-neu { background:#e2e8f0; color:#64748b; }

/* ‚îÄ‚îÄ MOTIVATION-BADGE ‚îÄ‚îÄ */
.motiv-badge {
  font-size:.66rem; padding:2px 7px; border-radius:5px;
  background:#fef3c7; color:#92400e; font-weight:700; cursor:pointer;
  border:1.5px solid #fde68a; transition:all .15s; white-space:nowrap;
}
.motiv-badge.active { background:#dc2626; color:#fff; border-color:#dc2626; }

/* ‚îÄ‚îÄ ODDS API / SHARP PANEL ‚îÄ‚îÄ */
.sharp-badge { font-size:.66rem; padding:2px 7px; border-radius:5px; background:#ede9fe; color:#5b21b6; font-weight:700; }
.sharp-bar { height:5px; border-radius:3px; background:#8b5cf6; }

/* ‚îÄ‚îÄ POISSON-STRIP (7:e raden) ‚îÄ‚îÄ */
#poisson-strip {
  background: linear-gradient(135deg,#134e4a,#0f766e);
  padding: 12px 18px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  border-radius: 0 0 12px 12px !important;
}

/* ‚îÄ‚îÄ SPELANALYS-SEKTION ‚îÄ‚îÄ */
.mc-analyse {
  display: flex; align-items: flex-start; justify-content: space-between;
  gap: 8px; padding: 7px 14px 6px;
  border-top: 1px solid #f1f5f9;
  background: #fafbff;
}
.mc-analyse-body {
  font-size: .75rem; color: #374151; line-height: 1.45; flex: 1;
}
.mc-analyse-conf {
  font-size: .68rem; font-weight: 800; border-radius: 8px;
  padding: 2px 7px; white-space: nowrap; align-self: center;
}
.sa-conf-hi { background: #d1fae5; color: #065f46; }
.sa-conf-md { background: #fef3c7; color: #78350f; }
.sa-conf-lo { background: #f1f5f9; color: #64748b; }

</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê PASTE-MODAL ‚ïê‚ïê‚ïê -->
<div id="paste-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:16px; padding:28px 28px 24px; max-width:680px; width:95%; box-shadow:0 24px 60px rgba(0,0,0,.25); font-family:inherit;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <h2 style="margin:0; font-size:1.2rem; color:#1d4ed8;">üìã Importera ny omg√•ngsdata</h2>
      <button onclick="hidePasteModal()" style="border:none; background:none; font-size:1.4rem; cursor:pointer; color:#6b7280; line-height:1;">‚úï</button>
    </div>
    <p style="margin:0 0 12px; font-size:.9rem; color:#374151; line-height:1.5;">
      G√• till <strong>spela.svenskaspel.se/stryktipset</strong> ‚Üí markera all text p√• sidan (Ctrl+A) ‚Üí klistra in h√§r (Ctrl+V).<br>
      Alternativt: klistra in bara matchdata med lagnamn, folkprocent och aktuella odds.
    </p>
    <textarea id="paste-textarea" placeholder="Klistra in text fr√•n Svenska Spel h√§r‚Ä¶" style="width:100%; height:240px; border:1.5px solid #93c5fd; border-radius:10px; padding:12px; font-size:.85rem; font-family:monospace; resize:vertical; color:#1e3a5f; outline:none; box-sizing:border-box;"></textarea>
    <div id="paste-status" style="min-height:20px; font-size:.85rem; color:#dc2626; margin:8px 0 0;"></div>
    <div style="display:flex; gap:10px; margin-top:14px; justify-content:flex-end;">
      <button onclick="hidePasteModal()" style="padding:9px 20px; border-radius:8px; border:1.5px solid #d1d5db; background:#f9fafb; color:#374151; font-weight:600; cursor:pointer;">Avbryt</button>
      <button onclick="importPastedData()" style="padding:9px 22px; border-radius:8px; border:none; background:#2563eb; color:#fff; font-weight:700; font-size:.95rem; cursor:pointer;">üöÄ Importera</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header>
  <h1>üèÜ Stryktipset</h1>
  <p id="round-label">Laddar omg√•ng‚Ä¶</p>
  <button id="paste-btn" onclick="showPasteModal()" title="Klistra in ny omg√•ngsdata">üìã Ny omg√•ng ‚Äî klistra in data</button>
  <button id="fetch-btn" onclick="fetchLatestData()" title="H√§mta senaste odds och folkprocent automatiskt fr√•n Svenska Spel">üîÑ H√§mta senaste odds</button>
  <select id="round-picker" onchange="fetchDrawByPicker(this)" title="V√§lj omg√•ng att ladda" style="display:none;">
    <option value="">üìÖ Byt omg√•ng ‚Üí</option>
  </select>
</header>

<!-- ‚ïê‚ïê‚ïê INL√ÑMNINGS-TIMER ‚ïê‚ïê‚ïê -->
<div id="submit-timer">
  <div>
    <div class="timer-left">St√§nger om</div>
    <div class="timer-clock" id="timer-clock">‚Äì:‚Äì‚Äì:‚Äì‚Äì</div>
  </div>
  <div style="text-align:center;">
    <div class="timer-msg" id="timer-msg">‚è≥ R√§knar ut st√§ngningstid‚Ä¶</div>
    <div class="timer-hint" id="timer-hint">L√§mna in senast 60 min innan st√§ngning</div>
  </div>
  <div style="text-align:right;">
    <div class="timer-left">St√§nger</div>
    <div style="font-size:.95rem;font-weight:700;" id="timer-closes">‚Äì</div>
  </div>
</div>

<!-- API-BANNER -->
<div id="api-banner" style="display:none;padding:9px 18px;font-size:.82rem;font-weight:600;text-align:center;border-bottom:1px solid rgba(0,0,0,.08);line-height:1.5;"></div>

<!-- ‚ïê‚ïê‚ïê FLIKAR ‚ïê‚ïê‚ïê -->
<div id="tabs">
  <button class="tab-btn active" onclick="showTab('start')">üèÜ Start</button>
  <button class="tab-btn"        onclick="showTab('kupong')">üìã Kupong</button>
  <button class="tab-btn"        onclick="showTab('historik')">üìÖ Historik</button>
  <button class="tab-btn"        onclick="showTab('mer')">‚öôÔ∏è Mer</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     START-FLIKEN (DASHBOARD)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="start-panel">
  <div class="wrap">

    <!-- HERO: Betyg + B√§sta rad -->
    <div class="dash-hero">
      <div class="dash-hero-label">üèÜ Din kupong just nu</div>
      <div class="dash-hero-grade" id="dash-grade">‚Äì</div>
      <div class="dash-hero-sub" id="dash-grade-sub">V√§lj tecken i Kupong-fliken f√∂r att se ditt betyg</div>
      <div class="dash-hero-chips" id="dash-tt-chips"></div>
      <div class="dash-cta-row">
        <button class="dash-cta dash-cta-primary" onclick="applyValueBets();showTab('kupong')">üíé Anv√§nd b√§sta rad ‚Üí</button>
        <button class="dash-cta dash-cta-secondary" onclick="showTab('kupong')">üìã √ñppna kupong ‚Üí</button>
      </div>
    </div>

    <!-- INFO-KORT -->
    <div class="dash-cards">

      <div class="dash-card">
        <div class="dash-card-label">üé≤ R-system</div>
        <div class="dash-card-value" id="dash-sys-name">‚Äì</div>
        <div class="dash-card-sub" id="dash-sys-detail">V√§lj tecken f√∂r rekommendation</div>
        <div class="dash-card-rec" id="dash-sys-rec-text"></div>
      </div>

      <div class="dash-card">
        <div class="dash-card-label">üìä V√§rde-score</div>
        <div class="dash-card-value" id="dash-value-score">‚Äì</div>
        <div class="dash-card-sub">Medel v√§rdeindikator per match</div>
      </div>

      <div class="dash-card">
        <div class="dash-card-label">üõ°Ô∏è Garderingar</div>
        <div class="dash-card-value" id="dash-gard-cnt">‚Äì</div>
        <div class="dash-card-sub">matcher med dubbla/trippla tecken</div>
      </div>

      <div class="dash-card">
        <div class="dash-card-label">‚è±Ô∏è St√§nger om</div>
        <div class="dash-card-value" id="dash-timer-val">‚Äì</div>
        <div class="dash-card-sub" id="dash-round-label">‚Äì</div>
      </div>

    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     KUPONG-FLIKEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="kupong-panel">

  <!-- Steg-guide (kollapsbar) -->
  <div id="guide-wrap">
    <div id="guide">
      <div class="step"><div class="step-num">1</div> Klicka 1, X eller 2 per match</div>
      <div class="step-arrow">‚Üí</div>
      <div class="step"><div class="step-num">2</div> Klicka flera om du √§r os√§ker</div>
      <div class="step-arrow">‚Üí</div>
      <div class="step"><div class="step-num">3</div> Din vinstchans visas direkt!</div>
      <button id="guide-hide-btn" onclick="toggleGuide()" title="D√∂lj guide" style="margin-left:auto;background:none;border:1px solid #cbd5e1;border-radius:20px;padding:3px 10px;font-size:.75rem;color:#94a3b8;cursor:pointer;white-space:nowrap;">‚úï D√∂lj</button>
    </div>
    <div class="wrap" style="margin-top:12px;">
      <div id="legend">
        <strong>Vad √§r 1, X och 2?</strong>&nbsp;
        <span class="lg"><span class="lbadge lb1">1</span> Hemmalaget vinner</span>
        <span class="lg"><span class="lbadge lbX">X</span> Oavgjort</span>
        <span class="lg"><span class="lbadge lb2">2</span> Bortalaget vinner</span>
        &nbsp;¬∑&nbsp;
        Klicka <strong>flera knappar</strong> p√• en match om du √§r os√§ker ‚Äî det kallas gardering och ger b√§ttre chans men kostar mer.
        <strong>‚¨Ü Understreckat</strong> betyder att f√§rre √§n v√§ntat tror p√• det tecknet ‚Äî om du har r√§tt vinner du mer!
      </div>
    </div>
  </div>
  <div id="guide-show-bar" style="display:none;padding:6px 20px;background:#f8fafc;border-bottom:1px solid var(--border);">
    <button onclick="toggleGuide()" style="background:none;border:none;font-size:.8rem;color:#94a3b8;cursor:pointer;padding:0;">‚ÑπÔ∏è Visa guide ‚Üí</button>
  </div>

  <!-- Knappar -->
  <div class="wrap" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
    <button class="big-btn btn-auto"    onclick="applyRecommended()">ü§ñ Datorn v√§ljer √•t mig</button>
    <button class="big-btn btn-value"   onclick="applyValueBets()">üíé V√§lj v√§rde-tecken</button>
    <button class="big-btn btn-explain" onclick="toggleExplain()">üí¨ F√∂rklara valen</button>
    <button class="big-btn btn-share"   onclick="shareRow()">üìã Kopiera min rad</button>
    <button class="big-btn btn-reset"   onclick="applyRecommended()">‚Ü∫ B√∂rja om</button>
  </div>

  <!-- F√∂rklara-panel -->
  <div class="wrap" style="margin-top:10px;">
    <div id="explain-panel"></div>
  </div>

  <!-- Pris -->
  <div class="wrap" style="margin-top:10px;">
    <div id="price-row">
      <label for="price-input">üí∂ Pris per rad:</label>
      <input type="number" id="price-input" value="1" min="0.5" step="0.5" oninput="recalc()"> kr
      <span style="font-size:.82rem;color:#90a4ae;">(1 kr = minsta insats)</span>
    </div>
  </div>

  <!-- R-system tips -->
  <div class="wrap" style="margin-top:10px;">
    <div id="sys-tip-bar"></div>
  </div>

  <!-- Chans-meter -->
  <div class="wrap" style="margin-top:12px;">
    <div class="chance-card">
      <div class="cstat">
        <div class="cstat-emoji" id="meter-emoji">üéØ</div>
        <div class="cstat-label">Chans att vinna</div>
        <div class="cstat-value" id="stat-p13">‚Äì</div>
        <div class="cstat-sub">13 r√§tt (jackpot!)</div>
      </div>
      <div class="cstat">
        <div class="cstat-emoji">üìä</div>
        <div class="cstat-label">N√§stan-vinst</div>
        <div class="cstat-value" id="stat-p12">‚Äì</div>
        <div class="cstat-sub">minst 12 r√§tt</div>
      </div>
      <div class="cstat">
        <div class="cstat-emoji">üìã</div>
        <div class="cstat-label">Rader / Kostnad</div>
        <div class="cstat-value" id="stat-rows">‚Äì</div>
        <div class="cstat-sub" id="stat-cost">‚Äì</div>
      </div>
      <div class="cstat">
        <div class="cstat-emoji">üé∞</div>
        <div class="cstat-label">R√§tt i snitt</div>
        <div class="cstat-value" id="stat-e">‚Äì</div>
        <div class="cstat-sub">av 13 m√∂jliga</div>
      </div>
      <div class="chance-bar-wrap">
        <div class="chance-bar-track">
          <div class="chance-bar-fill" id="chance-bar" style="width:0%;background:#e0e0e0;"></div>
        </div>
        <div class="chance-bar-label" id="chance-bar-text">V√§lj dina tecken ovan f√∂r att se din chans</div>
      </div>
    </div>
  </div>

  <!-- Spara till historik -->
  <div class="wrap" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <button class="big-btn btn-auto" style="flex:0 0 auto;padding:10px 20px;" onclick="saveToHistory()">
      üíæ Spara denna rad till historik
    </button>
    <span style="font-size:.82rem;color:#90a4ae;">Spara veckor du spelt f√∂r att j√§mf√∂ra system</span>
  </div>

  <!-- Din rad -->
  <div class="wrap" style="margin-top:10px;">
    <div class="rad-box">
      <div id="kupong-grade-wrap">
        <h3>‚úèÔ∏è Din rad just nu</h3>
        <span id="kupong-grade" class="g-B">üíé B</span>
      </div>
      <div id="rad-chips"></div>
      <div id="profile-row">
        <div class="pitem"><div class="pcnt" id="cnt-1" style="color:#60a5fa">‚Äì</div><div class="plbl">üè† Hemma (1)</div></div>
        <div class="pitem"><div class="pcnt" id="cnt-X" style="color:#818cf8">‚Äì</div><div class="plbl">ü§ù Kryss (X)</div></div>
        <div class="pitem"><div class="pcnt" id="cnt-2" style="color:#4ade80">‚Äì</div><div class="plbl">‚úàÔ∏è Borta (2)</div></div>
        <div class="pitem"><div class="pcnt" id="cnt-gard" style="color:#facc15">‚Äì</div><div class="plbl">üõ°Ô∏è Garderade</div></div>
      </div>
      <div id="prof-warn"></div>
    </div>
  </div>

  <!-- Rad-f√∂rslag: B√§sta rad / EV-rad / Kombisystem -->
  <div class="wrap" style="margin-top:12px;display:flex;flex-direction:column;gap:4px;">

    <div id="topptips-strip">
      <div style="display:flex;flex-direction:column;gap:1px;white-space:nowrap;">
        <span class="tt-label">üèÜ B√§sta rad</span>
        <span style="font-size:.62rem;color:rgba(255,255,255,.5);font-weight:600;">Ytterberg: v√§ljer understreckat tecken per match</span>
      </div>
      <div class="tt-chips" id="tt-chips"></div>
      <button class="tt-btn" onclick="applyValueBets()">Anv√§nd ‚Üí</button>
    </div>

    <div id="ev-row-strip" style="background:linear-gradient(135deg,#064e3b,#065f46);padding:12px 18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div style="display:flex;flex-direction:column;gap:1px;white-space:nowrap;">
        <span style="font-size:.68rem;font-weight:800;color:#6ee7b7;text-transform:uppercase;letter-spacing:.8px;">üìä EV-rad</span>
        <span style="font-size:.62rem;color:rgba(255,255,255,.5);font-weight:600;">Bennis-Hanna: v√§ljer mest contrarian tecken vs folket</span>
      </div>
      <div id="ev-row-chips" style="display:flex;gap:3px;flex-wrap:wrap;flex:1;"></div>
      <button style="background:#6ee7b7;color:#064e3b;border:none;border-radius:20px;padding:5px 14px;font-size:.76rem;font-weight:800;cursor:pointer;white-space:nowrap;" onclick="applyBestEVRow()">Anv√§nd ‚Üí</button>
    </div>

    <div id="combi-strip" style="background:linear-gradient(135deg,#4c1d95,#6d28d9);padding:12px 18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div style="display:flex;flex-direction:column;gap:1px;white-space:nowrap;">
        <span style="font-size:.68rem;font-weight:800;color:#ddd6fe;text-transform:uppercase;letter-spacing:.8px;">üîÄ Kombisystem</span>
        <span style="font-size:.62rem;color:rgba(255,255,255,.5);font-weight:600;">Ytterberg + Smart Poisson: √∂verens = spika ¬∑ oeniga = gardera</span>
      </div>
      <div id="combi-chips" style="display:flex;gap:3px;flex-wrap:wrap;flex:1;"></div>
      <span id="combi-rows-label" style="font-size:.72rem;color:#ddd6fe;font-weight:700;white-space:nowrap;"></span>
      <button style="background:#ddd6fe;color:#4c1d95;border:none;border-radius:20px;padding:5px 14px;font-size:.76rem;font-weight:800;cursor:pointer;white-space:nowrap;" onclick="applyCombiSystem()">Anv√§nd ‚Üí</button>
    </div>

    <div id="poisson-strip">
      <div style="display:flex;flex-direction:column;gap:1px;white-space:nowrap;">
        <span style="font-size:.68rem;font-weight:800;color:#99f6e4;text-transform:uppercase;letter-spacing:.8px;">üé≤ Smart Poisson</span>
        <span style="font-size:.62rem;color:rgba(255,255,255,.5);font-weight:600;">Poisson + value-filter: v√§ljer bort √∂verstreckat, lyfter fram understreckat kryss</span>
      </div>
      <div id="poisson-chips" style="display:flex;gap:3px;flex-wrap:wrap;flex:1;"></div>
      <span id="poisson-coverage" style="font-size:.72rem;color:#99f6e4;font-weight:700;white-space:nowrap;"></span>
      <button style="background:#99f6e4;color:#134e4a;border:none;border-radius:20px;padding:5px 14px;font-size:.76rem;font-weight:800;cursor:pointer;white-space:nowrap;" onclick="applyPoissonRow()">Anv√§nd ‚Üí</button>
    </div>

    <div id="gard-strip" style="background:linear-gradient(135deg,#7c2d12,#c2410c);padding:12px 18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;border-radius:0 0 12px 12px !important;">
      <div style="display:flex;flex-direction:column;gap:1px;white-space:nowrap;">
        <span style="font-size:.68rem;font-weight:800;color:#fed7aa;text-transform:uppercase;letter-spacing:.8px;">üõ°Ô∏è Garderingssystem</span>
        <span style="font-size:.62rem;color:rgba(255,255,255,.5);font-weight:600;">4 helgar ¬∑ 4 halvgar ¬∑ 5 spikar ‚Äî sorterat p√• Poisson-os√§kerhet</span>
      </div>
      <div id="gard-chips" style="display:flex;gap:3px;flex-wrap:wrap;flex:1;"></div>
      <span id="gard-rows-label" style="font-size:.72rem;color:#fed7aa;font-weight:700;white-space:nowrap;"></span>
      <button style="background:#fed7aa;color:#7c2d12;border:none;border-radius:20px;padding:5px 14px;font-size:.76rem;font-weight:800;cursor:pointer;white-space:nowrap;" onclick="applyGarderingRow()">Anv√§nd ‚Üí</button>
    </div>

  </div>

  <!-- Sorterings- och kopiera-bar -->
  <div class="wrap" id="sort-copy-bar" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:10px;margin-bottom:2px;">
    <span style="font-size:.72rem;font-weight:700;color:#64748b;white-space:nowrap;">Sortera:</span>
    <button class="sort-btn sort-btn-active" id="sort-round" onclick="setSortMode('round')">üìÖ Omg√•ng</button>
    <button class="sort-btn" id="sort-value" onclick="setSortMode('value')">‚≠ê V√§rde</button>
    <button class="sort-btn" id="sort-uncertain" onclick="setSortMode('uncertain')">üé≤ Os√§kra</button>
    <button class="sort-btn" id="sort-time" onclick="setSortMode('time')">üïê Matchstart</button>
    <div style="flex:1"></div>
    <span id="elo-status" style="font-size:.7rem;font-weight:700;color:#94a3b8;white-space:nowrap;"></span>
    <button class="copy-kupong-btn" onclick="showQuickFdo()" title="H√§mta formdata f√∂r Poisson automatiskt" style="background:rgba(5,150,105,.12);border-color:rgba(5,150,105,.5);color:#065f46;">‚öΩ Poisson-data</button>
    <button class="copy-kupong-btn" onclick="copyKupong()" title="Kopiera kupong som text">üìã Kopiera kupong</button>
  </div>

  <!-- Quick-panel f√∂r football-data.org direkt i Kupong-fliken -->
  <div class="wrap" id="quick-fdo-panel" style="display:none;margin-top:6px;">
    <div style="background:#f0fdf4;border:1.5px solid #6ee7b7;border-radius:14px;padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <span style="font-size:.8rem;font-weight:700;color:#065f46;white-space:nowrap;">‚öΩ H√§mta formdata automatiskt:</span>
      <input type="text" id="fdo-api-key-quick" placeholder="API-token fr√•n football-data.org"
        style="flex:1;min-width:180px;padding:5px 10px;border:1.5px solid #6ee7b7;border-radius:8px;font-size:.82rem;font-weight:600;outline:none;color:#065f46;" />
      <button onclick="fetchFootballDataQuick()" style="padding:5px 14px;background:#059669;color:#fff;border:none;border-radius:8px;font-weight:800;font-size:.8rem;cursor:pointer;white-space:nowrap;">K√∂r ‚Üí</button>
      <button onclick="document.getElementById('quick-fdo-panel').style.display='none'" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:1rem;padding:0 4px;">‚úï</button>
    </div>
    <div id="quick-fdo-progress" style="margin:6px 0 0;font-size:.77rem;font-weight:700;color:#059669;display:none;"></div>
  </div>

  <!-- Matcher -->
  <div class="wrap" style="margin-top:6px;" id="match-list"></div>

</div><!-- /kupong-panel -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HISTORIK-FLIKEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="history-panel" class="wrap" style="padding-top:20px;padding-bottom:24px;">
  <h2>üìÖ Sparade omg√•ngar</h2>
  <div id="hist-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MER-FLIKEN (Verktyg + R-system)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mer-panel" class="wrap" style="padding-top:20px;">

  <div style="margin-bottom:4px;">
    <h2 style="font-size:1.05rem;font-weight:800;color:#1e3a8a;margin:0 0 4px;">‚öôÔ∏è Avancerade verktyg</h2>
    <p style="font-size:.82rem;color:#94a3b8;margin:0;">Optimera din kupong, analysera v√§rde och justera f√∂r kontext.</p>
  </div>

  <!-- JACKPOT-EV + GARANTISYSTEM -->
  <div class="tools-section-title" style="margin-top:20px;">üé∞ Jackpot-analys</div>
  <div class="tools-grid" style="grid-template-columns:1fr 1fr;">

    <!-- JACKPOT-EV -->
    <div class="ev-card">
      <h3>üíé Jackpot-EV-kalkylator</h3>
      <div class="card-sub">Maximera inte P(13 r√§tt) ‚Äî maximera <strong>f√∂rv√§ntad utdelning</strong>. En kontr√§r rad som delar med f√§rre vinnare kan ge dubbel EV.</div>
      <div class="ev-input-row">
        <label>üèÜ Jackpot:</label>
        <input type="number" id="ev-jackpot" value="10000000" step="1000000"> kr
      </div>
      <div class="ev-input-row">
        <label>üéüÔ∏è Kuponger:</label>
        <input type="number" id="ev-coupons" value="350000" step="50000">
        <span style="font-size:.75rem;color:#93b8d8;">(typiskt 300-500k)</span>
      </div>
      <button class="btn-run-budget" onclick="runJackpotEV()">üíé Ber√§kna EV</button>
      <div id="ev-result" style="display:none;margin-top:14px;"></div>
    </div>

    <!-- GARANTISYSTEM / SCENARIO-ANALYS -->
    <div class="ev-card">
      <h3>üõ°Ô∏è Scenario-analys</h3>
      <div class="card-sub">Monte Carlo: om X matcher g√•r fel, hur m√•nga r√§tt har du kvar? Visar f√∂rdelning av utfall f√∂r ditt system.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <label style="font-size:.88rem;font-weight:600;color:#3b6ea8;">üé≤ Simuleringar:</label>
        <select id="sim-count" style="padding:5px 10px;border:2px solid #93c5fd;border-radius:8px;font-size:.88rem;font-weight:700;color:#1d4ed8;outline:none;">
          <option value="5000">5 000 (snabb)</option>
          <option value="25000" selected>25 000 (normal)</option>
          <option value="100000">100 000 (exakt)</option>
        </select>
      </div>
      <button class="btn-run-budget" onclick="runScenario()">üé≤ K√∂r simulering</button>
      <div id="scenario-result" style="display:none;margin-top:14px;"></div>
    </div>

  </div>

  <!-- OPTIMERARE: SA + MULTI-SYSTEM -->
  <div class="tools-section-title" style="margin-top:24px;">üî• Optimerare</div>
  <div class="tools-grid">

    <!-- SIMULATED ANNEALING -->
    <div class="budget-card">
      <h3>üî• SA-optimerare</h3>
      <div class="card-sub">Hittar b√§ttre system √§n enkel s√∂kning ‚Äî 100 000 iterationer med exponentiell kylning och omstarter. B√§st vid h√∂g budget.</div>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
        <label style="font-size:.88rem;font-weight:600;color:#3b6ea8;">ü™ô Budget:</label>
        <input type="number" id="sa-budget" value="200" min="1" step="50" style="width:80px;padding:5px 8px;border:2px solid #93c5fd;border-radius:8px;font-size:.95rem;font-weight:700;text-align:center;color:#1d4ed8;outline:none;"> kr
      </div>
      <button class="btn-run-budget" onclick="runSimAnneal()" id="sa-btn">üî• K√∂r SA-s√∂kning</button>
      <div id="sa-progress" style="font-size:.8rem;color:#93b8d8;margin-top:6px;"></div>
      <div id="sa-result" style="display:none;margin-top:12px;background:#f0f9ff;border-radius:12px;padding:12px 14px;border:1.5px solid #bae6fd;font-size:.85rem;"></div>
    </div>

    <!-- MULTI-SYSTEM SPLITTER -->
    <div class="budget-card">
      <h3>üéØ Multi-system</h3>
      <div class="card-sub">Delar budgeten i tre system: A = s√§ker jackpott-j√§gare, B = kontr√§r value-bet, C = maximalt understreckat.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px;">
        <label style="font-size:.88rem;font-weight:600;color:#3b6ea8;">üí∞ Budget:</label>
        <input type="number" id="msys-budget" value="500" min="10" step="50"
               style="width:80px;padding:5px 8px;border:2px solid #93c5fd;border-radius:8px;font-size:.95rem;font-weight:700;text-align:center;color:#1d4ed8;outline:none;"> kr
        <button class="btn-run-budget" onclick="runMultiSystem()">üéØ Generera</button>
      </div>
      <div id="msys-result" style="display:none;"></div>
    </div>

  </div>

  <!-- KONTEXTJUSTERINGAR: KORRELATION + MATCHFLAGGOR -->
  <div class="tools-section-title" style="margin-top:24px;">üîó Kontextjusteringar</div>
  <div class="tools-grid">

    <!-- KORRELATIONSMODELL -->
    <div class="budget-card">
      <h3>üîó Korrelationsmodell</h3>
      <div class="card-sub">Matchers utfall √§r inte helt oberoende. V√§lj kopplingsfaktorer ‚Äî sannolikheterna justeras automatiskt.</div>
      <div id="corr-options" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
        <label class="corr-chip"><input type="checkbox" id="corr-defensive" onchange="applyCorrelation()"> üò¥ Tr√∂g ligaomg√•ng (fler kryss +3%)</label>
        <label class="corr-chip"><input type="checkbox" id="corr-cup" onchange="applyCorrelation()"> üèÜ Cup-match (rotation, undviks bortasegrade)</label>
        <label class="corr-chip"><input type="checkbox" id="corr-endseason" onchange="applyCorrelation()"> üèÅ Slutspurt (hemmalag desperat, +5% etta)</label>
        <label class="corr-chip"><input type="checkbox" id="corr-topteam" onchange="applyCorrelation()"> ‚≠ê Stortopplag borta (bortasegrade underskattas)</label>
      </div>
      <div id="corr-status" style="font-size:.82rem;color:#16a34a;font-weight:600;"></div>
    </div>

    <!-- KONTEXTUELLA MATCHFLAGGOR -->
    <div class="budget-card">
      <h3>üèüÔ∏è Matchflaggor</h3>
      <div class="card-sub">Markera faktorer odds-modellen inte vet om ‚Äî <strong>Cup</strong> ¬∑ <strong>V√§der</strong> ¬∑ <strong>Derby</strong> ¬∑ <strong>Degradering</strong> ¬∑ <strong>Tr√∂tt</strong>. Justerar sannolikheter direkt.</div>
      <div id="ctx-match-list" style="margin-top:6px;"></div>
      <button class="btn-run-budget" style="margin-top:10px;" onclick="applyContextFlags()">‚úÖ Applicera flaggor</button>
      <div id="ctx-status" style="font-size:.82rem;color:#16a34a;font-weight:600;margin-top:8px;"></div>
    </div>

  </div>

  <!-- KUPONG-ANALYS: POPULATIONS-DETEKTOR + xP INFO -->
  <div class="tools-section-title" style="margin-top:24px;">üë• Kupong-analys</div>
  <div class="tools-grid">

    <!-- POPULATIONS-DETEKTOR -->
    <div class="budget-card">
      <h3>üë• Hur kontr√§r √§r du?</h3>
      <div class="card-sub">H√∂g kontr√§r-score = du avviker fr√•n folkmassan = b√§ttre f√∂rv√§ntad utdelning per vinstkrona om du har r√§tt.</div>
      <button class="btn-run-budget" onclick="runPopDetector()">üë• Analysera min kupong</button>
      <div id="pop-result" style="display:none;margin-top:14px;"></div>
    </div>

    <!-- xP SPORT INFO -->
    <div class="budget-card">
      <h3>üìê Egna sannolikheter</h3>
      <div class="card-sub">Klicka <em>"üìê Egna odds"</em> p√• varje matchkort i Min kupong och ange dina egna procent f√∂r 1, X och 2. Appen blandar din bed√∂mning med odds-kalkylen.</div>
      <div style="font-size:.82rem;color:#0c4a6e;background:#f0f9ff;border-radius:10px;padding:10px 12px;border:1px solid #bae6fd;">
        Du beh√∂ver <strong>inte</strong> fylla i alla matcher ‚Äî l√§mna tomt = anv√§nd bara odds-data.
      </div>
    </div>

  </div>

  <!-- R-SYSTEM -->
  <div class="tools-section-title" style="margin-top:28px;">üé≤ R-system</div>
  <div style="background:#fff;border-radius:18px;padding:18px 22px;box-shadow:0 2px 16px rgba(59,130,246,.10);">
    <p style="font-size:.87rem;color:#64748b;margin-bottom:14px;">Reducerade system med gardering till l√§gre kostnad. V√§lj baserat p√• dina helgarderingar och halvgarderingar.</p>
    <div class="sys-info-box" id="sys-info-box"></div>
    <div class="sys-table-wrap">
      <table class="sys-table">
        <thead>
          <tr><th>System</th><th>Helgard.</th><th>Halvgard.</th><th>Rader (kr)</th><th>Garanti</th></tr>
        </thead>
        <tbody id="sys-tbody"></tbody>
      </table>
    </div>
    <div class="sys-rec"><div class="sys-rec-box" id="sys-rec-box"></div></div>
  </div>

  <!-- U-SYSTEM -->
  <div class="tools-section-title" style="margin-top:28px;">üîµ U-system</div>
  <div style="background:#fff;border-radius:18px;padding:18px 22px;box-shadow:0 2px 16px rgba(59,130,246,.10);">
    <p style="font-size:.87rem;color:#64748b;margin-bottom:10px;">
      Reducerade system med <strong>utg√•ngsrad</strong> ‚Äî precis som R-system men du markerar √§ven
      ett <em>U-tecken</em> (ditt favoritutfall) f√∂r varje garderad match. Systemet optimeras kring ditt val och garantin g√§ller om dina U-tecken st√§mmer.
    </p>
    <div style="background:#eff6ff;border-radius:10px;padding:9px 14px;font-size:.82rem;color:#1e40af;margin-bottom:14px;border:1px solid #bfdbfe;">
      üí° P√• kupongen: garderade matcher f√•r en extra kolumn ‚Äî kryssa i det tecken du <em>tror mest p√•</em> som U-tecken.
    </div>
    <div class="sys-info-box" id="usys-info-box"></div>
    <div class="sys-table-wrap">
      <table class="sys-table">
        <thead>
          <tr><th>System</th><th>Helgard.</th><th>Halvgard.</th><th>Rader (kr)</th><th>Garanti*</th></tr>
        </thead>
        <tbody id="usys-tbody"></tbody>
      </table>
    </div>
    <p style="font-size:.75rem;color:#94a3b8;margin:8px 0 4px;">* Garanti g√§ller om alla dina U-tecken √§r r√§tt. Utel√§mnas U-tecken g√§ller l√§gre garanti.</p>
    <div class="sys-rec"><div class="sys-rec-box" id="usys-rec-box"></div></div>
  </div>

  <!-- FORMDATA: FOOTBALL-DATA.ORG AUTO-H√ÑMTNING -->
  <div class="tools-section-title" style="margin-top:24px;">‚öΩ Auto-formdata (football-data.org)</div>
  <div style="background:#fff;border-radius:18px;padding:18px 22px;box-shadow:0 2px 16px rgba(16,185,129,.10);margin-bottom:16px;border:1.5px solid #d1fae5;">
    <p style="font-size:.87rem;color:#64748b;margin-bottom:14px;">
      H√§mtar automatiskt senaste 5 matchernas m√•l f√∂r varje lag och fyller i Poisson-kalkylatorn.
      Gratis nyckel p√• <strong>football-data.org</strong> ‚Äî registrera dig ‚Üí Dashboard ‚Üí kopiera token.
    </p>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
      <input type="text" id="fdo-api-key" placeholder="Din API-token fr√•n football-data.org"
        style="flex:1;min-width:220px;padding:7px 12px;border:2px solid #6ee7b7;border-radius:10px;font-size:.85rem;font-weight:600;outline:none;color:#065f46;" />
      <button onclick="fetchFootballData()" style="padding:7px 18px;background:#059669;color:#fff;border:none;border-radius:10px;font-weight:800;font-size:.85rem;cursor:pointer;white-space:nowrap;">‚öΩ H√§mta formdata</button>
    </div>
    <div id="fdo-progress-wrap" style="display:none;margin-bottom:10px;">
      <div style="background:#e2e8f0;border-radius:8px;height:8px;overflow:hidden;margin-bottom:6px;">
        <div id="fdo-progress-bar" style="height:100%;background:linear-gradient(90deg,#059669,#34d399);border-radius:8px;width:0%;transition:width .3s;"></div>
      </div>
      <div id="fdo-progress-text" style="font-size:.78rem;color:#059669;font-weight:700;"></div>
    </div>
    <div id="fdo-status" style="font-size:.82rem;color:#94a3b8;font-weight:600;"></div>
    <div id="fdo-result" style="display:none;margin-top:10px;font-size:.82rem;color:#064e3b;background:#f0fdf4;border-radius:10px;padding:10px 14px;line-height:1.7;"></div>
  </div>

  <!-- MARKNADSODDS (SHARP / THE ODDS API) -->
  <div class="tools-section-title" style="margin-top:24px;">üåê Marknadsodds (sharp odds)</div>
  <div style="background:#fff;border-radius:18px;padding:18px 22px;box-shadow:0 2px 16px rgba(59,130,246,.10);margin-bottom:16px;">
    <p style="font-size:.87rem;color:#64748b;margin-bottom:14px;">
      H√§mtar odds fr√•n Pinnacle och andra "sharp" bokf√∂retag via <strong>The Odds API</strong> (gratis nyckel p√• <em>the-odds-api.com</em>, 500 req/m√•nad).
      Implicierade sannolikheter fr√•n Pinnacle betraktas som marknadens b√§sta prediktion.
    </p>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
      <input type="text" id="odds-api-key" placeholder="Din API-nyckel (gratis p√• the-odds-api.com)"
        style="flex:1;min-width:220px;padding:7px 12px;border:2px solid #93c5fd;border-radius:10px;font-size:.85rem;font-weight:600;outline:none;color:#1e3a8a;" />
      <button onclick="fetchSharpOdds()" style="padding:7px 18px;background:#1d4ed8;color:#fff;border:none;border-radius:10px;font-weight:800;font-size:.85rem;cursor:pointer;white-space:nowrap;">üåê H√§mta odds</button>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
      <label style="display:flex;align-items:center;gap:6px;font-size:.85rem;font-weight:600;cursor:pointer;">
        <input type="checkbox" id="xboost-toggle" onchange="applyXBoost()" style="width:16px;height:16px;">
        üîµ Kryss-boost: justera upp X-sannolikheten med +15% (forskning visar folk underskattar X systematiskt)
      </label>
    </div>
    <div id="sharp-status" style="font-size:.82rem;color:#94a3b8;font-weight:600;"></div>
    <div id="sharp-result" style="display:none;margin-top:12px;"></div>
  </div>

  <!-- RAD-EV KALKYLATOR -->
  <div class="tools-section-title" style="margin-top:28px;">üìä Rad-EV-kalkylator</div>
  <div style="background:#fff;border-radius:18px;padding:18px 22px;box-shadow:0 2px 16px rgba(59,130,246,.10);">
    <p style="font-size:.87rem;color:#64748b;margin-bottom:14px;">
      Rankar dina rader efter <em>relativ f√∂rv√§ntad avkastning</em>. Baserat p√• Bennis &amp; Hanna (2024):
      rader med h√∂g odds-sannolikhet men l√•g folkandel tenderar ge b√§ttre utdelning i den pari-mutuella poolen.
    </p>
    <div class="rev-info" id="rev-info">V√§lj tecken i Kupong-fliken f√∂r att se rad-rankingen.</div>
    <div class="rev-table-wrap">
      <table class="rev-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Tecken (rad)</th>
            <th>Rel. EV ‚Üì</th>
            <th>Odds-prob (x‚ÇÅ)</th>
            <th>Folkandel (x‚ÇÉ)</th>
          </tr>
        </thead>
        <tbody id="rev-tbody"></tbody>
      </table>
    </div>
    <p style="font-size:.74rem;color:#94a3b8;margin-top:6px;">
      Rel. EV = x‚ÇÅ/x‚ÇÉ ¬∑ x‚ÇÅ = produkt av odds-sannolikheterna ¬∑ x‚ÇÉ = produkt av folkstrecken ¬∑ K√§lla: Bennis &amp; Hanna (2024).
      Visas max 25 b√§sta rader. System med &gt;10 000 rader kan inte ber√§knas.
    </p>
  </div>

</div>

<!-- Toast -->
<div id="share-toast">‚úÖ Raden kopierades till urklipp!</div>

<footer>
  Allt r√§knas ut direkt i webbl√§saren ‚Äì ingen inloggning, inga annonser ¬∑
  Ny omg√•ng h√§mtas automatiskt n√§r den √∂ppnar (normalt onsdag‚Äìtorsdag)
</footer>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KUPONGDATA  (uppdateras automatiskt av stryktips_hamta.py)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _lastFetchedSlug = null;
var _lastFetchedDrawNumber = null;
var XBOOST_ACTIVE = false;
let ROUND = "Omg√•ng 1";
let MATCHES = [
  { home:"Man City",      away:"Newcastle",    o1:1.50, ox:5.00, o2:6.25,  f1:74, fx:15, f2:11 },
  { home:"West Ham",      away:"Bournemouth",  o1:2.43, ox:3.70, o2:2.90,  f1:42, fx:27, f2:31 },
  { home:"Aston Villa",   away:"Leeds",        o1:1.87, ox:3.75, o2:4.50,  f1:59, fx:23, f2:18 },
  { home:"Chelsea",       away:"Burnley",      o1:1.23, ox:7.00, o2:14.00, f1:79, fx:12, f2:9  },
  { home:"Brentford",     away:"Brighton",     o1:2.04, ox:3.80, o2:3.70,  f1:52, fx:27, f2:21 },
  { home:"Middlesbrough", away:"Oxford",       o1:1.41, ox:4.80, o2:8.00,  f1:75, fx:14, f2:11 },
  { home:"Millwall",      away:"Portsmouth",   o1:1.89, ox:3.55, o2:4.35,  f1:61, fx:23, f2:16 },
  { home:"Norwich",       away:"Birmingham",   o1:2.60, ox:3.45, o2:2.70,  f1:45, fx:26, f2:29 },
  { home:"Southampton",   away:"Charlton",     o1:1.58, ox:4.10, o2:5.80,  f1:68, fx:19, f2:13 },
  { home:"Watford",       away:"Derby",        o1:2.14, ox:3.40, o2:3.55,  f1:45, fx:27, f2:28 },
  { home:"Wrexham",       away:"Ipswich",      o1:3.45, ox:3.40, o2:2.17,  f1:33, fx:29, f2:38 },
  { home:"Mansfield",     away:"Lincoln",      o1:3.25, ox:3.45, o2:2.15,  f1:25, fx:28, f2:47 },
  { home:"Wimbledon",     away:"Bradford",     o1:2.95, ox:3.25, o2:2.38,  f1:33, fx:31, f2:36 },
];

// Formdata fr√•n stryktips_form_model.py (null = ej tillg√§nglig)
const FORM_DATA = null;  // ers√§tts automatiskt av Python-skriptet

// Pinnacle-odds fr√•n stryktips_pinnacle.py (null = ej tillg√§nglig)
const PINNACLE_DATA = null;  // ers√§tts automatiskt av Python-skriptet

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  EMPIRISKA SANNOLIKHETSMODELLER ‚Äî Ytterberg Thornlund (2012)
//  Input: Svenska Folkets procenttal (folk%)
//  Output: kalibrerad sannolikhet baserad p√• 300 omg√•ngars faktiska utfall
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function empiricalP1(x) {
  // Ettor: tre segment + gr√§nsv√§rden
  if (x <= 7)  return 0;        // aldrig etta
  if (x <= 65) return 0.00652 * x + 0.12783;
  if (x <= 73) return 0.55179;  // gr√•zon
  if (x <= 88) return 0.01765 * x - 0.73694;
  return 1.0;                   // alltid etta (‚â•89%)
}
function empiricalPX(x) {
  // Kryss: andragradsfunktion
  if (x <= 6)  return 0;        // aldrig kryss
  if (x <= 36) return -0.00027049 * x * x + 0.01766 * x + 0.01521;
  return empiricalPX(36);       // plat√• ‚Äî s√§llsynt >36%
}
function empiricalP2(x) {
  // Tv√•or: tv√• segment + gr√§nsv√§rden
  if (x <= 6)  return 0;        // aldrig tv√•a
  if (x <= 62) return 0.0060 * x + 0.11837;
  if (x <= 80) return 0.02100 * x - 0.82737;
  return 1.0;                   // alltid tv√•a (‚â•81%)
}

// Ber√§kna xP (fr√•n odds) + empiriska sannolikheter + v√§rde-gap
function computeMatchDerived(arr) {
  arr.forEach(m => {
    // Odds-baserade sannolikheter (normaliserade, anv√§nds i kombinations-kalkyl)
    const s = 1/m.o1 + 1/m.ox + 1/m.o2;
    m.xp1 = +(1/m.o1/s*100).toFixed(1);
    m.xpx = +(1/m.ox/s*100).toFixed(1);
    m.xp2 = +(1/m.o2/s*100).toFixed(1);

    // Folk% ‚Äî s√§kerst√§ll att vi har heltal
    const f1 = m.folk1 || m.f1 || 33;
    const fx = m.folkX || m.fx || 33;
    const f2 = m.folk2 || m.f2 || 34;

    // Empiriska sannolikheter fr√•n Ytterberg-modellerna (0‚Äì1)
    const ep1 = Math.max(0, Math.min(1, empiricalP1(f1)));
    const epx = Math.max(0, Math.min(1, empiricalPX(fx)));
    const ep2 = Math.max(0, Math.min(1, empiricalP2(f2)));
    m.ep1 = +(ep1*100).toFixed(1);   // i % f√∂r enkel j√§mf√∂relse
    m.epx = +(epx*100).toFixed(1);
    m.ep2 = +(ep2*100).toFixed(1);

    // V√§rde-gap: empirisk sannolikhet minus folkets andel
    // Positivt = folket undertippar detta tecken = v√§rde
    m.vg1 = +(m.ep1 - f1).toFixed(1);
    m.vgx = +(m.epx - fx).toFixed(1);
    m.vg2 = +(m.ep2 - f2).toFixed(1);
    m.bestVg = Math.max(m.vg1, m.vgx, m.vg2);

    // EV mot fasta odds (Ytterberg kap 6): ep √ó odds
    // EV > 1.0 = positivt f√∂rv√§ntningsv√§rde
    m.ev1 = +(ep1 * m.o1).toFixed(3);
    m.evx = +(epx * m.ox).toFixed(3);
    m.ev2 = +(ep2 * m.o2).toFixed(3);

    // Gardering/spika-regler direkt fr√•n uppsatsen
    m.spike1  = f1 >= 89;            // alltid spika etta
    m.spike2  = f2 >= 81;            // alltid spika tv√•a
    m.never1  = f1 <= 7;             // tippa aldrig etta
    m.neverX  = fx <= 6;             // tippa aldrig kryss
    m.never2  = f2 <= 6;             // tippa aldrig tv√•a
    m.garDen1 = f1 >= 65 && f1 <= 83; // gardera etta (√∂verstreckat)
    m.garDen2 = f2 >= 55 && f2 <= 66; // gardera tv√•a (√∂verstreckat)
    m.valueX  = fx <= 30 && !m.neverX; // kryss systematiskt underv√§rdat av folket

    // antiFolk: folket streckar h√•rt men odds/modell s√§ger annorlunda
    m.antiFolk = (f1>70 && m.ep1<55) || (fx>55 && m.epx<40) || (f2>70 && m.ep2<55);

    // Kryss-boost: om aktiv, boosta X-sannolikheten med 15% (forskning: folk underskattar X systematiskt)
    if (typeof XBOOST_ACTIVE !== 'undefined' && XBOOST_ACTIVE) {
      const rawEpx = Math.max(0, Math.min(1, empiricalPX(fx)));
      const boostedEpx = Math.min(0.99, rawEpx * 1.15);
      m.epx = +(boostedEpx * 100).toFixed(1);
      m.vgx = +(m.epx - fx).toFixed(1);
    }

    // Motivationsjustering: om laget spelar utan motivation ‚Üí nedvikta deras vinstchans
    if (m.lowMotivation) {
      if (f1 > 55) {
        m.ep1 = +(m.ep1 * 0.80).toFixed(1);
        m.epx = +(Math.min(99, m.epx * 1.10)).toFixed(1);
        m.ep2 = +(Math.min(99, m.ep2 * 1.10)).toFixed(1);
      } else if (f2 > 55) {
        m.ep2 = +(m.ep2 * 0.80).toFixed(1);
        m.epx = +(Math.min(99, m.epx * 1.10)).toFixed(1);
        m.ep1 = +(Math.min(99, m.ep1 * 1.10)).toFixed(1);
      }
      m.vg1 = +(m.ep1 - f1).toFixed(1);
      m.vgx = +(m.epx - fx).toFixed(1);
      m.vg2 = +(m.ep2 - f2).toFixed(1);
      m.bestVg = Math.max(m.vg1, m.vgx, m.vg2);
    }

    // Auto-Poisson fr√•n odds: estimera Œª automatiskt om FDO-data saknas
    if (!m.poissonFromFDO) {
      const s = 1/m.o1 + 1/m.ox + 1/m.o2;
      const p1n = (1/m.o1) / s;
      const pxn = (1/m.ox) / s;
      const p2n = (1/m.o2) / s;
      const est = estimateLambdasFromOdds(p1n, pxn, p2n);
      const res = computePoissonProbs(est.lh, est.la);
      m.poissonP1 = res.p1;
      m.poissonPX = res.px;
      m.poissonP2 = res.p2;
      m.poissonLH = res.lambdaH;
      m.poissonLA = res.lambdaA;
      m.hasPoissonData = true;
      m.poissonFromOdds = true;
    }

    // ‚îÄ‚îÄ Draw-modell ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Flaggar matcher med h√∂g kryss-potential baserat p√• tre faktorer:
    // 1. N√§ra Œª-v√§rden (j√§mna lag), 2. L√•g f√∂rv√§ntat m√•lsumma, 3. X understreckat
    if (m.hasPoissonData) {
      const lH = m.poissonLH || 1.5;
      const lA = m.poissonLA || 1.0;
      const fx2 = m.folkX || m.fx || 33;
      const lambdaDiff  = Math.abs(lH - lA);          // l√•gt = j√§mnt
      const totalLambda = lH + lA;                     // l√•gt = defensivt
      const xGap        = m.poissonPX - fx2;           // positivt = understreckat X

      // Po√§ng: max 3 po√§ng
      let drawScore = 0;
      if (lambdaDiff  < 0.4) drawScore++;              // Œª n√§ra varandra
      if (totalLambda < 2.6) drawScore++;              // l√•gt m√•lantal v√§ntat
      if (xGap        > 3)   drawScore++;              // X understreckat vs Poisson

      m.drawScore   = drawScore;
      m.isDrawLikely = drawScore >= 2 && m.poissonPX >= 22;
    } else {
      m.drawScore    = 0;
      m.isDrawLikely = false;
    }
  });
}
computeMatchDerived(MATCHES);

// Val per match
let selections = MATCHES.map(m => defaultSel(m));

// Egna sport-sannolikheter (null = ej angivet)
let xpSport = MATCHES.map(() => ({ s1:null, sx:null, s2:null }));

// ‚îÄ‚îÄ ELO-DATA (club-elo.com) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ INBYGGD ELO-TABELL (club-elo.com, uppdaterad feb 2026) ‚îÄ‚îÄ
const ELO_TABLE = {
  // England ‚Äì Premier League
  'manchester city':2065,'man city':2065,'arsenal':1970,'liverpool':1990,
  'chelsea':1880,'manchester united':1875,'man united':1875,'man utd':1875,
  'tottenham':1835,'tottenham hotspur':1835,'spurs':1835,
  'newcastle':1810,'newcastle united':1810,'aston villa':1800,
  'west ham':1755,'west ham united':1755,'brighton':1720,'brentford':1700,
  'fulham':1685,'wolves':1672,'wolverhampton':1672,'crystal palace':1655,
  'bournemouth':1660,'everton':1640,'nottingham forest':1660,'forest':1660,
  'ipswich':1575,'leicester':1605,'southampton':1575,
  // England ‚Äì Championship & l√§gre
  'leeds':1632,'leeds united':1632,'burnley':1618,'sheffield united':1595,
  'norwich':1590,'norwich city':1590,'middlesbrough':1572,'derby':1530,
  'derby county':1530,'millwall':1558,'portsmouth':1532,'oxford':1508,
  'oxford united':1508,'charlton':1498,'charlton athletic':1498,
  'bradford':1488,'bradford city':1488,'wrexham':1512,'mansfield':1478,
  'mansfield town':1478,'lincoln':1488,'lincoln city':1488,
  'wimbledon':1492,'afc wimbledon':1492,'birmingham':1522,'birmingham city':1522,
  'watford':1558,'stoke':1548,'stoke city':1548,'hull':1545,'hull city':1545,
  'coventry':1542,'coventry city':1542,'swansea':1540,'swansea city':1540,
  'bristol city':1528,'preston':1525,'sunderland':1555,
  // Spanien
  'real madrid':2082,'barcelona':1985,'atletico madrid':1935,'atletico':1935,
  'athletic bilbao':1792,'athletic club':1792,'villarreal':1762,'sevilla':1758,
  'real sociedad':1758,'betis':1732,'real betis':1732,'osasuna':1678,
  'girona':1722,'getafe':1638,'valencia':1692,'mallorca':1645,
  'celta vigo':1648,'celta':1648,'las palmas':1582,'alaves':1568,
  // Tyskland
  'bayern munich':2022,'bayern':2022,'fc bayern':2022,
  'bayer leverkusen':1895,'leverkusen':1895,
  'borussia dortmund':1882,'dortmund':1882,'bvb':1882,
  'rb leipzig':1875,'leipzig':1875,'eintracht frankfurt':1792,'frankfurt':1792,
  'stuttgart':1782,'wolfsburg':1742,'freiburg':1742,'werder bremen':1702,
  'borussia monchengladbach':1732,'gladbach':1732,'mainz':1682,'union berlin':1722,
  'augsburg':1638,'hoffenheim':1658,'heidenheim':1618,'bochum':1568,
  'hamburger sv':1638,'hamburg':1638,'hsv':1638,
  // Italien
  'inter milan':1992,'inter':1992,'internazionale':1992,
  'juventus':1935,'ac milan':1922,'milan':1922,
  'napoli':1902,'atalanta':1882,'roma':1852,'as roma':1852,
  'lazio':1822,'fiorentina':1782,'torino':1722,'bologna':1782,
  'udinese':1682,'cagliari':1652,'monza':1638,'lecce':1598,'genoa':1612,
  'como':1568,'venezia':1548,'hellas verona':1555,'verona':1555,
  'parma':1542,'empoli':1548,
  // Frankrike
  'paris saint-germain':2012,'psg':2012,'paris sg':2012,
  'monaco':1812,'lille':1802,'marseille':1812,'lyon':1782,'nice':1752,
  'rennes':1742,'lens':1762,'reims':1672,'strasbourg':1648,'brest':1702,
  'montpellier':1608,'nantes':1618,'toulouse':1598,'le havre':1558,
  // Nederl√§nderna
  'ajax':1822,'psv':1872,'psv eindhoven':1872,'feyenoord':1832,
  'az':1752,'az alkmaar':1752,'utrecht':1702,'twente':1712,'fc twente':1712,
  'vitesse':1638,'sparta rotterdam':1648,
  // Portugal
  'benfica':1882,'sl benfica':1882,'porto':1872,'fc porto':1872,
  'sporting cp':1842,'sporting':1842,'braga':1722,'sc braga':1722,
  // Sverige ‚Äì Allsvenskan
  'malmo':1622,'malm√∂ ff':1622,'malm√∂':1622,'malmo ff':1622,
  'ifk goteborg':1572,'ifk g√∂teborg':1572,'g√∂teborg':1572,'goteborg':1572,
  'djurgarden':1582,'djurg√•rdens if':1582,'djurgardensif':1582,
  'aik':1582,'hammarby':1562,'hammarby if':1562,
  'ifk norrkoping':1542,'ifk norrk√∂ping':1542,'norrk√∂ping':1542,
  'hacken':1552,'bk h√§cken':1552,'h√§cken':1552,'kalmar':1512,
  'kalmar ff':1512,'sirius':1502,'ik sirius':1502,'elfsborg':1542,
  'if elfsborg':1542,'mjallby':1482,'mj√§llby':1482,
  'varberg':1478,'varbergs bois':1478,'hif':1498,'helsingborgs':1498,
  'osters':1462,'√∂sters':1462,'gais':1468,
  // Skottland
  'celtic':1752,'rangers':1722,'hearts':1618,'hibernian':1598,
  // Belgien
  'club brugge':1772,'anderlecht':1702,'gent':1682,
  // Turkiet
  'galatasaray':1782,'fenerbahce':1762,'fenerbah√ße':1762,
  'besiktas':1722,'be≈üikta≈ü':1722,'trabzonspor':1682,
  // Ryssland/CIS
  'zenit':1742,'cska moscow':1712,'spartak moscow':1702,'lokomotiv moscow':1682,
  'dynamo kyiv':1702,'shakhtar donetsk':1772,
  // √ñsterrike
  'red bull salzburg':1752,'salzburg':1752,'rapid wien':1658,
  // Tjeckien
  'slavia prague':1702,'sparta prague':1702,
  // Serbien
  'red star belgrade':1732,'crvena zvezda':1732,'partizan':1672,
  // √ñvrigt
  'olympiacos':1682,'panathinaikos':1652,'paok':1672,'aek athens':1642,
  'maccabi tel aviv':1622,'dinamo zagreb':1682,'fcsb':1612,
  'qarabag':1648,'slovan bratislava':1618,'ferencvaros':1642,
};
let ELO_LOADED = true;

function fetchEloRatings() {
  // Tabellen √§r redan inbyggd ‚Äî ingen fetch beh√∂vs
  const eloEl = document.getElementById('elo-status');
  if (eloEl) eloEl.textContent = '‚öΩ Elo: ' + Object.keys(ELO_TABLE).length + ' lag inbyggda';
  return Promise.resolve(true);
}

function normalizeTeamName(name) {
  return (name || '').toLowerCase()
    .replace(/\b(fc|if|bk|ifk|sc|ac|fk|hk|sk|ff|bf|as|sl|ik|vfl|fsv|rb|tsv|sv|1\.|vfb)\b/g, '')
    .replace(/[^a-z√•√§√∂√∏0-9 ]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function findElo(name) {
  const norm = normalizeTeamName(name);
  if (!norm) return null;
  // 1. Exakt tr√§ff
  if (ELO_TABLE[norm] !== undefined) return ELO_TABLE[norm];
  // 2. Originalnamn i lowercase
  const lower = (name || '').toLowerCase().trim();
  if (ELO_TABLE[lower] !== undefined) return ELO_TABLE[lower];
  // 3. Tabell-nyckel inneh√•ller normnamnet (eller vice versa)
  for (const key of Object.keys(ELO_TABLE)) {
    if (key.includes(norm) || norm.includes(key)) return ELO_TABLE[key];
  }
  // 4. Ord√∂verlappstr√§ff (minst ett ord med 4+ tecken)
  const words = norm.split(' ').filter(w => w.length >= 4);
  let best = null, bestScore = 0;
  for (const key of Object.keys(ELO_TABLE)) {
    const score = words.filter(w => key.includes(w)).length;
    if (score > bestScore) { bestScore = score; best = key; }
  }
  if (bestScore >= 1) return ELO_TABLE[best];
  return null;
}

function computeEloProbs(eloHome, eloAway, homeAdv = 65) {
  const diff    = eloHome - eloAway + homeAdv;
  const p1win   = 1 / (1 + Math.pow(10, -diff / 400));
  // Oavgjort-sannolikhet minskar med |Elo-differens|
  const absDiff = Math.abs(eloHome - eloAway);
  const px      = Math.max(0.10, 0.29 - 0.0003 * absDiff);
  return {
    p1: +((p1win * (1 - px)) * 100).toFixed(1),
    px: +(px * 100).toFixed(1),
    p2: +(((1 - p1win) * (1 - px)) * 100).toFixed(1)
  };
}

function applyEloToMatches() {
  MATCHES.forEach(m => {
    const eH = findElo(m.home);
    const eA = findElo(m.away);
    m.eloHome = eH;
    m.eloAway = eA;
    if (eH !== null && eA !== null) {
      const ep    = computeEloProbs(eH, eA);
      m.eloP1     = ep.p1;
      m.eloPX     = ep.px;
      m.eloP2     = ep.p2;
      // Blandat: 40% Elo + 60% Ytterberg (empirisk kalibrering)
      m.blendP1   = +(0.4 * ep.p1  + 0.6 * (m.ep1 || 33)).toFixed(1);
      m.blendPX   = +(0.4 * ep.px  + 0.6 * (m.epx || 33)).toFixed(1);
      m.blendP2   = +(0.4 * ep.p2  + 0.6 * (m.ep2 || 34)).toFixed(1);
      m.blendVg1  = +(m.blendP1 - (m.folk1 || m.f1 || 33)).toFixed(1);
      m.blendVgX  = +(m.blendPX - (m.folkX || m.fx || 33)).toFixed(1);
      m.blendVg2  = +(m.blendP2 - (m.folk2 || m.f2 || 34)).toFixed(1);
      m.hasElo    = true;
    } else {
      m.hasElo = false;
    }
  });
}

function defaultSel(m) {
  // Bygg upp till√•tna tecken enligt Ytterberg-reglerna
  const allowed = [];
  if (!m.never1) allowed.push('1');
  if (!m.neverX) allowed.push('X');
  if (!m.never2) allowed.push('2');
  if (allowed.length === 0) return new Set(['1','X','2']); // fallback

  // Alltid spika om modellen √§r √∂vertydlig
  if (m.spike1) return new Set(['1']);
  if (m.spike2) return new Set(['2']);

  // Antifavorit: helgardera
  if (m.antiFolk) return new Set(allowed);

  // Gardera d√§r folket systemaiskt √∂verskattar
  const gardera = new Set();
  if (m.garDen1) { gardera.add('1'); if (!m.neverX) gardera.add('X'); }
  if (m.garDen2) { gardera.add('2'); if (!m.neverX) gardera.add('X'); }
  if (gardera.size >= 2) return gardera;

  // Tydlig favorit (empirisk sannolikhet > 60%)
  const ep1=m.ep1||33, epx=m.epx||33, ep2=m.ep2||34;
  const mx = Math.max(ep1, epx, ep2);
  if (mx > 60) return new Set([mx===ep1?'1':mx===epx?'X':'2']);

  // Halvgardera ‚Äî uteslut det minst sannolika tecknet
  if (mx > 48) {
    const mn = Math.min(ep1, epx, ep2);
    const excl = mn===ep1?'1':mn===epx?'X':'2';
    return new Set(allowed.filter(s=>s!==excl));
  }

  // √ñppen match ‚Äî helgardera (med till√•tna tecken)
  return new Set(allowed);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MATEMATIK
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function poissonBinomialPMF(pvec) {
  const n=pvec.length, dp=new Float64Array(n+1); dp[0]=1;
  for(const p of pvec){ for(let k=n;k>=1;k--) dp[k]=dp[k]*(1-p)+dp[k-1]*p; dp[0]*=(1-p); }
  return dp;
}
// Blandar upp till fyra signaler:
//   Pinnacle xP (skarpaste marknaden) ‚Üí 40%
//   Svenska Spel xP (fallback om ingen Pinnacle) ‚Üí 40%
//   Formmodell ‚Üí 25%
//   Eget sport-input ‚Üí 25%
// Vikterna normaliseras automatiskt beroende p√• vilka signaler som finns.
function getBlendedProb(m, i) {
  const sp   = xpSport[i];
  const fd   = (FORM_DATA     && FORM_DATA[i])     ? FORM_DATA[i]     : null;
  const pd   = (PINNACLE_DATA && PINNACLE_DATA[i]) ? PINNACLE_DATA[i] : null;
  const hasUser = sp.s1!==null && sp.sx!==null && sp.s2!==null;
  const hasForm = fd !== null;
  const hasPin  = pd !== null;

  // Marknadsbaseline: Pinnacle om tillg√§ngligt, annars Svenska Spel
  let p1 = hasPin ? pd.pp1/100 : m.xp1/100;
  let px = hasPin ? pd.ppx/100 : m.xpx/100;
  let p2 = hasPin ? pd.pp2/100 : m.xp2/100;

  // Bygg viktad mix dynamiskt
  const signals = [{ w: 0.40, p1, px, p2 }];   // marknad
  if (hasForm) signals.push({ w: 0.30, p1: fd.fp1/100, px: fd.fpx/100, p2: fd.fp2/100 });
  if (hasUser) {
    const ut = (sp.s1||0)+(sp.sx||0)+(sp.s2||0);
    if (ut>0) signals.push({ w: 0.30, p1: sp.s1/ut, px: sp.sx/ut, p2: sp.s2/ut });
  }

  // Normalisera vikter
  const wTot = signals.reduce((a,s)=>a+s.w, 0);
  let bp1=0, bpx=0, bp2=0;
  signals.forEach(s=>{ bp1+=s.p1*s.w/wTot; bpx+=s.px*s.w/wTot; bp2+=s.p2*s.w/wTot; });

  const tot = bp1+bpx+bp2;
  return { p1:bp1/tot, px:bpx/tot, p2:bp2/tot };
}

// activeProb: h√§mtar slutgiltig sannolikhet (odds + form + sport + korrelation)
function activeProb(m, i) {
  // Korrelationswrappern definieras senare i koden men anropas vid k√∂rning
  return (typeof getBlendedProbWithCorr === 'function')
    ? getBlendedProbWithCorr(m, i)
    : getBlendedProb(m, i);
}

function calcStats(sels) {
  sels = sels || selections;
  const cov = MATCHES.map((m,i) => {
    const s = sels[i];
    const bp = activeProb(m, i);
    return Math.min((s.has('1')?bp.p1:0)+(s.has('X')?bp.px:0)+(s.has('2')?bp.p2:0), 1);
  });
  const pmf = poissonBinomialPMF(cov);
  return { p13:pmf[13], p12:pmf[12]+pmf[13], E:cov.reduce((a,b)=>a+b,0), rows:sels.reduce((a,s)=>a*s.size,1) };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER STATS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtChance(p) {
  if (!p) return '‚Äì';
  return '1 av ' + Math.round(1/p).toLocaleString('sv');
}
function chanceMeta(p) {
  if (p>0.10) return { emoji:'üòÑ', text:'Riktigt bra chans! üåø',  color:'#22c55e', pct:Math.min(p*300,100) };
  if (p>0.02) return { emoji:'üòä', text:'Okej chans ‚òÄÔ∏è',           color:'#eab308', pct:Math.min(p*300,100) };
  if (p>0.005)return { emoji:'üòê', text:'Liten chans üå§Ô∏è',          color:'#f97316', pct:Math.min(p*300,100) };
  return             { emoji:'üò¨', text:'Mycket liten chans üåßÔ∏è',   color:'#ef4444', pct:Math.max(p*3000,2)  };
}

function recalc() {
  const st   = calcStats();
  const price= parseFloat(document.getElementById('price-input').value)||1;
  const meta = chanceMeta(st.p13);

  document.getElementById('meter-emoji').textContent = meta.emoji;
  document.getElementById('stat-p13').textContent    = fmtChance(st.p13);
  document.getElementById('stat-p12').textContent    = fmtChance(st.p12);
  document.getElementById('stat-rows').textContent   = st.rows.toLocaleString('sv')+(st.rows===1?' rad':' rader');
  document.getElementById('stat-cost').textContent   = '= '+(st.rows*price).toLocaleString('sv')+' kr';
  document.getElementById('stat-e').textContent      = st.E.toFixed(1)+' / 13';

  const bar=document.getElementById('chance-bar');
  bar.style.width   =meta.pct+'%';
  bar.style.background=meta.color;
  const lbl=document.getElementById('chance-bar-text');
  lbl.textContent=meta.text; lbl.style.color=meta.color;

  // Rad-chips med v√§rde-dot
  document.getElementById('rad-chips').innerHTML = selections.map((s,i) => {
    const m=MATCHES[i]; const key=[...s].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
    const selVg=['1','X','2'].filter(x=>s.has(x)).map(x=>x==='1'?m.vg1:x==='X'?m.vgx:m.vg2);
    const avgVg=selVg.reduce((a,b)=>a+b,0)/selVg.length;
    const dot=avgVg>=2?'<span class="rc-dot rc-dot-p"></span>':avgVg<=-2?'<span class="rc-dot rc-dot-n"></span>':'';
    return `<div class="rad-chip rc-${key}"><span class="rc-num">${i+1}.</span>${key}${dot}</div>`;
  }).join('');

  // Profil
  let c1=0,cX=0,c2=0,cG=0;
  selections.forEach(s=>{ if(s.size>1)cG++; if(s.size===1&&s.has('1'))c1++; if(s.size===1&&s.has('X'))cX++; if(s.size===1&&s.has('2'))c2++; });
  document.getElementById('cnt-1').textContent=c1;
  document.getElementById('cnt-X').textContent=cX;
  document.getElementById('cnt-2').textContent=c2;
  document.getElementById('cnt-gard').textContent=cG;
  const w=document.getElementById('prof-warn');
  if(c1>=7)     w.textContent='‚ö†Ô∏è M√•nga ettor ‚Äì ovanliga kryss/tv√•or ger b√§ttre utdelning!';
  else if(cX<2) w.textContent='üí° Tips: l√§gg till fler kryss ‚Äì de ger ofta b√§st utdelning!';
  else          w.textContent='';

  // Kupong-betyg
  const grEl = document.getElementById('kupong-grade');
  if (grEl) { const g=kupongGrade(); grEl.className=g.cls; grEl.textContent=g.emoji+' '+g.grade; }

  // Topptips-strip
  renderTopptips();

  // Dashboard update
  renderDashboard();

  // Smart R-system tips i kupong
  const sysEl = document.getElementById('sys-tip-bar');
  if (sysEl && typeof R_SYSTEMS !== 'undefined') {
    let helg = 0, halvg = 0;
    selections.forEach(s => { if(s.size===3) helg++; else if(s.size===2) halvg++; });
    const fits = R_SYSTEMS.filter(s => s.helg <= helg && s.halvg <= halvg);
    const best = fits.filter(s => s.gar >= 12).sort((a,b) => a.rader - b.rader)[0];
    if (best && (helg > 0 || halvg > 0)) {
      sysEl.innerHTML = `üé≤ <strong>R-system-tips:</strong> Ditt val passar <strong>${best.name}</strong> ‚Äî kostar <strong>${best.rader} kr</strong> och garanterar <strong>${best.gar} r√§tt</strong> om ramen st√§mmer. <a href="#" onclick="showTab('mer');return false;">Se alla system ‚Üí</a>`;
      sysEl.classList.add('show');
    } else {
      sysEl.classList.remove('show');
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KONFIDENSPO√ÑNG & V√ÑRDE-INDIKATOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DASHBOARD-RENDERING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  // Grade
  const grEl = document.getElementById('kupong-grade');
  const dashGrade = document.getElementById('dash-grade');
  const dashSub   = document.getElementById('dash-grade-sub');
  if (grEl && dashGrade) {
    dashGrade.textContent = grEl.textContent || '‚Äì';
    const gradeMap = {
      'A+':'Exceptionell rad ‚Äì topptips f√∂ljs perfekt!',
      'A':'Utm√§rkt rad med starka v√§rdeval.',
      'B+':'Mycket bra rad med bra v√§rdet√§ckning.',
      'B':'Bra rad ‚Äì de flesta v√§rdebets √§r med.',
      'C':'Godk√§nd rad ‚Äì n√•gra v√§rdebets saknas.',
      'D':'Svag rad ‚Äì √∂verv√§g att justera valen.',
      'F':'L√•g po√§ng ‚Äì testa "B√§sta rad" nedan.'
    };
    const g = (grEl.textContent||'').replace(/[^A-F+]/g,'');
    if (dashSub) dashSub.textContent = gradeMap[g] || 'V√§lj tecken f√∂r att ber√§kna betyg';
  }

  // Topptips-chips copy
  const ttSrc  = document.getElementById('tt-chips');
  const ttDest = document.getElementById('dash-tt-chips');
  if (ttSrc && ttDest) ttDest.innerHTML = ttSrc.innerHTML;

  // Uppdatera systemrekommendation och rad-EV (s√• att startsidans kopia √§r f√§rsk)
  if (typeof renderSystemTab === 'function')  renderSystemTab();
  if (typeof renderUSystemTab === 'function') renderUSystemTab();
  if (typeof renderRowEV === 'function')      renderRowEV();

  // R-system rekommendation ‚Üí kopiera till startsidans dashboard-kort
  const sysRec  = document.getElementById('sys-rec-box');
  const dSysName = document.getElementById('dash-sys-name');
  const dSysDet  = document.getElementById('dash-sys-detail');
  const dSysRec  = document.getElementById('dash-sys-rec-text');
  if (sysRec && dSysName) {
    const h3 = sysRec.querySelector('h3');
    const p  = sysRec.querySelector('p');
    dSysName.textContent = h3 ? h3.textContent.replace('‚≠ê Rekommenderat: ','') : '‚Äì';
    if (dSysDet) dSysDet.textContent = p ? p.textContent : '';
    if (dSysRec) dSysRec.textContent = '';
  }

  // V√§rde-score (medel av b√§sta vg per match)
  const vsEl = document.getElementById('dash-value-score');
  if (vsEl && typeof MATCHES !== 'undefined' && MATCHES.length) {
    const avg = MATCHES.reduce((s,m)=>s+Math.max(m.vg1||0,m.vgx||0,m.vg2||0),0)/MATCHES.length;
    vsEl.textContent = avg.toFixed(1) + ' %';
  }

  // Garderingar
  const gardEl = document.getElementById('cnt-gard');
  const dashGard = document.getElementById('dash-gard-cnt');
  if (gardEl && dashGard) dashGard.textContent = gardEl.textContent || '‚Äì';

  // Timer + omg√•ng
  const timerEl = document.getElementById('timer-closes');
  const dashTimer = document.getElementById('dash-timer-val');
  const dashRound = document.getElementById('dash-round-label');
  if (timerEl && dashTimer) dashTimer.textContent = timerEl.textContent || '‚Äì';
  if (dashRound && typeof ROUND !== 'undefined') dashRound.textContent = ROUND;
}

// Kupong-betyg A+ ‚Üí F baserat p√• hur v√§l valen matchar v√§rdegap
function kupongGrade() {
  let score = 0;
  MATCHES.forEach((m,i) => {
    const sel = selections[i];
    const selVg = ['1','X','2'].filter(s=>sel.has(s)).map(s=>s==='1'?m.vg1:s==='X'?m.vgx:m.vg2);
    const avgVg = selVg.reduce((a,b)=>a+b,0)/selVg.length;
    if (avgVg >= m.bestVg-1) score+=10;
    else if (avgVg >= 2)     score+=8;
    else if (avgVg >= 0)     score+=5;
    else if (avgVg >= -3)    score+=2;
  });
  const pct = score/(MATCHES.length*10)*100;
  if (pct>=90) return {grade:'A+',cls:'g-Ap',emoji:'üèÜ'};
  if (pct>=80) return {grade:'A', cls:'g-A', emoji:'‚úÖ'};
  if (pct>=70) return {grade:'B+',cls:'g-Bp',emoji:'üíé'};
  if (pct>=55) return {grade:'B', cls:'g-B', emoji:'üëç'};
  if (pct>=40) return {grade:'C', cls:'g-C', emoji:'üìä'};
  if (pct>=25) return {grade:'D', cls:'g-D', emoji:'‚ö†Ô∏è'};
  return {grade:'F',cls:'g-F',emoji:'‚ùå'};
}

// Render topptips-strip med algoritmens b√§sta enkelrad
function renderTopptips() {
  const el = document.getElementById('tt-chips');
  if (!el) return;
  const chips = MATCHES.map((m,i) => {
    const mv=Math.max(m.vg1,m.vgx,m.vg2);
    const sign = mv>=3 ? (mv===m.vg1?'1':mv===m.vgx?'X':'2') : (m.xp1>=m.xpx&&m.xp1>=m.xp2?'1':m.xpx>=m.xp2?'X':'2');
    const vg = sign==='1'?m.vg1:sign==='X'?m.vgx:m.vg2;
    const dot = vg>=2?'<span class="rc-dot rc-dot-p"></span>':vg<=-2?'<span class="rc-dot rc-dot-n"></span>':'';
    return `<div class="rad-chip rc-${sign}" style="font-size:.77rem;padding:3px 8px;">${i+1}.${sign}${dot}</div>`;
  }).join('');
  el.innerHTML = chips;

  // Uppdatera EV-rad-chips
  const evEl = document.getElementById('ev-row-chips');
  if (evEl && MATCHES.length) {
    const best = computeBestEVRow();
    if (best) {
      evEl.innerHTML = best.row.map((sign, i) => {
        const vg = sign==='1'?MATCHES[i].vg1:sign==='X'?MATCHES[i].vgx:MATCHES[i].vg2;
        const dot = vg>=2?'<span class="rc-dot rc-dot-p"></span>':vg<=-2?'<span class="rc-dot rc-dot-n"></span>':'';
        return `<div class="rad-chip rc-${sign}" style="font-size:.77rem;padding:3px 8px;">${i+1}.${sign}${dot}</div>`;
      }).join('');
    }
  }

  // Uppdatera Kombisystem-chips
  const combiEl = document.getElementById('combi-chips');
  const combiLabel = document.getElementById('combi-rows-label');
  if (combiEl && MATCHES.length) {
    const combi = computeCombiSystem();
    if (combi) {
      combiEl.innerHTML = combi.system.map((signs, i) => {
        const key = [...signs].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
        const agreed = signs.size === 1;
        const style = agreed
          ? 'font-size:.77rem;padding:3px 8px;'
          : 'font-size:.77rem;padding:3px 8px;outline:2px solid #a78bfa;';
        return `<div class="rad-chip rc-${key}" style="${style}">${i+1}.${key}</div>`;
      }).join('');
      if (combiLabel) combiLabel.textContent = combi.nRows + ' rad' + (combi.nRows===1?'':'er');
    }
  }

  // Uppdatera Poisson- och garderingstrip
  renderPoissonStrip();
  renderGarderingStrip();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üé≤ SMART POISSON-RAD
//  Kombinerar Poisson-sannolikheter med value-filter mot folk%:
//  A) Kryss-tr√∂skel: v√§lj X om P(X)‚â•22% OCH X √§r understreckat ‚â•4pp
//  B) Value-filter: undvik tecken som √§r √∂verstreckat >8pp vs Poisson
//  C) Fallback: v√§lj argmax om inget tecken klarar value-filter
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function computeSmartPoissonRow() {
  if (!MATCHES || !MATCHES.length) return null;
  return MATCHES.map(m => {
    if (!m.hasPoissonData) return null;
    const f1 = m.folk1 || m.f1 || 33;
    const fx = m.folkX || m.fx || 33;
    const f2 = m.folk2 || m.f2 || 34;
    const p1 = m.poissonP1, px = m.poissonPX, p2 = m.poissonP2;

    // A) Kryss-tr√∂skel: om Poisson s√§ger ‚â•22% f√∂r X OCH X √§r understreckat ‚â•4pp ‚Üí preferera X
    if (px >= 22 && (px - fx) >= 4) return 'X';

    // B) Value-filter: v√§lj b√§sta tecknet som INTE √§r √∂verstreckat >8pp vs Poisson
    const candidates = [
      { sign: '1', poi: p1, folk: f1 },
      { sign: 'X', poi: px, folk: fx },
      { sign: '2', poi: p2, folk: f2 },
    ].filter(c => (c.folk - c.poi) <= 8)   // ta bort √∂verstreckat
     .sort((a, b) => b.poi - a.poi);        // sortera efter Poisson-sannolikhet

    if (candidates.length > 0) return candidates[0].sign;

    // C) Fallback: alla tecken √§r √∂verstreckat ‚Äî v√§lj Poisson-argmax
    const best = Math.max(p1, px, p2);
    return best === p1 ? '1' : best === px ? 'X' : '2';
  });
}

function computeBestEVRow() {
  if (!MATCHES || !MATCHES.length) return null;
  // Eftersom x1/x3 = Œ†(xp_i/folk_i) per match kan vi optimera varje match oberoende
  let totalRatio = 1;
  const row = MATCHES.map(m => {
    const r1 = (m.xp1||33) / (m.folk1||m.f1||33);
    const rX = (m.xpx||33) / (m.folkX||m.fx||33);
    const r2 = (m.xp2||34) / (m.folk2||m.f2||34);
    const best = Math.max(r1, rX, r2);
    totalRatio *= best;
    return best === r1 ? '1' : best === rX ? 'X' : '2';
  });
  return { row, ratio: totalRatio };
}

// Till√§mpar b√§sta EV-raden p√• kupong + recalc
function applyBestEVRow() {
  const best = computeBestEVRow();
  if (!best) return;
  best.row.forEach((sign, i) => { selections[i] = new Set([sign]); });
  recalc();
  renderMatches();
  saveSelections();
  showToast('üìä EV-raden applicerad!');
}

// Ber√§knar kombisystem: Ytterberg + Smart Poisson sl√•s ihop per match
// √ñverens ‚Üí spika, skiljer sig ‚Üí gardera b√•da
function computeCombiSystem() {
  if (!MATCHES || !MATCHES.length) return null;

  // Bl√•: Ytterberg-v√§rdealgoritm
  const blueRow = MATCHES.map(m => {
    const mv = Math.max(m.vg1, m.vgx, m.vg2);
    return mv >= 3 ? (mv===m.vg1?'1':mv===m.vgx?'X':'2')
                   : (m.xp1>=m.xpx&&m.xp1>=m.xp2?'1':m.xpx>=m.xp2?'X':'2');
  });

  // Gr√∂n: Smart Poisson (ers√§tter EV-raden ‚Äî mer balanserad, garderar inte mot alla favoriter)
  const poissonRow = computeSmartPoissonRow();
  if (!poissonRow) return null;

  // Sl√• ihop: √∂verens ‚Üí spika, skiljer sig ‚Üí gardera b√•da
  const system = MATCHES.map((_, i) => {
    const blue = blueRow[i];
    const green = poissonRow[i];
    if (!green || blue === green) return new Set([blue]);
    return new Set([blue, green]);
  });

  const nRows = system.reduce((prod, s) => prod * s.size, 1);
  return { system, nRows };
}

// Till√§mpar kombisystemet p√• kupong + recalc
function applyCombiSystem() {
  const combi = computeCombiSystem();
  if (!combi) return;
  combi.system.forEach((signs, i) => { selections[i] = signs; });
  recalc();
  renderMatches();
  saveSelections();
  showToast('üîÄ Kombisystemet applicerat!');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üé≤ POISSON-MODELLEN ‚Äî Fotbollsm√•lsannolikheter via Poisson
//  Matematik: Œª_hem = (hgs + agc) / 2, Œª_bort = (ags + hgc) / 2
//  P(i m√•l) = e^(-Œª)¬∑Œª^i/i!  |  summera i√ój-matrisen 0..8
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// P(X=k) for Poisson(lambda)
function poissonProb(lambda, k) {
  if (lambda <= 0) return k === 0 ? 1 : 0;
  let p = Math.exp(-lambda);
  for (let j = 1; j <= k; j++) p = p * lambda / j;
  return p;
}

// Ber√§knar P(1), P(X), P(2) via full i√ój-matris med Dixon-Coles-korrektion (maxGoals=8)
// Dixon & Coles (1997): standard-Poisson √∂verskattar 0-0 och underskattar 1-0/0-1/1-1
// œÑ-faktorn justerar de fyra l√•gscore-utfallen med œÅ ‚âà -0.13
function computePoissonProbs(lambdaH, lambdaA, maxGoals = 8) {
  const rho = -0.13;
  let p1 = 0, px = 0, p2 = 0;
  for (let i = 0; i <= maxGoals; i++) {
    const ph = poissonProb(lambdaH, i);
    for (let j = 0; j <= maxGoals; j++) {
      const pa = poissonProb(lambdaA, j);
      // Dixon-Coles œÑ-korrektion f√∂r l√•gscore-utfall
      let tau = 1;
      if      (i === 0 && j === 0) tau = 1 - lambdaH * lambdaA * rho;
      else if (i === 1 && j === 0) tau = 1 + lambdaA * rho;
      else if (i === 0 && j === 1) tau = 1 + lambdaH * rho;
      else if (i === 1 && j === 1) tau = 1 - rho;
      const cell = ph * pa * Math.max(0, tau);
      if      (i > j) p1 += cell;
      else if (i === j) px += cell;
      else              p2 += cell;
    }
  }
  const tot = p1 + px + p2 || 1;
  return {
    p1: +(p1 / tot * 100).toFixed(1),
    px: +(px / tot * 100).toFixed(1),
    p2: +(p2 / tot * 100).toFixed(1),
    lambdaH: +lambdaH.toFixed(2),
    lambdaA: +lambdaA.toFixed(2)
  };
}

// Estimerar ŒªH och ŒªA fr√•n normaliserade odds-sannolikheter via grid search
// S√∂ker det Œª-par som b√§st reproducerar bookmakerens P(1), P(X), P(2)
function estimateLambdasFromOdds(p1norm, pxnorm, p2norm) {
  let bestLH = 1.5, bestLA = 1.0, bestErr = 1e9;
  // Grov s√∂kning 0.2‚Äì4.0 i steg om 0.15
  for (let lh = 0.2; lh <= 4.0; lh += 0.15) {
    for (let la = 0.1; la <= 4.0; la += 0.15) {
      let rp1 = 0, rpx = 0, rp2 = 0;
      for (let i = 0; i <= 7; i++) {
        const ph = poissonProb(lh, i);
        for (let j = 0; j <= 7; j++) {
          const cell = ph * poissonProb(la, j);
          if (i > j) rp1 += cell; else if (i === j) rpx += cell; else rp2 += cell;
        }
      }
      const err = (rp1 - p1norm) ** 2 + (rpx - pxnorm) ** 2 + (rp2 - p2norm) ** 2;
      if (err < bestErr) { bestErr = err; bestLH = lh; bestLA = la; }
    }
  }
  return { lh: bestLH, la: bestLA };
}

// Poisson-data per match, lagras i MATCHES[i].poissonInput = {hgs,hgc,ags,agc}
// Ber√§knar och lagrar resultaten direkt p√• m
function applyPoissonToMatch(m, i) {
  const p = m.poissonInput;
  if (!p) { m.hasPoissonData = false; return; }
  const hgs5 = +p.hgs || 0, hgc5 = +p.hgc || 0;
  const ags5 = +p.ags || 0, agc5 = +p.agc || 0;
  if (hgs5 + hgc5 + ags5 + agc5 === 0) { m.hasPoissonData = false; return; }
  // Genomsnitt per match (5 matcher)
  const hgsA = hgs5 / 5, hgcA = hgc5 / 5;
  const agsA = ags5 / 5, agcA = agc5 / 5;
  // Hemmaf√∂rdelslambda (+15% f√∂r hemmaf√∂rdel, redan bakat i Elo men h√§r enkelt)
  const lambdaH = Math.max(0.1, (hgsA + agcA) / 2 * 1.10);
  const lambdaA = Math.max(0.1, (agsA + hgcA) / 2 * 0.92);
  const res = computePoissonProbs(lambdaH, lambdaA);
  m.poissonP1 = res.p1;
  m.poissonPX = res.px;
  m.poissonP2 = res.p2;
  m.poissonLH = res.lambdaH;
  m.poissonLA = res.lambdaA;
  m.hasPoissonData = true;
  m.poissonFromFDO = true;   // Markera som riktig data ‚Äî skrivs ej √∂ver av odds-estimat
  m.poissonFromOdds = false;
}

// HTML f√∂r Poisson-panelen per matchkort (dold, √∂ppnas av knapp)
function mcPoissonPanel(m, i) {
  const p = m.poissonInput || {};
  const hasData = m.hasPoissonData;
  const f1 = m.folk1 || m.f1 || 33;
  const fx = m.folkX || m.fx || 33;
  const f2 = m.folk2 || m.f2 || 34;

  const resHtml = hasData ? (() => {
    const vgBadge = (poiP, folk) => {
      const diff = +(poiP - folk).toFixed(1);
      const cls = diff >= 2 ? 'poisson-vg-pos' : diff <= -2 ? 'poisson-vg-neg' : 'poisson-vg-neu';
      const sign = diff > 0 ? '+' : '';
      return `<span class="poisson-res-vg ${cls}">${sign}${diff}%</span>`;
    };
    return `<div class="poisson-result" style="margin-top:8px;">
      <div class="poisson-res-cell">
        <div class="poisson-res-sign">1 (Hem)</div>
        <div class="poisson-res-pct">${m.poissonP1}%</div>
        <div class="poisson-res-lambda">Œª=${m.poissonLH}</div>
        ${vgBadge(m.poissonP1, f1)}
      </div>
      <div class="poisson-res-cell">
        <div class="poisson-res-sign">X (Kryss)</div>
        <div class="poisson-res-pct">${m.poissonPX}%</div>
        <div class="poisson-res-lambda">draw-prob</div>
        ${vgBadge(m.poissonPX, fx)}
      </div>
      <div class="poisson-res-cell">
        <div class="poisson-res-sign">2 (Bort)</div>
        <div class="poisson-res-pct">${m.poissonP2}%</div>
        <div class="poisson-res-lambda">Œª=${m.poissonLA}</div>
        ${vgBadge(m.poissonP2, f2)}
      </div>
    </div>`;
  })() : '';

  const sourceLabel = m.poissonFromFDO
    ? '‚öΩ Baserad p√• verklig formdata (football-data.org)'
    : 'üìê Estimerad fr√•n odds ‚Äî f√∂rfina med üé≤-knappen eller ‚öΩ Poisson-data';

  return `<div class="mc-poisson-panel" id="poisson-panel-${i}">
    <div style="font-size:.72rem;font-weight:700;color:#134e4a;margin-bottom:2px;">
      üé≤ Poisson-kalkylator
    </div>
    <div style="font-size:.65rem;color:#64748b;margin-bottom:6px;">${sourceLabel}</div>
    <div class="poisson-inputs">
      <div class="poisson-field">
        <label>üè† ${m.home} ‚Äî m√•l gjorda (5 m.)</label>
        <input class="poisson-inp" id="ph-gs-${i}" type="number" min="0" max="40" step="1" placeholder="t.ex. 8" value="${p.hgs||''}" oninput="calcPoisson(${i})">
      </div>
      <div class="poisson-field">
        <label>üè† ${m.home} ‚Äî m√•l insl√§ppta (5 m.)</label>
        <input class="poisson-inp" id="ph-gc-${i}" type="number" min="0" max="40" step="1" placeholder="t.ex. 4" value="${p.hgc||''}" oninput="calcPoisson(${i})">
      </div>
      <div class="poisson-field">
        <label>‚úàÔ∏è ${m.away} ‚Äî m√•l gjorda (5 m.)</label>
        <input class="poisson-inp" id="pa-gs-${i}" type="number" min="0" max="40" step="1" placeholder="t.ex. 6" value="${p.ags||''}" oninput="calcPoisson(${i})">
      </div>
      <div class="poisson-field">
        <label>‚úàÔ∏è ${m.away} ‚Äî m√•l insl√§ppta (5 m.)</label>
        <input class="poisson-inp" id="pa-gc-${i}" type="number" min="0" max="40" step="1" placeholder="t.ex. 7" value="${p.agc||''}" oninput="calcPoisson(${i})">
      </div>
    </div>
    <div style="font-size:.68rem;color:#64748b;margin-bottom:6px;">
      üí° Tips: hitta siffror p√• Sofascore, Flashscore eller Fotmob
    </div>
    <div id="poisson-res-${i}">${resHtml}</div>
  </div>`;
}

// Toggle Poisson-panel
function togglePoissonPanel(i) {
  const panel = document.getElementById('poisson-panel-' + i);
  const btn   = document.getElementById('poisson-btn-' + i);
  if (!panel) return;
  const open = panel.classList.toggle('open');
  if (btn) btn.classList.toggle('active', open);
}

// Live-ber√§kning av Poisson n√§r anv√§ndaren matar in data
function calcPoisson(i) {
  const hgs = parseFloat(document.getElementById('ph-gs-' + i)?.value) || 0;
  const hgc = parseFloat(document.getElementById('ph-gc-' + i)?.value) || 0;
  const ags = parseFloat(document.getElementById('pa-gs-' + i)?.value) || 0;
  const agc = parseFloat(document.getElementById('pa-gc-' + i)?.value) || 0;
  if (hgs + hgc + ags + agc === 0) return;
  const m = MATCHES[i];
  m.poissonInput = { hgs, hgc, ags, agc };
  applyPoissonToMatch(m, i);
  // Uppdatera resultat-HTML direkt
  const resEl = document.getElementById('poisson-res-' + i);
  if (resEl) {
    const f1 = m.folk1||m.f1||33, fx=m.folkX||m.fx||33, f2=m.folk2||m.f2||34;
    const vgBadge = (poiP, folk) => {
      const diff = +(poiP - folk).toFixed(1);
      const cls = diff>=2?'poisson-vg-pos':diff<=-2?'poisson-vg-neg':'poisson-vg-neu';
      return `<span class="poisson-res-vg ${cls}">${diff>0?'+':''}${diff}%</span>`;
    };
    resEl.innerHTML = `<div class="poisson-result">
      <div class="poisson-res-cell">
        <div class="poisson-res-sign">1 (Hem)</div>
        <div class="poisson-res-pct">${m.poissonP1}%</div>
        <div class="poisson-res-lambda">Œª=${m.poissonLH}</div>
        ${vgBadge(m.poissonP1, f1)}
      </div>
      <div class="poisson-res-cell">
        <div class="poisson-res-sign">X (Kryss)</div>
        <div class="poisson-res-pct">${m.poissonPX}%</div>
        <div class="poisson-res-lambda">draw-prob</div>
        ${vgBadge(m.poissonPX, fx)}
      </div>
      <div class="poisson-res-cell">
        <div class="poisson-res-sign">2 (Bort)</div>
        <div class="poisson-res-pct">${m.poissonP2}%</div>
        <div class="poisson-res-lambda">Œª=${m.poissonLA}</div>
        ${vgBadge(m.poissonP2, f2)}
      </div>
    </div>`;
  }
  // Uppdatera knapp
  const btn = document.getElementById('poisson-btn-' + i);
  if (btn) { btn.classList.add('active'); btn.textContent = 'üé≤ Poisson ‚úì'; }
  // Uppdatera strip
  renderPoissonStrip();
  // Uppdatera recalc (Poisson nu inbakat i Smart)
  recalc();
}

// Render Smart Poisson-stripen
function renderPoissonStrip() {
  const chips = document.getElementById('poisson-chips');
  const cov   = document.getElementById('poisson-coverage');
  if (!chips) return;
  const row = computeSmartPoissonRow();
  const covered = MATCHES.filter(m => m.hasPoissonData).length;
  if (cov) cov.textContent = covered > 0 ? `${covered}/${MATCHES.length} matcher` : '';
  const bgMap  = { '1':'#dbeafe', 'X':'#ede9fe', '2':'#d1fae5' };
  const clrMap = { '1':'#1e40af', 'X':'#4c1d95', '2':'#065f46' };
  chips.innerHTML = MATCHES.map((m, i) => {
    const sign = row && row[i];
    if (!sign) return `<span style="background:rgba(255,255,255,.12);border-radius:8px;padding:4px 7px;font-size:.76rem;font-weight:700;color:rgba(255,255,255,.35);">‚Äì</span>`;
    // Markera om tecknet avviker fr√•n Poisson-argmax (value-filtret slog till)
    const rawBest = Math.max(m.poissonP1, m.poissonPX, m.poissonP2);
    const rawSign = rawBest === m.poissonP1 ? '1' : rawBest === m.poissonPX ? 'X' : '2';
    const filtered = sign !== rawSign;
    const outline = filtered ? 'outline:2px solid #99f6e4;' : '';
    return `<span style="background:${bgMap[sign]};color:${clrMap[sign]};border-radius:8px;padding:4px 7px;font-size:.76rem;font-weight:800;${outline}">${sign}</span>`;
  }).join('');
}

// Applicera Smart Poisson-raden p√• kupong
function applyPoissonRow() {
  const row = computeSmartPoissonRow();
  if (!row) { showToast('‚ö†Ô∏è Ingen Poisson-data tillg√§nglig'); return; }
  const applied = row.filter(Boolean).length;
  row.forEach((sign, i) => { if (sign) selections[i] = new Set([sign]); });
  recalc(); renderMatches(); saveSelections();
  showToast(`üé≤ Smart Poisson applicerad (${applied} matcher)!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üõ°Ô∏è GARDERINGSSYSTEM ‚Äî 4 helgar + 4 halvgar + 5 spikar
//  Sorterar matcher efter Poisson-os√§kerhet (l√§gst maxP = mest os√§ker)
//  Helgar: alla 3 tecken ¬∑ Halvgar: top 2 med value-filter ¬∑ Spika: Smart Poisson
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function computeGarderingSystem() {
  if (!MATCHES || !MATCHES.length) return null;

  // M√§t os√§kerhet per match: l√§gre maxP = mer os√§ker = gardera mer
  const ranked = MATCHES.map((m, i) => {
    const maxP = m.hasPoissonData
      ? Math.max(m.poissonP1, m.poissonPX, m.poissonP2)
      : 100; // inga Poisson-data ‚Üí behandla som s√§ker (spika)
    return { i, maxP, m };
  }).sort((a, b) => a.maxP - b.maxP); // stigande: os√§krast f√∂rst

  const smartRow = computeSmartPoissonRow();
  const result = new Array(MATCHES.length);

  ranked.forEach((item, rank) => {
    const m = item.m;
    const f1 = m.folk1 || m.f1 || 33;
    const fx = m.folkX || m.fx || 33;
    const f2 = m.folk2 || m.f2 || 34;

    if (rank < 4) {
      // Helgardering: alla tre tecken
      result[item.i] = { type: 'full', signs: new Set(['1', 'X', '2']) };

    } else if (rank < 8) {
      // Halvgardering: top 2 med value-filter (undvik √∂verstreckat >8pp)
      const candidates = [
        { sign: '1', poi: m.poissonP1 || 33, folk: f1 },
        { sign: 'X', poi: m.poissonPX || 33, folk: fx },
        { sign: '2', poi: m.poissonP2 || 34, folk: f2 },
      ].filter(c => (c.folk - c.poi) <= 8)
       .sort((a, b) => b.poi - a.poi);

      // Fallback om value-filter tar bort f√∂r m√•nga
      const pool = candidates.length >= 2 ? candidates
        : [{ sign:'1', poi: m.poissonP1||33 }, { sign:'X', poi: m.poissonPX||33 }, { sign:'2', poi: m.poissonP2||34 }]
            .sort((a, b) => b.poi - a.poi);

      result[item.i] = { type: 'half', signs: new Set([pool[0].sign, pool[1].sign]) };

    } else {
      // Spika: Smart Poisson-val
      const sign = (smartRow && smartRow[item.i]) || (() => {
        const best = Math.max(m.poissonP1||33, m.poissonPX||33, m.poissonP2||34);
        return best === (m.poissonP1||33) ? '1' : best === (m.poissonPX||33) ? 'X' : '2';
      })();
      result[item.i] = { type: 'spike', signs: new Set([sign]) };
    }
  });

  const nRows = result.reduce((prod, r) => prod * r.signs.size, 1);
  return { result, nRows };
}

function renderGarderingStrip() {
  const chips = document.getElementById('gard-chips');
  const label = document.getElementById('gard-rows-label');
  if (!chips) return;
  const sys = computeGarderingSystem();
  if (!sys) return;
  if (label) label.textContent = sys.nRows.toLocaleString('sv-SE') + ' rader';

  const bgFull  = '#fed7aa', clrFull  = '#7c2d12';  // orange = helgar
  const bgHalf  = '#fef08a', clrHalf  = '#713f12';  // gul = halvgar
  const bgSpike = { '1':'#dbeafe','X':'#ede9fe','2':'#d1fae5' };
  const clrSpike= { '1':'#1e40af','X':'#4c1d95','2':'#065f46' };

  chips.innerHTML = sys.result.map((r, i) => {
    const key = [...r.signs].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
    if (r.type === 'full') {
      return `<span title="Helgardering" style="background:${bgFull};color:${clrFull};border-radius:8px;padding:4px 7px;font-size:.73rem;font-weight:800;">${i+1}.1X2</span>`;
    } else if (r.type === 'half') {
      return `<span title="Halvgardering" style="background:${bgHalf};color:${clrHalf};border-radius:8px;padding:4px 7px;font-size:.73rem;font-weight:800;">${i+1}.${key}</span>`;
    } else {
      const s = key;
      return `<span title="Spikad" style="background:${bgSpike[s]};color:${clrSpike[s]};border-radius:8px;padding:4px 7px;font-size:.73rem;font-weight:800;">${i+1}.${s}</span>`;
    }
  }).join('');
}

function applyGarderingRow() {
  const sys = computeGarderingSystem();
  if (!sys) { showToast('‚ö†Ô∏è Ingen Poisson-data tillg√§nglig'); return; }
  sys.result.forEach((r, i) => { selections[i] = new Set(r.signs); });
  recalc(); renderMatches(); saveSelections();
  showToast(`üõ°Ô∏è Garderingssystem applicerat ‚Äî ${sys.nRows.toLocaleString('sv-SE')} rader`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚ö° MOTIVATIONSTOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMotivation(i) {
  const m = MATCHES[i];
  m.lowMotivation = !m.lowMotivation;
  // R√§kna om derived stats med motivationsjustering
  computeMatchDerived(MATCHES);
  applyEloToMatches();
  recalc();
  renderMatches();
  renderTopptips();
  const badge = m.lowMotivation ? 'Utan motivation ‚Äî sannolikheter justerade ned f√∂r favoriten' : 'Motivationsflagg borttagen';
  showToast(`‚ö° Match ${i+1}: ${badge}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚öΩ FOOTBALL-DATA.ORG ‚Äî AUTO-FORMDATA F√ñR POISSON
//  API-dokumentation: https://www.football-data.org/documentation/quickstart
//  Gratis: 10 req/min ¬∑ t√§cker PL, BL1, PD, SA, FL1, DED, BSA, CL m.fl.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// H√•rdkodad tabell: lagnamn (lowercase) ‚Üí football-data.org team-ID
// T√§cker de vanligaste lagen i Stryktipset
const FDO_TEAM_IDS = {
  // Premier League
  'arsenal':57,'chelsea':61,'liverpool':64,'manchester city':65,'man city':65,
  'manchester united':66,'man united':66,'man utd':66,'tottenham':73,'spurs':73,
  'tottenham hotspur':73,'newcastle':67,'newcastle united':67,'west ham':563,
  'west ham united':563,'aston villa':58,'brighton':397,'brentford':402,
  'crystal palace':354,'everton':62,'fulham':63,'wolves':76,'wolverhampton':76,
  'bournemouth':1044,'nottingham forest':351,'leicester':338,'leicester city':338,
  'southampton':340,'ipswich':57, // approx
  // Championship
  'leeds':341,'leeds united':341,'middlesbrough':343,'millwall':345,'norwich':71,
  'norwich city':71,'watford':346,'swansea':72,'sheffield united':356,
  'sheffield wed':348,'sheffield wednesday':348,'portsmouth':2288,
  'birmingham':332,'birmingham city':332,'oxford':395,'oxford united':395,
  'charlton':344,'charlton athletic':344,'derby':328,'derby county':328,
  'wrexham':8586,'mansfield':8590,'lincoln':7141,'lincoln city':7141,
  'wimbledon':38,'afc wimbledon':38,'bradford':347,'bradford city':347,
  // Bundesliga
  'bayern':5,'bayern munich':5,'borussia dortmund':4,'dortmund':4,
  'rb leipzig':721,'leipzig':721,'leverkusen':3,'bayer leverkusen':3,
  'frankfurt':19,'eintracht frankfurt':19,'wolfsburg':11,'bochum':36,
  'augsburg':16,'freiburg':17,'hoffenheim':2,'1899 hoffenheim':2,
  'mainz':15,'1. fsv mainz 05':15,'monchengladbach':18,'borussia monchengladbach':18,
  'union berlin':28,'1. fc union berlin':28,'heidenheim':720,'st. pauli':20,
  'werder bremen':12,'bremen':12,'koln':23,'1. fc koln':23,'Holstein kiel':27,
  // La Liga
  'real madrid':86,'barcelona':81,'atletico madrid':78,'sevilla':94,
  'real sociedad':92,'villarreal':94,'betis':90,'real betis':90,'valencia':95,
  'athletic bilbao':77,'athletic':77,'girona':298,'osasuna':88,
  'getafe':82,'las palmas':275,'rayo vallecano':87,'alaves':263,
  'celta vigo':558,'espanyol':83,'mallorca':89,'leganes':745,
  // Serie A
  'juventus':109,'inter':108,'inter milan':108,'ac milan':98,'milan':98,
  'napoli':113,'roma':100,'lazio':110,'atalanta':102,'fiorentina':99,
  'bologna':103,'torino':586,'udinese':115,'genoa':107,'como':584,
  'monza':5911,'cagliari':104,'parma':112,'lecce':111,'empoli':106,
  'venezia':450,'hellas verona':450,
  // Ligue 1
  'psg':524,'paris saint-germain':524,'paris sg':524,'marseille':516,
  'monaco':548,'lyon':523,'nice':522,'lille':521,'lens':516,
  'rennes':529,'strasbourg':527,'reims':532,'montpellier':519,'nantes':543,
  'toulouse':538,'brest':528,'st etienne':511,'angers':536,'auxerre':531,
  // Eredivisie
  'ajax':674,'psv':674,'feyenoord':675,'az alkmaar':682,'az':682,
  'twente':683,'fc twente':683,'utrecht':680,'heerenveen':676,
  'groningen':677,'vitesse':678,'sparta rotterdam':686,'heracles':681,
  // Swedish
  'malmo':1591,'malm√∂ ff':1591,'djurgarden':1595,'djurg√•rdens':1595,
  'hammarby':1594,'iFK g√∂teborg':1593,'g√∂teborg':1593,'aik':1592,
  'h√§cken':1596,'bk h√§cken':1596,'sirius':1600,'ifk norrk√∂ping':1597,
  'norrk√∂ping':1597,'kalmar':1601,'kalmar ff':1601,'brommapojkarna':1602,
  'bp':1602,'gais':1603,'varberg':1604,'halmstad':1605,'degerfors':1606,
  // Superettan / Div 1 approx
  '√∂ster':1610,'gif sundsvall':1611,'√∂rebro':1608,'helsingborg':1607,
  // Champions League teams (approximate)
  'porto':503,'benfica':498,'sporting cp':498,'sporting':498,
  'celtic':500,'rangers':499,'brondby':250,'fc copenhagen':250,
};

// Normalisera lagnamn f√∂r s√∂kning
function fdoNormalize(name) {
  return (name || '').toLowerCase()
    .replace(/\bfc\b|\bif\b|\bbk\b|\bifk\b|\bsc\b|\bac\b|\bfk\b/g, '')
    .replace(/[^a-z√•√§√∂0-9 ]/g, '').replace(/\s+/g, ' ').trim();
}

// Hitta football-data.org ID f√∂r ett lagnamn
function fdoFindTeamId(name) {
  const norm = fdoNormalize(name);
  const lower = name.toLowerCase().trim();
  // Exakt match
  if (FDO_TEAM_IDS[lower] !== undefined) return FDO_TEAM_IDS[lower];
  if (FDO_TEAM_IDS[norm] !== undefined) return FDO_TEAM_IDS[norm];
  // Partiell match
  for (const [key, id] of Object.entries(FDO_TEAM_IDS)) {
    if (key.includes(norm) || norm.includes(key)) return id;
  }
  // Ordmatch
  const words = norm.split(' ').filter(w => w.length >= 4);
  for (const [key, id] of Object.entries(FDO_TEAM_IDS)) {
    if (words.some(w => key.includes(w))) return id;
  }
  return null;
}

// Hj√§lpfunktion: h√§mta med retry och rate-limit-respekt
async function fdoFetch(url, token) {
  const resp = await fetch(url, { headers: { 'X-Auth-Token': token } });
  if (resp.status === 429) throw new Error('RATE_LIMIT');
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  return resp.json();
}

// H√§mta senaste 5 f√§rdiga matcher f√∂r ett team-ID, returnera {scored, conceded}
async function fdoTeamStats(teamId, token) {
  const url = `https://api.football-data.org/v4/teams/${teamId}/matches?status=FINISHED&limit=5`;
  const data = await fdoFetch(url, token);
  const matches = (data.matches || []).slice(-5);
  let scored = 0, conceded = 0;
  matches.forEach(match => {
    const isHome = match.homeTeam?.id === teamId;
    const hs = match.score?.fullTime?.home ?? 0;
    const as = match.score?.fullTime?.away ?? 0;
    if (isHome) { scored += hs; conceded += as; }
    else         { scored += as; conceded += hs; }
  });
  return { scored, conceded, games: matches.length };
}

// Huvudfunktion: h√§mtar formdata f√∂r alla matcher och fyller i Poisson
async function fetchFootballData() {
  const token = document.getElementById('fdo-api-key')?.value?.trim();
  const statusEl  = document.getElementById('fdo-status');
  const resultEl  = document.getElementById('fdo-result');
  const progWrap  = document.getElementById('fdo-progress-wrap');
  const progBar   = document.getElementById('fdo-progress-bar');
  const progText  = document.getElementById('fdo-progress-text');

  if (!token) {
    if (statusEl) statusEl.textContent = '‚ö†Ô∏è Ange din API-token fr√•n football-data.org';
    return;
  }

  if (progWrap) progWrap.style.display = 'block';
  if (resultEl) resultEl.style.display = 'none';
  if (statusEl) statusEl.textContent = '';

  // Bygg en lista med unika lag + matchindex
  const teamWork = []; // { name, matchIdx, side:'home'|'away' }
  MATCHES.forEach((m, i) => {
    teamWork.push({ name: m.home, matchIdx: i, side: 'home' });
    teamWork.push({ name: m.away, matchIdx: i, side: 'away' });
  });

  const total = teamWork.length;
  let done = 0, found = 0, notFound = [];
  const results = {}; // lagnamn ‚Üí {scored, conceded}
  const DELAY_MS = 7000; // 10 req/min ‚Üí 6 sek, vi tar 7 f√∂r s√§kerhets skull

  const setProgress = (txt) => {
    const pct = Math.round(done / total * 100);
    if (progBar) progBar.style.width = pct + '%';
    if (progText) progText.textContent = txt;
    // Quick-mode: visa √§ven i Kupong-flikens inline-panel
    if (window._fdoQuickMode && window._fdoQuickProgEl) {
      window._fdoQuickProgEl.textContent = `‚è≥ ${txt}`;
    }
  };

  setProgress(`Startar‚Ä¶ (${total} lag att h√§mta, ~${Math.ceil(total * DELAY_MS / 60000)} min)`);

  for (const work of teamWork) {
    const { name, matchIdx, side } = work;
    // Skippa om vi redan h√§mtat detta lag
    if (results[name] !== undefined) {
      done++;
      setProgress(`H√§mtar ${name} (${done}/${total})‚Ä¶`);
      applyPoissonInput(matchIdx, side, results[name]);
      continue;
    }

    const teamId = fdoFindTeamId(name);
    if (!teamId) {
      notFound.push(name);
      done++;
      results[name] = null;
      setProgress(`${name} hittades inte (${done}/${total})`);
      continue;
    }

    try {
      setProgress(`H√§mtar ${name} (${done + 1}/${total})‚Ä¶`);
      const stats = await fdoTeamStats(teamId, token);
      results[name] = stats;
      applyPoissonInput(matchIdx, side, stats);
      found++;
    } catch (e) {
      if (e.message === 'RATE_LIMIT') {
        setProgress(`Rate-limit! V√§ntar 30 sekunder‚Ä¶`);
        await new Promise(r => setTimeout(r, 30000));
        // F√∂rs√∂k igen
        try {
          const stats = await fdoTeamStats(teamId, token);
          results[name] = stats;
          applyPoissonInput(matchIdx, side, stats);
          found++;
        } catch(e2) { results[name] = null; notFound.push(name); }
      } else {
        results[name] = null;
        notFound.push(name);
      }
    }

    done++;
    // Rate-limiting: v√§nta mellan anrop (men ej sista)
    if (done < total) await new Promise(r => setTimeout(r, DELAY_MS));
  }

  // K√∂r Poisson-ber√§kning f√∂r alla matcher som har komplett data
  let poissonApplied = 0;
  MATCHES.forEach((m, i) => {
    if (m.poissonInput &&
        m.poissonInput.hgs >= 0 && m.poissonInput.hgc >= 0 &&
        m.poissonInput.ags >= 0 && m.poissonInput.agc >= 0 &&
        m.poissonInput.hgs + m.poissonInput.hgc + m.poissonInput.ags + m.poissonInput.agc > 0) {
      applyPoissonToMatch(m, i);
      poissonApplied++;
    }
  });

  recalc();
  renderMatches();
  renderTopptips();
  if (progWrap) progWrap.style.display = 'none';

  const summary = [
    `‚úÖ Poisson-kalkylator ifylld f√∂r <strong>${poissonApplied} matcher</strong>`,
    notFound.length ? `‚ö†Ô∏è Hittades ej: ${notFound.join(', ')}` : 'üéâ Alla lag hittades!',
    `Se Poisson-stripen ovan, eller klicka üé≤ p√• ett matchkort f√∂r detaljer.`
  ].join('<br>');

  if (resultEl) { resultEl.innerHTML = summary; resultEl.style.display = 'block'; }
  if (statusEl) statusEl.textContent = '';
  showToast(`‚öΩ Formdata h√§mtad! Poisson klar f√∂r ${poissonApplied}/${MATCHES.length} matcher`);
}

// Fyller i Poisson-input-objekt f√∂r en match utifr√•n lagets stats
function applyPoissonInput(matchIdx, side, stats) {
  if (!stats || !MATCHES[matchIdx]) return;
  if (!MATCHES[matchIdx].poissonInput) {
    MATCHES[matchIdx].poissonInput = { hgs: 0, hgc: 0, ags: 0, agc: 0 };
  }
  const p = MATCHES[matchIdx].poissonInput;
  if (side === 'home') {
    p.hgs = stats.scored;
    p.hgc = stats.conceded;
  } else {
    p.ags = stats.scored;
    p.agc = stats.conceded;
  }
}

// Snabbknapp i Kupong-fliken ‚Äî visa/d√∂lj quick-panel
function showQuickFdo() {
  const panel = document.getElementById('quick-fdo-panel');
  if (!panel) return;
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  // Synka token om den redan matats in i Mer-fliken
  const merKey = document.getElementById('fdo-api-key')?.value;
  const quickKey = document.getElementById('fdo-api-key-quick');
  if (merKey && quickKey && !quickKey.value) quickKey.value = merKey;
}

// K√∂r fetchFootballData men med token fr√•n quick-input och visar progress inline
async function fetchFootballDataQuick() {
  const quickKey = document.getElementById('fdo-api-key-quick')?.value?.trim();
  if (!quickKey) { showToast('‚ö†Ô∏è Ange din API-token'); return; }
  // Synka till Mer-flikens input s√• full-panel ocks√• fungerar
  const merKey = document.getElementById('fdo-api-key');
  if (merKey) merKey.value = quickKey;

  const prog = document.getElementById('quick-fdo-progress');
  if (prog) { prog.style.display = 'block'; prog.textContent = '‚è≥ Startar h√§mtning‚Ä¶'; }

  // Kapa in i fetchFootballData men statusuppdateringar ritas i quick-panel
  const origProg = document.getElementById('fdo-progress-text');
  const origWrap = document.getElementById('fdo-progress-wrap');
  // Tillf√§lligt omdirigera progress-text
  const _origUpdate = window._fdoProgUpdate;
  window._fdoQuickMode = true;
  window._fdoQuickProgEl = prog;

  await fetchFootballData();

  window._fdoQuickMode = false;
  if (prog) prog.style.display = 'none';
  document.getElementById('quick-fdo-panel').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üåê MARKNADSODDS ‚Äî THE ODDS API (Sharp/Pinnacle)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchSharpOdds() {
  const key = document.getElementById('odds-api-key')?.value?.trim();
  const statusEl = document.getElementById('sharp-status');
  const resultEl = document.getElementById('sharp-result');
  if (!key) { if (statusEl) statusEl.textContent = '‚ö†Ô∏è Ange din API-nyckel fr√•n the-odds-api.com'; return; }
  if (statusEl) statusEl.textContent = '‚è≥ H√§mtar odds‚Ä¶';

  // Matchar sport-typerna som Stryktipset t√§cker
  const sports = ['soccer_england_league1','soccer_england_league2','soccer_epl',
    'soccer_germany_bundesliga','soccer_spain_la_liga','soccer_italy_serie_a',
    'soccer_sweden_allsvenskan','soccer_sweden_superettan','soccer_france_ligue_one',
    'soccer_netherlands_eredivisie','soccer_scotland_premiership'];

  let allEvents = [];
  let remaining = '?';
  for (const sport of sports) {
    try {
      const url = `https://api.the-odds-api.com/v4/sports/${sport}/odds/?apiKey=${key}&regions=eu&markets=h2h&bookmakers=pinnacle,betfair_ex_eu,unibet_eu&oddsFormat=decimal`;
      const resp = await fetch(url);
      if (!resp.ok) { if (resp.status===401) { if(statusEl) statusEl.textContent='‚ùå Ogiltig API-nyckel'; return; } continue; }
      remaining = resp.headers.get('x-requests-remaining') || remaining;
      const data = await resp.json();
      allEvents = allEvents.concat(data);
    } catch(e) { /* forts√§tt med n√§sta sport */ }
  }

  if (statusEl) statusEl.textContent = `‚úÖ H√§mtat ${allEvents.length} matcher ¬∑ ${remaining} anrop kvar denna m√•nad`;

  // Matcha mot MATCHES via hemma/borta-lagnamn
  let matched = 0;
  MATCHES.forEach(m => {
    const homeNorm = m.home.toLowerCase().replace(/[^a-z0-9]/g,'');
    const awayNorm = m.away.toLowerCase().replace(/[^a-z0-9]/g,'');
    const ev = allEvents.find(e => {
      const hn = (e.home_team||'').toLowerCase().replace(/[^a-z0-9]/g,'');
      const an = (e.away_team||'').toLowerCase().replace(/[^a-z0-9]/g,'');
      return (hn.includes(homeNorm)||homeNorm.includes(hn)) && (an.includes(awayNorm)||awayNorm.includes(an));
    });
    if (!ev) { m.hasSharpOdds = false; return; }
    // Aggregera implicit sannolikhet fr√•n alla tillg√§ngliga bookmakers
    let sum1=0, sumX=0, sum2=0, cnt=0;
    (ev.bookmakers||[]).forEach(bk => {
      const h2h = (bk.markets||[]).find(mk=>mk.key==='h2h');
      if (!h2h) return;
      const o1 = h2h.outcomes.find(o=>o.name===ev.home_team)?.price;
      const oX = h2h.outcomes.find(o=>o.name==='Draw')?.price;
      const o2 = h2h.outcomes.find(o=>o.name===ev.away_team)?.price;
      if (!o1||!oX||!o2) return;
      const s = 1/o1+1/oX+1/o2;
      sum1 += 1/o1/s*100; sumX += 1/oX/s*100; sum2 += 1/o2/s*100;
      cnt++;
    });
    if (cnt > 0) {
      m.sharpP1 = +(sum1/cnt).toFixed(1);
      m.sharpPX = +(sumX/cnt).toFixed(1);
      m.sharpP2 = +(sum2/cnt).toFixed(1);
      m.sharpVg1 = +(m.sharpP1 - (m.folk1||m.f1||33)).toFixed(1);
      m.sharpVgX = +(m.sharpPX - (m.folkX||m.fx||33)).toFixed(1);
      m.sharpVg2 = +(m.sharpP2 - (m.folk2||m.f2||34)).toFixed(1);
      m.hasSharpOdds = true;
      matched++;
    }
  });

  // Visa tabell med sharp-resultat
  if (resultEl) {
    if (matched === 0) {
      resultEl.innerHTML = '<div style="color:#94a3b8;font-size:.85rem;">Inga matcher matchade. Prova att ladda om omg√•ngen.</div>';
    } else {
      resultEl.innerHTML = `<div style="font-size:.82rem;color:#1e3a8a;font-weight:700;margin-bottom:8px;">Sharp-odds matchade ${matched}/${MATCHES.length} matcher ‚Äî visas i matchkorten (üåê-ikon)</div>`;
    }
    resultEl.style.display = 'block';
  }
  recalc(); renderMatches(); renderTopptips();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üîµ KRYSS-BOOST (X systematiskt underv√§rderat av folket)
//  Forskning: folk%-andelen f√∂r X √§r i snitt ~5-8pp l√§gre √§n empirisk sannolikhet
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// XBOOST_ACTIVE declared at top of script (var, to avoid TDZ)

function applyXBoost() {
  XBOOST_ACTIVE = document.getElementById('xboost-toggle')?.checked || false;
  // R√§kna om derived (X-boost justerar vg-ber√§kningar)
  computeMatchDerived(MATCHES);
  applyEloToMatches();
  recalc(); renderMatches(); renderTopptips();
  showToast(XBOOST_ACTIVE ? 'üîµ Kryss-boost aktiverad ‚Äî X uppjusterad med +15%' : 'üîµ Kryss-boost avaktiverad');
}

// H√§mtar justerad X-sannolikhet (med boost om aktiv)
function getAdjustedPX(m) {
  if (!XBOOST_ACTIVE) return m.epx || m.xpx || 33;
  return Math.min(99, (m.epx || m.xpx || 33) * 1.15);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Uppdaterar computeBestEVRow att anv√§nda X-boost
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origComputeBestEVRow = computeBestEVRow;
function computeBestEVRow() {
  if (!MATCHES || !MATCHES.length) return null;
  let totalRatio = 1;
  const row = MATCHES.map(m => {
    const r1 = (m.xp1||33) / (m.folk1||m.f1||33);
    const rxRaw = (m.xpx||33) / (m.folkX||m.fx||33);
    const rX = XBOOST_ACTIVE ? rxRaw * 1.15 : rxRaw;
    const r2 = (m.xp2||34) / (m.folk2||m.f2||34);
    const best = Math.max(r1, rX, r2);
    totalRatio *= best;
    return best === r1 ? '1' : best === rX ? 'X' : '2';
  });
  return { row, ratio: totalRatio };
}

// Returnerar ett konfidenspo√§ng 1‚Äì10 baserat p√• v√§rdegap och marknadsdata
function confScore(m) {
  let s = 5;
  if      (m.bestVg >= 9)  s += 3;
  else if (m.bestVg >= 6)  s += 2;
  else if (m.bestVg >= 3)  s += 1;
  if (m.antiFolk)          s -= 2;
  const marg = (1/m.o1 + 1/m.ox + 1/m.o2 - 1) * 100;
  if (marg > 18)           s -= 1;
  return Math.max(1, Math.min(10, Math.round(s)));
}

// Returnerar HTML f√∂r v√§rde-indikator-sektionen under varje matchkort
function spelanalysHtml(m) {
  const signs = [
    { s:'1', lbl:'Hemma', vg:m.vg1, folk:m.f1 },
    { s:'X', lbl:'Kryss', vg:m.vgx, folk:m.fx },
    { s:'2', lbl:'Borta', vg:m.vg2, folk:m.f2 },
  ];
  const understr = signs.filter(r => r.vg >= 3);
  const overstr  = signs.filter(r => r.vg <= -5);
  const maxFolk  = Math.max(m.f1, m.fx, m.f2);
  const fav      = signs.find(r => r.folk === maxFolk);
  const isOpen   = maxFolk < 38;

  let parts = [];

  if (understr.length) {
    const s = understr.map(r => `${r.s} (+${r.vg}%)`).join(' och ');
    parts.push(`${s} ${understr.length > 1 ? '√§r understreckat' : '√§r understreckat'} ‚Äî k√∂pl√§ge`);
  }
  if (overstr.length) {
    parts.push(`${overstr.map(r=>r.lbl).join('/')} √∂verstreckat ‚Äî undvik`);
  }
  if (m.antiFolk) {
    parts.push('Ovantat utfall m√∂jligt ‚Äî gardera g√§rna');
  } else if (isOpen) {
    parts.push('√ñppen match utan tydlig favorit');
  } else if (!understr.length && !overstr.length && fav) {
    parts.push(`${fav.lbl} klar favorit (${maxFolk}%) ‚Äî priset ser rimligt ut`);
  }
  if (!parts.length) parts.push('Marknadspris n√§ra kalkyl ‚Äî v√§lj p√• magk√§nsla');

  const score = confScore(m);
  const confCls = score >= 7 ? 'sa-conf-hi' : score >= 4 ? 'sa-conf-md' : 'sa-conf-lo';
  const confTxt = score >= 7 ? 'üî• Tydlig' : score >= 4 ? '‚úÖ Okej' : 'üìä Os√§ker';

  return `<div class="mc-analyse">
    <div class="mc-analyse-body">${parts.join('. ')}.</div>
    <span class="mc-analyse-conf ${confCls}">${confTxt}</span>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER MATCHER ‚Äî PREMIUM DESIGN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const OPTS=['1','X','2','1X','X2','12','1X2'];
const OPT_TIPS={'1':'Hemma','X':'Kryss','2':'Borta','1X':'Hem/Kr','X2':'Kr/Bor','12':'Hem/Bor','1X2':'Alla tre'};

function mcOutcomeBtn(m, sel, i, sign) {
  const poissonMap = { '1': m.poissonP1, 'X': m.poissonPX, '2': m.poissonP2 };
  const dataMap = {
    '1': { odds:m.o1, folk:m.folk1||m.f1||33, vg:m.vg1 },
    'X': { odds:m.ox, folk:m.folkX||m.fx||33, vg:m.vgx },
    '2': { odds:m.o2, folk:m.folk2||m.f2||34, vg:m.vg2 },
  };
  const d = dataMap[sign];
  const selected = sel.has(sign);
  const selCls = selected ? ` sel-${sign}` : '';
  const vgCls  = d.vg >= 3 ? 'vg-chip-pos' : d.vg <= -4 ? 'vg-chip-neg' : 'vg-chip-neu';
  const vgSign = d.vg > 0 ? '+' : '';
  const vgChip = `<span class="vg-chip ${vgCls}">${vgSign}${d.vg}%</span>`;

  // Kelly-kriteriet: (p√óodds ‚àí 1) / (odds ‚àí 1) ¬∑ baserat p√• Poisson-sannolikhet
  let kellyHtml = '';
  if (m.hasPoissonData && poissonMap[sign] !== undefined) {
    const p = poissonMap[sign] / 100;
    const kelly = (p * d.odds - 1) / (d.odds - 1);
    const kPct = +(kelly * 100).toFixed(1);
    const kCls = kPct >= 3 ? 'color:#16a34a;font-weight:800;' : kPct >= 0 ? 'color:#94a3b8;' : 'color:#dc2626;';
    const kSign = kPct > 0 ? '+' : '';
    kellyHtml = `<div style="font-size:.62rem;${kCls}margin-top:1px;">Kelly ${kSign}${kPct}%</div>`;
  }

  return `<button class="mc-btn mc-btn-${sign}${selCls}" onclick="toggleSignSimple(${i},'${sign}')">
    <div class="mc-sign">${sign}</div>
    <div class="mc-odds">${d.odds.toFixed(2)}</div>
    <div class="mc-bar-wrap"><div class="mc-bar-fill" style="width:${Math.min(d.folk,100)}%"></div></div>
    <div class="mc-folk-row"><span class="mc-folk">${d.folk}%</span>${vgChip}</div>
    ${kellyHtml}
  </button>`;
}

function mcSelBadge(sel) {
  const arr = [...sel].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b));
  const key = arr.join('');
  const labels = {'1':'Hemma','X':'Kryss','2':'Borta'};
  const txt = arr.map(s=>labels[s]).join(' + ');
  return `<span class="mc-sel-badge">${key} ‚Äî ${txt}${sel.size>1?' (Gardering)':''}</span>`;
}

function mcInfoStrip(m) {
  const hasInfo = m.liga || m.startTime;
  const f1 = m.folk1||m.f1||33, fx = m.folkX||m.fx||33, f2 = m.folk2||m.f2||34;
  const driftBadge = m.hasDrift ? (() => {
    const parts=[];
    if(Math.abs(m.drift1)>=0.1) parts.push(`1${m.drift1>0?'‚Üë':'‚Üì'}${Math.abs(m.drift1).toFixed(2)}`);
    if(Math.abs(m.driftX)>=0.1) parts.push(`X${m.driftX>0?'‚Üë':'‚Üì'}${Math.abs(m.driftX).toFixed(2)}`);
    if(Math.abs(m.drift2)>=0.1) parts.push(`2${m.drift2>0?'‚Üë':'‚Üì'}${Math.abs(m.drift2).toFixed(2)}`);
    return `<span class="badge-drift">‚ö° ${parts.join(' ')}</span>`;
  })() : '';
  const infoRow = (hasInfo||m.hasDrift) ? `<div class="mc-info">
    ${m.flag?`<span>${m.flag}</span>`:''}
    ${m.liga?`<span class="mc-liga-tag">${m.liga}</span>`:''}
    ${m.startTime?`<span class="mc-time">üïê ${m.startTime}</span>`:''}
    ${driftBadge}
  </div>` : '';
  // F√§rgad folk-bar + procentetiketter
  const folkBar = `<div class="mc-folk-bar-row">
    <div class="mc-folk-1" style="flex:${f1}"></div>
    <div class="mc-folk-x" style="flex:${fx}"></div>
    <div class="mc-folk-2" style="flex:${f2}"></div>
  </div>
  <div style="display:flex;justify-content:space-between;margin:0 14px 5px;font-size:.68rem;font-weight:700;">
    <span style="color:#2563eb">1: ${f1}%</span>
    <span style="color:#64748b">X: ${fx}%</span>
    <span style="color:#d97706">2: ${f2}%</span>
  </div>`;
  // Elo-sektion (alltid synlig om data finns)
  let eloRow = '';
  if (m.hasElo) {
    const eH = Math.round(m.eloHome), eA = Math.round(m.eloAway);
    const diff = eH - eA;
    // Styrkabar: hemma-andel av total Elo (visuellt)
    const total = eH + eA;
    const homePct = Math.round(eH / total * 100);
    const awayPct = 100 - homePct;
    const barColor  = diff > 100 ? '#22c55e' : diff < -100 ? '#f87171' : '#94a3b8';
    const diffLabel = diff > 50  ? `<b style="color:#22c55e">Hemma favorit +${diff}</b>`
                    : diff < -50 ? `<b style="color:#f87171">Borta favorit +${Math.abs(diff)}</b>`
                    : `<b style="color:#94a3b8">J√§mnt match</b>`;
    // Varna om Elo och folk kraftigt oense (>12pp avvikelse i blandad modell)
    const maxDis = Math.max(Math.abs(m.blendVg1||0), Math.abs(m.blendVgX||0), Math.abs(m.blendVg2||0));
    const warn = maxDis > 12
      ? `<div style="margin:4px 14px 0;padding:4px 10px;background:#fef3c7;border-radius:6px;font-size:.7rem;font-weight:700;color:#92400e;">‚ö†Ô∏è Elo och folk% √§r kraftigt oense ‚Äî potentiellt v√§rde!</div>`
      : '';
    eloRow = `
    <div style="background:#f1f5f9;margin:4px 10px 6px;border-radius:10px;padding:8px 12px;">
      <div style="font-size:.68rem;font-weight:800;color:#64748b;text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;">‚öΩ Lagstyrka (Elo)</div>
      <div style="display:flex;justify-content:space-between;font-size:.78rem;font-weight:700;margin-bottom:4px;">
        <span style="color:#1e40af;">${m.home} <span style="font-size:.9em;color:#64748b;">${eH}</span></span>
        <span style="color:#64748b;font-size:.7rem;">${diffLabel}</span>
        <span style="color:#b45309;">${m.away} <span style="font-size:.9em;color:#64748b;">${eA}</span></span>
      </div>
      <div style="height:7px;border-radius:4px;background:#e2e8f0;overflow:hidden;margin-bottom:5px;">
        <div style="height:100%;width:${homePct}%;background:${barColor};border-radius:4px;transition:width .4s;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:.68rem;color:#64748b;">
        <span>Elo-sannolikhet: <b>1: ${m.eloP1}%</b></span>
        <span><b>X: ${m.eloPX}%</b></span>
        <span><b>2: ${m.eloP2}%</b></span>
      </div>
    </div>${warn}`;
  }

  // Sharp/Pinnacle-sektion (visas om data finns)
  let sharpRow = '';
  if (m.hasSharpOdds) {
    const f1 = m.folk1||m.f1||33, fx=m.folkX||m.fx||33, f2=m.folk2||m.f2||34;
    const badge = (p, folk) => {
      const d = +(p - folk).toFixed(1);
      const cls = d >= 3 ? 'color:#065f46;background:#d1fae5' : d <= -3 ? 'color:#991b1b;background:#fee2e2' : 'color:#64748b;background:#f1f5f9';
      return `<span style="font-size:.66rem;font-weight:700;border-radius:4px;padding:1px 5px;${cls}">${d>0?'+':''}${d}%</span>`;
    };
    sharpRow = `<div style="background:#faf5ff;margin:2px 10px 6px;border-radius:10px;padding:7px 12px;border-left:3px solid #8b5cf6;">
      <div style="font-size:.65rem;font-weight:800;color:#6d28d9;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">üåê Sharp (Pinnacle/Betfair) vs folk%</div>
      <div style="display:flex;justify-content:space-around;font-size:.76rem;font-weight:700;gap:4px;">
        <span>1: <b>${m.sharpP1}%</b> ${badge(m.sharpP1, f1)}</span>
        <span>X: <b>${m.sharpPX}%</b> ${badge(m.sharpPX, fx)}</span>
        <span>2: <b>${m.sharpP2}%</b> ${badge(m.sharpP2, f2)}</span>
      </div>
    </div>`;
  }

  // Motivationsvarning
  const motivRow = m.lowMotivation
    ? `<div style="background:#fef3c7;margin:2px 10px 6px;border-radius:10px;padding:6px 12px;border-left:3px solid #f59e0b;">
        <span style="font-size:.72rem;font-weight:800;color:#92400e;">‚ö° L√•g motivation markerad ‚Äî favoritens vinstchans nedviktad i Smart system</span>
       </div>`
    : '';

  return infoRow + folkBar + eloRow + sharpRow + motivRow;
}

function generateMatchAnalysis(m) {
  const f1=m.folk1||m.f1||33, fx=m.folkX||m.fx||33, f2=m.folk2||m.f2||34;
  const vg1=m.vg1||0, vgx=m.vgx||0, vg2=m.vg2||0;
  const bestVg=m.bestVg||0;
  const bestSign=vg1>=vgx&&vg1>=vg2?'1':vgx>=vg2?'X':'2';
  const bestOdds=bestSign==='1'?m.o1:bestSign==='X'?m.ox:m.o2;
  const bestEv=bestSign==='1'?(m.ev1||0):bestSign==='X'?(m.evx||0):(m.ev2||0);
  let parts=[], cls='';

  // Regler direkt fr√•n Ytterberg-uppsatsen
  if(m.spike1) {
    parts.push('‚≠ê Spika 1 ‚Äî folket ‚â•89%, hemmavinst alltid i historiken');
    cls='ana-value';
  } else if(m.spike2) {
    parts.push('‚≠ê Spika 2 ‚Äî folket ‚â•81%, bortavinst alltid i historiken');
    cls='ana-value';
  } else if(m.garDen1 && !m.spike1) {
    parts.push(`‚ö†Ô∏è Gardera etta ‚Äî folk ${f1}% (65‚Äì83% √§r s√§msta spikzonen f√∂r ettor)`);
    cls='ana-risk';
  } else if(m.garDen2 && !m.spike2) {
    parts.push(`‚ö†Ô∏è Gardera tv√•a ‚Äî folk ${f2}% (55‚Äì66% √§r s√§msta spikzonen f√∂r tv√•or)`);
    cls='ana-risk';
  } else if(m.antiFolk) {
    const dom=f1>=fx&&f1>=f2?'1':fx>=f2?'X':'2';
    const domPct=Math.max(f1,fx,f2);
    parts.push(`üîÄ Folket streckar ${dom} med ${domPct}% men modellen ger l√§gre sannolikhet ‚Äî potentiell skr√§ll`);
    cls='ana-contra';
  } else if(m.valueX) {
    parts.push(`‚úÖ Kryss underv√§rdat av folket (${fx}% ‚â§30%) ‚Äî systematisk bias enligt modellen`);
    cls='ana-value';
  } else if(bestVg>=5) {
    parts.push(`‚≠ê ${bestSign} understreckat med +${bestVg}% ‚Äî modell vs folk (odds ${bestOdds.toFixed(2)})`);
    cls='ana-value';
  } else if(bestEv>1.05) {
    parts.push(`‚úÖ EV ${(bestEv*100-100).toFixed(1)}% p√• ${bestSign} mot fasta odds ‚Äî positivt f√∂rv√§ntningsv√§rde`);
    cls='ana-value';
  } else if(m.hasDrift) {
    const dSign=Math.abs(m.drift1||0)>=Math.abs(m.driftX||0)&&Math.abs(m.drift1||0)>=Math.abs(m.drift2||0)?'1':Math.abs(m.driftX||0)>=Math.abs(m.drift2||0)?'X':'2';
    const dVal=dSign==='1'?m.drift1:dSign==='X'?m.driftX:m.drift2;
    parts.push(`‚ö° Oddsdrift p√• ${dSign}: ${dVal>0?'+':''}${(dVal||0).toFixed(2)} sedan √∂ppning`);
    cls='ana-risk';
  } else {
    const fav=f1>fx&&f1>f2?'Hemmalag':f2>f1&&f2>fx?'Bortalag':'√ñppen match';
    parts.push(`‚ÑπÔ∏è ${fav} ‚Äî inga starka modellsignaler. V√§lj p√• matchk√§nsla.`);
  }
  return `<div class="mc-analysis ${cls}">${parts.join(' ¬∑ ')}</div>`;
}

// Knuth-algoritm f√∂r Poisson-sampling ‚Äî snabb och exakt
function _samplePoisson(lambda) {
  if (lambda <= 0) return 0;
  const L = Math.exp(-lambda);
  let k = 0, p = 1;
  do { k++; p *= Math.random(); } while (p > L);
  return k - 1;
}

function mcSimPanel(m, i) {
  return `<div class="mc-sim-panel" id="sim-panel-${i}">
    <div class="mc-sim-title">üé≤ Poisson Monte Carlo ‚Äî 1 000 000 simuleringar</div>
    <div id="sim-results-${i}" style="font-size:.75rem;color:#64748b;padding:6px 0;">
      √ñppnar panelen k√∂r simuleringen automatiskt‚Ä¶
    </div>
  </div>`;
}

function toggleMatchSim(i) {
  const panel = document.getElementById('sim-panel-'+i);
  const btn   = document.getElementById('sim-btn-'+i);
  if (!panel) return;
  const open = panel.classList.toggle('open');
  if (btn) btn.classList.toggle('active', open);
  if (open) runMatchSim(i);
}

function runMatchSim(i) {
  const m = MATCHES[i];
  const el = document.getElementById('sim-results-' + i);
  if (!el) return;

  const lH = m.poissonLH || 1.5;
  const lA = m.poissonLA || 1.0;
  const f1 = m.folk1 || m.f1 || 33;
  const fx = m.folkX || m.fx || 33;
  const f2 = m.folk2 || m.f2 || 34;

  el.innerHTML = '<span style="color:#94a3b8">‚è≥ Simulerar 1 000 000 matcher‚Ä¶</span>';

  // K√∂r i n√§sta tick s√• UI hinner uppdateras
  setTimeout(() => {
    const N = 1_000_000;
    let c1 = 0, cx = 0, c2 = 0;
    const scorelines = {};

    for (let s = 0; s < N; s++) {
      const gh = _samplePoisson(lH);
      const ga = _samplePoisson(lA);
      if      (gh > ga) c1++;
      else if (gh === ga) cx++;
      else                c2++;
      // Spara scorelines upp till 5-5
      if (gh <= 5 && ga <= 5) {
        const key = gh + '-' + ga;
        scorelines[key] = (scorelines[key] || 0) + 1;
      }
    }

    const p1s = +(c1/N*100).toFixed(1);
    const pxs = +(cx/N*100).toFixed(1);
    const p2s = +(c2/N*100).toFixed(1);

    // J√§mf√∂relsev√§rden
    const pBar = (pct, ref, col) => {
      const vg = +(pct - ref).toFixed(1);
      const vgCls = vg >= 2 ? 'color:#16a34a;' : vg <= -2 ? 'color:#dc2626;' : 'color:#94a3b8;';
      const sign = vg > 0 ? '+' : '';
      return `<div style="display:grid;grid-template-columns:18px 1fr 46px 46px;gap:4px;align-items:center;margin-bottom:3px;">
        <b style="font-size:.8rem;">${col}</b>
        <div style="background:#e2e8f0;border-radius:4px;height:8px;overflow:hidden;">
          <div style="width:${Math.min(pct,100)}%;height:100%;background:${col==='1'?'#3b82f6':col==='X'?'#8b5cf6':'#f59e0b'};border-radius:4px;"></div>
        </div>
        <span style="font-size:.78rem;font-weight:700;">${pct}%</span>
        <span style="font-size:.72rem;font-weight:700;${vgCls}">${sign}${vg}%</span>
      </div>`;
    };

    // Top 8 scorelines
    const top = Object.entries(scorelines)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 8)
      .map(([sc, cnt]) => {
        const pct = +(cnt/N*100).toFixed(1);
        const [gh, ga] = sc.split('-').map(Number);
        const res = gh > ga ? '1' : gh === ga ? 'X' : '2';
        const clr = res==='1'?'#1e40af':res==='X'?'#4c1d95':'#92400e';
        const bg  = res==='1'?'#dbeafe':res==='X'?'#ede9fe':'#fef3c7';
        return `<span style="background:${bg};color:${clr};border-radius:6px;padding:2px 7px;font-size:.73rem;font-weight:800;">${sc} <span style="font-weight:500">${pct}%</span></span>`;
      }).join('');

    el.innerHTML = `
      <div style="font-size:.68rem;font-weight:700;color:#475569;margin-bottom:5px;">
        Resultat vs folk% (avvikelse = Sim ‚àí Folk)
      </div>
      ${pBar(p1s, f1, '1')}
      ${pBar(pxs, fx, 'X')}
      ${pBar(p2s, f2, '2')}
      <div style="font-size:.68rem;color:#94a3b8;margin:6px 0 4px;">
        Œª hem ${lH} ¬∑ Œª borta ${lA} ¬∑ Dixon-Coles korrigerat
      </div>
      <div style="font-size:.68rem;font-weight:700;color:#475569;margin-bottom:4px;">Vanligaste slutresultat:</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">${top}</div>
      <div style="font-size:.63rem;color:#94a3b8;margin-top:5px;">n = 1 000 000 simuleringar</div>
    `;
  }, 10);
}

function renderMatches() {
  const sortedIdxs = typeof getSortedIndices === 'function' ? getSortedIndices() : MATCHES.map((_,i)=>i);
  document.getElementById('match-list').innerHTML = sortedIdxs.map((i)=>{
    const m=MATCHES[i];
    const sel=selections[i];
    // Kontrariansk: odds-favorit ‚â† folk-favorit ‚Üí sp√§nnande match
    const oddsFav = m.o1<m.ox&&m.o1<m.o2?'1': m.ox<m.o2?'X':'2';
    const folkFav = m.folk1>m.folkX&&m.folk1>m.folk2?'1': m.folkX>m.folk2?'X':'2';
    const isContrarian = oddsFav!==folkFav && m.folk1&&m.folk2;
    const cardCls = m.antiFolk?'risky-match': isContrarian?'contrarian-match': m.bestVg>=4?'value-match':'';
    const sp = xpSport[i];
    const hasCustom = sp.s1!==null||sp.sx!==null||sp.s2!==null;
    let badges='';
    if(m.bestVg>=6)  badges+=`<span class="badge badge-value">‚≠ê Bra odds!</span>`;
    else if(m.bestVg>=3) badges+=`<span class="badge badge-value">‚úÖ Okej odds</span>`;
    if(m.antiFolk)     badges+=`<span class="badge badge-folk">‚ö†Ô∏è Os√§ker match</span>`;
    if(isContrarian)   badges+=`<span class="badge-contrarian">üîÄ Kontrarisk</span>`;
    if(m.isDrawLikely) badges+=`<span style="background:#ede9fe;color:#4c1d95;border-radius:12px;padding:2px 8px;font-size:.68rem;font-weight:800;">üîµ Kryss-l√§ge${m.drawScore===3?' ‚≠ê':''}</span>`;
    return `
<div class="match-card ${cardCls}" id="card-${i}">
  <div class="mc-head">
    <div class="match-num">${i+1}</div>
    <div class="match-badges">${badges}</div>
  </div>
  <div class="mc-teams">
    <div class="mc-team home">${m.home}</div>
    <div class="mc-vs">VS</div>
    <div class="mc-team away">${m.away}</div>
  </div>
  ${mcInfoStrip(m)}
  <div class="mc-outcomes" id="outcomes-${i}">
    ${mcOutcomeBtn(m,sel,i,'1')}
    ${mcOutcomeBtn(m,sel,i,'X')}
    ${mcOutcomeBtn(m,sel,i,'2')}
  </div>
  ${generateMatchAnalysis(m)}
  ${mcSimPanel(m,i)}
  ${mcPoissonPanel(m,i)}
  <div class="mc-footer">
    <div id="selbadge-${i}">${mcSelBadge(sel)}</div>
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
      <button class="mc-sim-btn" id="sim-btn-${i}" onclick="toggleMatchSim(${i})">üìä Sim</button>
      <button class="mc-poisson-btn${m.hasPoissonData?' active':''}" id="poisson-btn-${i}" onclick="togglePoissonPanel(${i})">üé≤ Poisson${m.hasPoissonData?' ‚úì':''}</button>
      <button class="sport-toggle${hasCustom?' active':''}" id="sport-toggle-${i}" onclick="toggleSportInput(${i})">üìê Egna${hasCustom?' ‚úì':''}</button>
      <span class="motiv-badge${m.lowMotivation?' active':''}" onclick="toggleMotivation(${i})" title="Markera om laget spelar utan motivation">‚ö°${m.lowMotivation?' L√•g motiv.':' Motivation?'}</span>
    </div>
  </div>
  <div class="sport-input-row${hasCustom?' open':''}" id="sport-row-${i}" style="margin:0 16px 12px;">
    <div class="sport-field"><label>1 %</label><input type="number" id="sp1-${i}" min="0" max="100" step="1" placeholder="‚Äì" value="${sp.s1!==null?sp.s1:''}" oninput="updateSportInput(${i})"></div>
    <div class="sport-field"><label>X %</label><input type="number" id="spX-${i}" min="0" max="100" step="1" placeholder="‚Äì" value="${sp.sx!==null?sp.sx:''}" oninput="updateSportInput(${i})"></div>
    <div class="sport-field"><label>2 %</label><input type="number" id="sp2-${i}" min="0" max="100" step="1" placeholder="‚Äì" value="${sp.s2!==null?sp.s2:''}" oninput="updateSportInput(${i})"></div>
    <div class="sport-hint">Ange dina egna % (t.ex. 50 / 30 / 20).<br>Blandar 65% odds-kalkyl + 35% ditt svar.</div>
  </div>
</div>`;
  }).join('');
}

// Ny enkel toggle: klicka 1/X/2 f√∂r att toggla
function toggleSignSimple(matchIdx, sign) {
  const sel = selections[matchIdx];
  if (sel.has(sign)) {
    if (sel.size > 1) sel.delete(sign); // kan inte ha 0 valda
  } else {
    sel.add(sign);
  }
  renderCard(matchIdx); recalc();
}

function renderCard(i) {
  const m=MATCHES[i], sel=selections[i];
  const out = document.getElementById('outcomes-'+i);
  if (out) out.innerHTML = mcOutcomeBtn(m,sel,i,'1')+mcOutcomeBtn(m,sel,i,'X')+mcOutcomeBtn(m,sel,i,'2');
  const sb = document.getElementById('selbadge-'+i);
  if (sb) sb.innerHTML = mcSelBadge(sel);
}

// Bak√•tkompatibel toggleSign (anv√§nds av auto-knappar)
function toggleSign(matchIdx, opt) {
  const signs=[...opt], sel=selections[matchIdx];
  if(signs.every(s=>sel.has(s))&&sel.size===signs.length) return;
  sel.clear(); signs.forEach(s=>sel.add(s));
  renderCard(matchIdx); recalc();
}

function badgesHtml(m) {
  let b='';
  if(m.bestVg>=6)      b+=`<span class="badge badge-value">‚≠ê Bra v√§rde!</span>`;
  else if(m.bestVg>=3) b+=`<span class="badge badge-value">‚úÖ Okej v√§rde</span>`;
  if(m.antiFolk)       b+=`<span class="badge badge-folk">‚ö†Ô∏è Ov√§ntat m√∂jligt</span>`;
  return b;
}

function signBtns(i,sel) { return ''; } // inte l√§ngre anv√§nds ‚Äî men beh√•lls f√∂r kompatibilitet

function oddsHtml(m, sel, matchIdx) {
  const mx=Math.max(m.xp1,m.xpx,m.xp2);
  const fd = (FORM_DATA && matchIdx!==undefined && FORM_DATA[matchIdx]) ? FORM_DATA[matchIdx] : null;
  return [
    {lbl:'Hemma vinner',sign:'1',odds:m.o1,folk:m.f1,xp:m.xp1,vg:m.vg1, fp: fd?fd.fp1:null},
    {lbl:'Oavgjort',    sign:'X',odds:m.ox,folk:m.fx,xp:m.xpx,vg:m.vgx, fp: fd?fd.fpx:null},
    {lbl:'Borta vinner',sign:'2',odds:m.o2,folk:m.f2,xp:m.xp2,vg:m.vg2, fp: fd?fd.fp2:null},
  ].map(o=>{
    const fav    = o.xp===mx;
    const chosen = sel && sel.has(o.sign);
    const cls    = chosen?' odds-selected':(fav?' odds-fav':'');
    let vgTxt='';
    if     (o.vg>=8)  vgTxt=`üìà Mycket understreckat! (+${o.vg})`;
    else if(o.vg>=3)  vgTxt=`üìà Understreckat (+${o.vg})`;
    else if(o.vg<=-5) vgTxt=`üìâ √ñverstreckat (${o.vg})`;
    // Formindikator
    let formTxt='';
    if (o.fp !== null) {
      const diff = o.fp - o.xp;
      if      (diff >= 8)  formTxt=`‚öΩ Form st√∂der starkt (+${diff.toFixed(0)}%)`;
      else if (diff >= 3)  formTxt=`‚öΩ Form st√∂der (+${diff.toFixed(0)}%)`;
      else if (diff <= -5) formTxt=`‚öΩ Form emot (${diff.toFixed(0)}%)`;
    }
    return `<div class="odds-item${cls}">
  <div class="odds-sign">${o.lbl}${chosen?' ‚úì':''}</div>
  <div class="odds-val">${o.odds.toFixed(2)}</div>
  <div class="odds-folk">${o.folk}% tror detta</div>
  ${o.fp!==null?`<div class="odds-folk" style="color:#0369a1;">‚öΩ Form: ${o.fp}%</div>`:''}
  ${vgTxt?`<div class="odds-vg ${o.vg>=3?'vg-pos':'vg-neg'}">${vgTxt}</div>`:''}
  ${formTxt?`<div class="odds-vg ${formTxt.includes('emot')?'vg-neg':'vg-pos'}" style="font-size:.67rem;">${formTxt}</div>`:''}
</div>`;
  }).join('');
}

// Gamla versioner borttagna ‚Äì nya renderCard/toggleSign/signBtns ovan anv√§nds

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SPORT-INPUT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSportInput(i) {
  const row = document.getElementById('sport-row-'+i);
  const btn = document.getElementById('sport-toggle-'+i);
  const open = row.classList.toggle('open');
  btn.classList.toggle('active', open);
}

function updateSportInput(i) {
  const v1 = parseFloat(document.getElementById('sp1-'+i).value);
  const vx = parseFloat(document.getElementById('spX-'+i).value);
  const v2 = parseFloat(document.getElementById('sp2-'+i).value);
  xpSport[i].s1 = isNaN(v1) ? null : v1;
  xpSport[i].sx = isNaN(vx) ? null : vx;
  xpSport[i].s2 = isNaN(v2) ? null : v2;
  const hasAll = xpSport[i].s1!==null && xpSport[i].sx!==null && xpSport[i].s2!==null;
  const btn = document.getElementById('sport-toggle-'+i);
  if (btn) {
    btn.classList.toggle('active', hasAll);
    btn.textContent = 'üìê Egna odds' + (hasAll ? ' ‚úì' : '');
  }
  recalc();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KNAPPAR: Rekommenderat / V√§rde
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyRecommended() {
  MATCHES.forEach((m,i)=>{ selections[i]=defaultSel(m); });
  saveSelections(); renderMatches(); recalc();
}
function applyValueBets() {
  MATCHES.forEach((m,i)=>{
    const mv=Math.max(m.vg1,m.vgx,m.vg2);
    if(mv>=3) selections[i]=new Set([mv===m.vg1?'1':mv===m.vgx?'X':'2']);
    else { const mx=Math.max(m.xp1,m.xpx,m.xp2); selections[i]=new Set([mx===m.xp1?'1':mx===m.xpx?'X':'2']); }
  });
  saveSelections(); renderMatches(); recalc();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  F√ñRKLARA VALEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let explainOpen = false;
function toggleExplain() {
  const panel = document.getElementById('explain-panel');
  if (explainOpen) { panel.style.display='none'; explainOpen=false; return; }

  const lines = MATCHES.map((m,i) => {
    const sel = selections[i];
    const selArr = [...sel];
    const key = selArr.sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');

    // V√§lj tecknet med b√§st xP bland valda
    const bestSign = selArr.reduce((best,s) => {
      const xp = s==='1'?m.xp1:s==='X'?m.xpx:m.xp2;
      const bxp= best==='1'?m.xp1:best==='X'?m.xpx:m.xp2;
      return xp>bxp?s:best;
    }, selArr[0]);
    const mainXp  = bestSign==='1'?m.xp1:bestSign==='X'?m.xpx:m.xp2;
    const mainVg  = bestSign==='1'?m.vg1:bestSign==='X'?m.vgx:m.vg2;
    const signName= bestSign==='1'?'hemmavinst':bestSign==='X'?'kryss':'bortavinst';

    let cls='e-half', typeLabel='Halvgardering';
    if(sel.size===1){ cls='e-lock'; typeLabel='Spikad'; }
    if(sel.size===3){ cls='e-full'; typeLabel='Helgardering'; }

    let reason = '';
    if(m.antiFolk) {
      reason = `‚ö†Ô∏è Folket streckar h√•rt men oddsen s√§ger annorlunda ‚Äî gardering rekommenderas.`;
    } else if(sel.size===1) {
      reason = `Odds-kalkylen ger ${signName} ${mainXp}% sannolikhet ‚Äî tillr√§ckligt tydligt f√∂r att spika.`;
      if(mainVg>=3) reason += ` Dessutom understreckat (+${mainVg}) = b√§ttre utdelning om r√§tt!`;
    } else if(sel.size===2) {
      reason = `Matchen √§r j√§mn, ${signName} leder med ${mainXp}% sannolikhet men inte tillr√§ckligt f√∂r att spika.`;
    } else {
      reason = `Sv√•r match ‚Äî alla tre utfall √§r m√∂jliga. Helgardering ger s√§kerhet.`;
    }

    return `<div class="erow"><span class="${cls}">${i+1}. ${m.home} vs ${m.away} ‚Üí <strong>${key}</strong> (${typeLabel})</span><br><span style="font-size:.85rem;color:#555;margin-left:16px;">${reason}</span></div>`;
  }).join('');

  const st = calcStats();
  panel.innerHTML = `<h4>üí¨ Varf√∂r ser raden ut s√•h√§r?</h4>${lines}
    <div style="margin-top:12px;padding-top:10px;border-top:1px solid #e1bee7;font-size:.85rem;color:#6a1b9a;">
      <strong>Sammanfattning:</strong> Din rad har ${st.rows.toLocaleString('sv')} rader och chansen att vinna √§r ${fmtChance(st.p13)}.
      ${st.rows===1?'En enda rad ‚Äì billigt men l√§gre chans.':st.rows<=8?'Lagom gardering ‚Äì bra balans mellan kostnad och chans.':'Stor gardering ‚Äì h√∂g kostnad men b√§ttre chans.'}
    </div>`;
  panel.style.display='block';
  explainOpen=true;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DELA / KOPIERA RAD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shareRow() {
  const rad = selections.map((s,i) => {
    const key=[...s].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
    return `${i+1}.${key}`;
  }).join(' ');
  const st  = calcStats();
  const price=parseFloat(document.getElementById('price-input').value)||1;
  const text = `üèÜ ${ROUND} ‚Äì Min Stryktips-rad:\n${rad}\nChans: ${fmtChance(st.p13)} ¬∑ ${st.rows} rader ¬∑ ${(st.rows*price).toLocaleString('sv')} kr`;

  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(()=>showToast('‚úÖ Raden kopierades till urklipp!')).catch(()=>fallbackCopy(text));
  } else { fallbackCopy(text); }
}
function fallbackCopy(text) {
  const ta=document.createElement('textarea'); ta.value=text;
  document.body.appendChild(ta); ta.select(); document.execCommand('copy');
  document.body.removeChild(ta); showToast('‚úÖ Raden kopierades!');
}
function showToast(msg) {
  const t=document.getElementById('share-toast'); t.textContent=msg;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HISTORIK
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HIST_KEY = 'stryktips_historik';

function loadHistory() { try { return JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); } catch{return[];} }
function saveHistory(h) { localStorage.setItem(HIST_KEY, JSON.stringify(h)); }

function saveToHistory() {
  const h = loadHistory();
  const rad = selections.map(s=>[...s].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join(''));
  const st  = calcStats();
  const price=parseFloat(document.getElementById('price-input').value)||1;
  h.unshift({ round:ROUND, date:new Date().toLocaleDateString('sv-SE'), rad, rows:st.rows, cost:+(st.rows*price).toFixed(0), p13:+st.p13.toFixed(6) });
  if(h.length>30) h.pop();
  saveHistory(h);
  showToast('üíæ Raden sparades till historiken!');
  renderHistory();
}

function deleteHistory(idx) {
  const h=loadHistory(); h.splice(idx,1); saveHistory(h); renderHistory();
}

function renderHistory() {
  const h=loadHistory();
  const list=document.getElementById('hist-list');
  if(!h.length) {
    list.innerHTML='<div id="hist-empty" style="text-align:center;padding:48px 20px 36px;">' +
      '<div style="font-size:3rem;margin-bottom:12px;">üìÖ</div>' +
      '<div style="font-size:1rem;font-weight:800;color:#334155;margin-bottom:8px;">Inga sparade omg√•ngar √§n</div>' +
      '<div style="font-size:.87rem;color:#94a3b8;max-width:280px;margin:0 auto 18px;">Spela en omg√•ng och klicka <strong>üíæ Spara</strong> i Kupong-fliken f√∂r att b√∂rja bygga din historik.</div>' +
      '<button onclick="showTab(\'kupong\')" style="background:#dbeafe;color:#1e3a8a;border:none;border-radius:12px;padding:10px 22px;font-size:.88rem;font-weight:700;cursor:pointer;">üìã G√• till kupong ‚Üí</button>' +
      '</div>';
    return;
  }
  list.innerHTML = h.map((e,i)=>{
    const chips = e.rad.map((key,j)=>`<div class="rad-chip rc-${key}" style="font-size:.8rem;padding:3px 8px;"><span class="rc-num">${j+1}.</span>${key}</div>`).join('');
    return `<div class="hist-card">
  <div class="hist-top">
    <span class="hist-round">${e.round}</span>
    <span class="hist-date">Sparad ${e.date}</span>
    <button class="hist-del" onclick="deleteHistory(${i})">üóë Ta bort</button>
  </div>
  <div class="hist-chips">${chips}</div>
  <div class="hist-meta">${e.rows} rader ¬∑ ${e.cost} kr ¬∑ Chans: ${fmtChance(e.p13)}</div>
</div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MARGINAL-KALKYL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMarginal() {
  const el = document.getElementById('marg-list');
  if (!el) return;
  const price = parseFloat(document.getElementById('price-input').value) || 1;
  const base  = calcStats();

  const candidates = [];
  MATCHES.forEach((m, i) => {
    const sel = selections[i];
    if (sel.size === 3) return;
    ['1','X','2'].forEach(sign => {
      if (sel.has(sign)) return;
      const newSel  = new Set([...sel, sign]);
      const newSels = selections.map((s,j) => j===i ? newSel : s);
      const newRows = newSels.reduce((a,s)=>a*s.size, 1);
      const extraCost = (newRows - base.rows) * price;
      const newSt  = calcStats(newSels);
      const deltaP = newSt.p13 - base.p13;
      const effic  = extraCost > 0 ? deltaP / extraCost : 0;
      candidates.push({ i, sign, deltaP, extraCost, effic, name: m.home+' vs '+m.away });
    });
  });

  candidates.sort((a,b) => b.effic - a.effic);

  if (!candidates.length) {
    el.innerHTML = '<div id="marg-empty">Alla matcher √§r helgarderade ‚Äì ingenting att l√§gga till!</div>';
    return;
  }

  el.innerHTML = candidates.slice(0, 12).map((c, idx) => {
    const deltaStr  = '+' + (c.deltaP * 100).toFixed(4) + '% chans';
    const costStr   = c.extraCost > 0 ? '+' + c.extraCost.toFixed(0) + ' kr' : 'gratis';
    return `<div class="marg-row">
  <div class="marg-rank">${idx+1}</div>
  <div class="marg-match">${c.i+1}. ${c.name}</div>
  <span class="marg-sign marg-sign-${c.sign}">${c.sign}</span>
  <span class="marg-delta">${deltaStr}</span>
  <span class="marg-cost">${costStr}</span>
  <button class="marg-btn" onclick="applyMarginal(${c.i},'${c.sign}')">+ L√§gg till</button>
</div>`;
  }).join('');
}

function applyMarginal(matchIdx, sign) {
  selections[matchIdx].add(sign);
  renderCard(matchIdx);
  recalc();
  renderMarginal();
  showToast('‚úÖ ' + sign + ' lades till f√∂r match ' + (matchIdx+1));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  BUDGET-OPTIMERARE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runBudgetOptimizer() {
  const budget = parseFloat(document.getElementById('budget-val').value) || 100;
  const price  = parseFloat(document.getElementById('price-input').value) || 1;

  // Starta med billigaste systemet: en spik per match (b√§st xP)
  const sys = MATCHES.map((m,i) => {
    const bp = activeProb(m, i);
    const mx = Math.max(bp.p1, bp.px, bp.p2);
    return new Set([mx===bp.p1?'1':mx===bp.px?'X':'2']);
  });

  function getRows(s)  { return s.reduce((a,x)=>a*x.size, 1); }
  function getP13(s)   {
    const cov = MATCHES.map((m,i)=>{
      const bp = activeProb(m,i);
      return Math.min((s[i].has('1')?bp.p1:0)+(s[i].has('X')?bp.px:0)+(s[i].has('2')?bp.p2:0),1);
    });
    return poissonBinomialPMF(cov)[13];
  }

  // Greedy: hitta b√§sta tecken att l√§gga till per iteration
  for (let iter = 0; iter < 60; iter++) {
    const curP13  = getP13(sys);
    const curRows = getRows(sys);
    let bestGain = -Infinity, bestI = -1, bestSign = null;

    MATCHES.forEach((m, i) => {
      if (sys[i].size === 3) return;
      ['1','X','2'].forEach(sign => {
        if (sys[i].has(sign)) return;
        const testSys  = sys.map((s,j) => j===i ? new Set([...s,sign]) : s);
        const newRows  = getRows(testSys);
        if (newRows * price > budget) return;
        const gain = (getP13(testSys) - curP13) / ((newRows - curRows) * price);
        if (gain > bestGain) { bestGain=gain; bestI=i; bestSign=sign; }
      });
    });

    if (bestI === -1) break;
    sys[bestI].add(bestSign);
  }

  const finalP13   = getP13(sys);
  const finalRows  = getRows(sys);
  const finalCost  = finalRows * price;

  const chips = sys.map((s,i)=>{
    const key=[...s].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
    return `<div class="rad-chip rc-${key}" style="font-size:.78rem;padding:3px 8px;"><span class="rc-num">${i+1}.</span>${key}</div>`;
  }).join('');

  const sysData = JSON.stringify(sys.map(s=>[...s]));
  const res = document.getElementById('budget-result');
  res.innerHTML = `<strong>Optimalt system inom ${budget} kr:</strong><br>
<span style="color:#0369a1;">${finalRows} rader ¬∑ ${finalCost.toFixed(0)} kr ¬∑ Chans: ${fmtChance(finalP13)}</span>
<div class="budget-chips">${chips}</div>
<button class="btn-apply-budget" onclick='applyBudgetSystem(${sysData})'>‚úÖ Anv√§nd detta system</button>`;
  res.classList.add('show');
}

function applyBudgetSystem(sysArr) {
  sysArr.forEach((signs, i) => { selections[i] = new Set(signs); });
  renderMatches();
  recalc();
  showTab('kupong');
  showToast('‚úÖ Budget-systemet har applicerats!');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  JACKPOT-EV-KALKYLATOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runJackpotEV() {
  const jackpot  = parseFloat(document.getElementById('ev-jackpot').value)  || 10e6;
  const nCoupons = parseFloat(document.getElementById('ev-coupons').value)  || 350000;
  const price    = parseFloat(document.getElementById('price-input').value) || 1;
  const st       = calcStats();

  // Ber√§kna "folkpot" ‚Äì genomsnittskupongens P(13 r√§tt) baserat p√• folkstrecket
  // Vi approximerar med att varje spelare tar det mest popul√§ra tecknet per match
  const folkP13 = MATCHES.reduce((prod, m) => {
    const folkMax = Math.max(m.f1, m.fx, m.f2) / 100;
    return prod * folkMax;
  }, 1);

  // Kontr√§r-faktor: hur mycket l√§gre √§r chansen att vi delar j√§mf√∂rt med snittspelaren?
  // Ju mer vi avviker fr√•n folket, desto f√§rre delar vi jackpotten med
  const contrarian = MATCHES.reduce((prod, m, i) => {
    const sel = selections[i];
    // Folkandel f√∂r valda tecken
    const folkCover = ((sel.has('1')?m.f1:0)+(sel.has('X')?m.fx:0)+(sel.has('2')?m.f2:0)) / 100;
    const xpCover   = ((sel.has('1')?m.xp1:0)+(sel.has('X')?m.xpx:0)+(sel.has('2')?m.xp2:0)) / 100;
    return prod * (xpCover > 0 ? folkCover / xpCover : 1);
  }, 1);

  // F√∂rv√§ntade vinnare (av 1-raders kuponger)
  const avgWinners = nCoupons * folkP13;
  // Din f√∂rv√§ntade andel av jackpotten per vinnande rad
  const yourWinners  = st.p13;
  const sharedWith   = avgWinners * contrarian;
  const expectedShare = jackpot / Math.max(sharedWith + yourWinners * st.rows, 1);

  // EV per rad
  const evPerRad = st.p13 * expectedShare;
  const totalEV  = evPerRad * st.rows;
  const totalCost = st.rows * price;
  const evRatio   = totalEV / totalCost;

  // Kontr√§r-score: hur mycket avviker du fr√•n folkmassan?
  // 1.0 = identisk med folket, >1 = kontr√§r (b√§ttre EV)
  const contrScore = (1 / contrarian);

  // Insight-text
  let insight='', insightCls='neut';
  if (evRatio > 1.5) {
    insight = `üéâ Utm√§rkt EV-ratio! Din rad √§r kontr√§r nog att du i snitt f√∂rv√§ntas f√• tillbaka ${(evRatio*100).toFixed(0)}% av insatsen. Det √§r bra f√∂r poolspel.`;
    insightCls = 'good';
  } else if (evRatio > 0.7) {
    insight = `üëç Godk√§nd EV-ratio. Du delar f√∂rmodligen jackpotten med ${sharedWith.toFixed(1)} vinnare i snitt. Mer kontr√§ra tecken kan f√∂rb√§ttra detta.`;
    insightCls = 'neut';
  } else {
    insight = `‚ö†Ô∏è L√•g EV-ratio. Din rad liknar mycket folkmassan ‚Äî om du vinner delar du med m√•nga. F√∂rs√∂k v√§lj fler understreckat-tecken f√∂r att minska delning.`;
    insightCls = 'bad';
  }

  const res = document.getElementById('ev-result');
  res.innerHTML = `
    <div class="ev-grid">
      <div class="ev-stat">
        <div class="ev-stat-label">F√∂rv√§ntad utdelning per vinst</div>
        <div class="ev-stat-value">${(expectedShare/1e6).toFixed(1)} Mkr</div>
        <div class="ev-stat-sub">av ${(jackpot/1e6).toFixed(0)} Mkr jackpot</div>
      </div>
      <div class="ev-stat">
        <div class="ev-stat-label">EV per krona insats</div>
        <div class="ev-stat-value" style="color:${evRatio>1?'#16a34a':'#dc6060'}">${evRatio.toFixed(2)} kr</div>
        <div class="ev-stat-sub">${evRatio>1?'Positiv edge!':'Under break-even'}</div>
      </div>
      <div class="ev-stat">
        <div class="ev-stat-label">F√∂rv. antal vinnare totalt</div>
        <div class="ev-stat-value">${sharedWith.toFixed(1)}</div>
        <div class="ev-stat-sub">du delar med dessa</div>
      </div>
      <div class="ev-stat">
        <div class="ev-stat-label">Kontr√§r-score</div>
        <div class="ev-stat-value" style="color:${contrScore>1.5?'#16a34a':contrScore>0.8?'#eab308':'#dc6060'}">${contrScore.toFixed(2)}x</div>
        <div class="ev-stat-sub">>1.5 = bra kontr√§r</div>
      </div>
    </div>
    <div>
      <div style="font-size:.75rem;color:#93b8d8;margin-bottom:4px;">EV-ratio (m√•l: >1.0)</div>
      <div class="ev-bar-track"><div class="ev-bar-fill" style="width:${Math.min(evRatio*50,100)}%;background:${evRatio>1?'#86efac':'#fde68a'};"></div></div>
    </div>
    <div class="ev-insight ${insightCls}">${insight}</div>
    <div style="font-size:.73rem;color:#93b8d8;margin-top:8px;">
      üí° Tips: understreckat-tecken (üìà) s√§nker kontr√§r-score ‚Äî du avviker fr√•n folket och delar med f√§rre.
      V√§lj fler understreckat-tecken via "üí∞ V√§rde-tecken"-knappen.
    </div>`;
  res.style.display = 'block';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SCENARIO-ANALYS (Monte Carlo)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runScenario() {
  const N    = parseInt(document.getElementById('sim-count').value) || 25000;
  const btn  = document.querySelector('[onclick="runScenario()"]');
  if (btn) { btn.disabled=true; btn.textContent='‚è≥ Simulerar‚Ä¶'; }

  setTimeout(() => {
    // F√∂r varje simulering: sampla ett slumpm√§ssigt utfall baserat p√• blendade sannolikheter
    // Hitta sedan den b√§sta raden i ditt system
    const dist = new Array(14).fill(0);  // dist[k] = antal sims med b√§st k r√§tt

    for (let sim=0; sim<N; sim++) {
      // Sampla sant utfall
      const truth = MATCHES.map((m,i) => {
        const bp = activeProb(m,i);
        const r  = Math.random();
        return r < bp.p1 ? '1' : r < bp.p1+bp.px ? 'X' : '2';
      });

      // Hitta b√§sta rad i systemet (max r√§tt)
      // Systemet representeras som alla kombinationer av selections
      // Vi samplar ist√§llet 200 slumpm√§ssiga rader fr√•n systemet (effektivt f√∂r stora system)
      let bestRatt = 0;
      const rows = selections.reduce((a,s)=>a*s.size,1);

      if (rows <= 512) {
        // Exhaustiv: generera alla rader
        function* genRows(idx, cur) {
          if (idx === 13) { yield cur; return; }
          for (const s of selections[idx]) yield* genRows(idx+1, [...cur,s]);
        }
        for (const row of genRows(0,[])) {
          const ratt = row.filter((s,i)=>s===truth[i]).length;
          if (ratt > bestRatt) bestRatt = ratt;
          if (bestRatt===13) break;
        }
      } else {
        // Sampling: ta 300 slumpm√§ssiga rader
        for (let r=0; r<300; r++) {
          const row = selections.map(s=>{ const a=[...s]; return a[Math.floor(Math.random()*a.length)]; });
          const ratt = row.filter((s,i)=>s===truth[i]).length;
          if (ratt>bestRatt) bestRatt=ratt;
        }
      }
      dist[bestRatt]++;
    }

    // Ber√§kna kumulativ f√∂rdelning och visa
    const bars = [13,12,11,10,9].map(k => {
      const pctExact = dist[k]/N*100;
      const pctAtLeast = dist.slice(k).reduce((a,b)=>a+b,0)/N*100;
      const color = k>=12?'#86efac':k>=11?'#93c5fd':k>=10?'#a5b4fc':'#dbeafe';
      return `<div class="gar-scenario">
        <span class="gar-label">${k} r√§tt</span>
        <div class="gar-bar"><div class="gar-bar-fill" style="width:${Math.min(pctAtLeast,100)}%;background:${color};"></div></div>
        <span class="gar-pct" style="color:${k>=12?'#16a34a':k>=10?'#1d4ed8':'#93b8d8'};">${pctAtLeast.toFixed(1)}%</span>
        <span class="gar-count">‚â•${k} r√§tt</span>
      </div>`;
    }).join('');

    const p13sim = dist[13]/N*100;
    const p12sim = (dist[12]+dist[13])/N*100;
    const res = document.getElementById('scenario-result');
    res.innerHTML = `
      <div style="font-size:.8rem;font-weight:700;color:#3b6ea8;margin-bottom:10px;">
        Resultat av ${N.toLocaleString('sv')} simuleringar:
      </div>
      ${bars}
      <div style="font-size:.75rem;color:#93b8d8;margin-top:10px;line-height:1.6;">
        üéØ Simulerad chans 13 r√§tt: <strong>${p13sim.toFixed(3)}%</strong> &nbsp;|&nbsp;
        üìä Simulerad chans ‚â•12 r√§tt: <strong>${p12sim.toFixed(2)}%</strong>
        <br>Visar din <em>b√§sta rad</em> per utfall ‚Äî systemets verkliga skyddsn√§t.
      </div>`;
    res.style.display = 'block';
    if (btn) { btn.disabled=false; btn.textContent='üé≤ K√∂r simulering'; }
  }, 50);
}

function _removed_garantisystem() {
  const level = document.getElementById('gar-level').value;
  const price = parseFloat(document.getElementById('price-input').value)||1;

  // Identifiera garderade matcher (size > 1) och spikade (size === 1)
  const uncertain = selections.map((s,i)=>s.size>1?i:null).filter(i=>i!==null);
  const G = uncertain.length;

  if (G === 0) {
    document.getElementById('gar-result').innerHTML =
      '<div style="color:#93b8d8;font-size:.85rem;padding:10px 0;">Inga garderade matcher ‚Äî gardera minst en match f√∂r att anv√§nda garantisystemet.</div>';
    document.getElementById('gar-result').style.display='block';
    return;
  }

  // Generera alla m√∂jliga utfallskombinationer f√∂r de garderade matcherna
  const signs = ['1','X','2'];
  function* allCombos(n) {
    if (n===0) { yield []; return; }
    for (const rest of allCombos(n-1))
      for (const s of signs) yield [s,...rest];
  }

  let minSystem;
  if (level === 'all') {
    // Full covering: alla kombinationer
    minSystem = [...allCombos(G)];
  } else {
    const K = parseInt(level);  // garantera minst K av G r√§tt
    // Hitta minimalt covering set med greedy-algoritm
    const allTruths = [...allCombos(G)];
    const covered   = new Set();
    const system    = [];

    // Greedy: v√§lj den rad som t√§cker flest ej t√§ckta kombinationer
    const rowCovers = (row, truth) => {
      let matches = 0;
      for (let j=0;j<G;j++) if(row[j]===truth[j]) matches++;
      return matches >= K;
    };

    while (covered.size < allTruths.length) {
      let bestRow=null, bestCount=-1;
      for (const candidate of allCombos(G)) {
        const key = candidate.join('');
        if (system.some(r=>r.join('')===key)) continue;
        let count = 0;
        allTruths.forEach((t,ti)=>{ if(!covered.has(ti)&&rowCovers(candidate,t)) count++; });
        if (count>bestCount) { bestCount=count; bestRow=candidate; }
      }
      if (!bestRow || bestCount===0) break;
      system.push(bestRow);
      allTruths.forEach((t,ti)=>{ if(rowCovers(bestRow,t)) covered.add(ti); });
    }
    minSystem = system;
  }

  // Bygg ut till fullst√§ndiga rader (med spikade matcher)
  const fullRows = minSystem.map(garRow => {
    return selections.map((sel,i)=>{
      const gIdx = uncertain.indexOf(i);
      if (gIdx>=0) return garRow[gIdx];
      return [...sel][0];  // spikad: ta det enda valet
    });
  });

  const totalRows = fullRows.length;
  const cost = totalRows * price;
  const chipRows = fullRows.map((row,ri) => {
    const chips = row.map((s,i)=>{
      const isUncertain = uncertain.includes(i);
      const bg = isUncertain ? (s==='1'?'#93c5fd':s==='X'?'#a5b4fc':'#86efac') : '#e2e8f0';
      const color = isUncertain ? (s==='1'?'#1e3a8a':s==='X'?'#312e81':'#14532d') : '#64748b';
      return `<span style="background:${bg};color:${color};border-radius:5px;padding:2px 7px;font-size:.75rem;font-weight:700;">${i+1}.${s}</span>`;
    }).join('');
    return `<div style="display:flex;gap:3px;flex-wrap:wrap;padding:5px 0;border-bottom:1px solid #f0f7ff;">${chips}</div>`;
  }).join('');

  const desc = level==='all' ? 'alla r√§tt' : `minst ${level} av ${G} r√§tt`;
  const res  = document.getElementById('gar-result');
  res.innerHTML = `
    <div style="background:#f0fdf4;border-radius:12px;padding:12px 16px;margin-bottom:12px;border-left:4px solid #86efac;">
      <strong style="color:#14532d;">Garanterar: ${desc} p√• dina ${G} garderade matcher</strong><br>
      <span style="font-size:.82rem;color:#166534;">${totalRows} rader ¬∑ ${cost.toFixed(0)} kr ¬∑ G√§ller oavsett utfall</span>
    </div>
    <div style="max-height:300px;overflow-y:auto;font-size:.8rem;">${chipRows}</div>
    <button class="btn-apply-budget" style="margin-top:10px;" onclick='applyGarantiSystem(${JSON.stringify(fullRows)})'>‚úÖ Anv√§nd detta garantisystem</button>`;
  res.style.display='block';
}

function _removed_kelly() {
  const bankroll = 0;
  const price    = parseFloat(document.getElementById('price-input').value) || 1;

  const rows = [];
  MATCHES.forEach((m, i) => {
    const bp = activeProb(m, i);
    // Ber√§kna implied probability fr√•n odds (marknaden)
    const mktTot = 1/m.o1 + 1/m.ox + 1/m.o2;
    const mkt = { p1: (1/m.o1)/mktTot, px: (1/m.ox)/mktTot, p2: (1/m.o2)/mktTot };

    [
      { sign:'1', p: bp.p1, mkt: mkt.p1, odds: m.o1 },
      { sign:'X', p: bp.px, mkt: mkt.px, odds: m.ox },
      { sign:'2', p: bp.p2, mkt: mkt.p2, odds: m.o2 },
    ].forEach(o => {
      const edge = o.p - o.mkt;           // v√•r prob minus marknadens
      // Fraktionell Kelly: f = edge / (1 - mkt_prob)  (f√∂r bin√§rt utfall)
      const kelly_f = edge / (1 - o.mkt);
      const bet_kr  = Math.max(0, kelly_f * bankroll * 0.25); // ¬º Kelly f√∂r s√§kerhets skull
      rows.push({ i, sign: o.sign, edge, kelly_f, bet_kr,
                  name: m.home + ' vs ' + m.away });
    });
  });

  // Sortera efter edge, visa de med positiv edge
  rows.sort((a,b) => b.edge - a.edge);
  const pos = rows.filter(r => r.edge > 0.01);
  const neg = rows.filter(r => r.edge <= 0.01).slice(0, 3);

  const signCls = s => s==='1'?'marg-sign-1':s==='X'?'marg-sign-X':'marg-sign-2';

  const posHtml = pos.length ? pos.map(r => `
    <div class="kelly-row">
      <span style="font-size:.8rem;color:#93b8d8;">${r.i+1}.</span>
      <span style="font-size:.82rem;font-weight:600;flex:1;">${r.name}</span>
      <span class="marg-sign ${signCls(r.sign)}">${r.sign}</span>
      <span class="kelly-edge-pos">+${(r.edge*100).toFixed(1)}% edge</span>
      <span class="kelly-bet">${r.bet_kr < 1 ? '<1' : r.bet_kr.toFixed(0)} kr</span>
    </div>`).join('') :
    '<div style="color:#93b8d8;font-size:.84rem;padding:8px 0;">Inga tecken med tydlig positiv edge just nu ‚Äî odds och formmodell st√§mmer v√§l √∂verens.</div>';

  const negHtml = neg.map(r => `
    <div class="kelly-row" style="opacity:.5;">
      <span style="font-size:.8rem;color:#93b8d8;">${r.i+1}.</span>
      <span style="font-size:.82rem;font-weight:600;flex:1;">${r.name}</span>
      <span class="marg-sign ${signCls(r.sign)}">${r.sign}</span>
      <span class="kelly-edge-neg">${(r.edge*100).toFixed(1)}% edge</span>
      <span style="font-size:.75rem;color:#93b8d8;">undvik</span>
    </div>`).join('');

  const totalBet = pos.reduce((a,r) => a+r.bet_kr, 0);
  const res = document.getElementById('kelly-result');
  res.innerHTML = `
    <div style="font-size:.8rem;font-weight:700;color:#3b6ea8;margin-bottom:8px;">
      ‚úÖ Tecken med positiv edge (Kelly ¬º-fraktion):
    </div>
    ${posHtml}
    ${neg.length ? '<div style="font-size:.78rem;color:#93b8d8;margin:10px 0 4px;">S√§mst edge (undvik att spika):</div>' + negHtml : ''}
    <div style="margin-top:12px;padding-top:10px;border-top:1px solid #dbeafe;font-size:.82rem;color:#0369a1;">
      <strong>Rekommenderad total insats:</strong> ${totalBet.toFixed(0)} kr av ${bankroll} kr bankroll
      (${((totalBet/bankroll)*100).toFixed(0)}% av kapital)
    </div>
    <div style="font-size:.73rem;color:#93b8d8;margin-top:4px;">
      ‚ö†Ô∏è Kelly-formeln kr√§ver korrekta sannolikheter ‚Äî k√∂r formmodellen (stryktips_form_model.py) f√∂r b√§sta resultat.
    </div>`;
  res.style.display = 'block';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SIMULATED ANNEALING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runSimAnneal() {
  const budget   = parseFloat(document.getElementById('sa-budget').value) || 200;
  const price    = parseFloat(document.getElementById('price-input').value) || 1;
  const btn      = document.getElementById('sa-btn');
  const progress = document.getElementById('sa-progress');
  btn.disabled   = true;
  btn.textContent = '‚è≥ S√∂ker‚Ä¶';

  // K√∂r asynkront f√∂r att inte l√•sa UI
  setTimeout(() => {
    const SIGNS = ['1','X','2'];

    function cost(s) { return s.reduce((a,x)=>a*x.size,1)*price; }
    function p13(s)  {
      const cov=MATCHES.map((m,i)=>{
        const bp=activeProb(m,i);
        return Math.min((s[i].has('1')?bp.p1:0)+(s[i].has('X')?bp.px:0)+(s[i].has('2')?bp.p2:0),1);
      });
      return poissonBinomialPMF(cov)[13];
    }

    // SA startv√§rde: b√§sta enkla spik per match
    let cur = MATCHES.map((m,i)=>{
      const bp=activeProb(m,i);
      const mx=Math.max(bp.p1,bp.px,bp.p2);
      return new Set([mx===bp.p1?'1':mx===bp.px?'X':'2']);
    });

    let curP13  = p13(cur);
    let bestSys = cur.map(s=>new Set(s));
    let bestP13 = curP13;

    const ITER    = 100_000;
    const T0      = 0.02;                             // Starttemperatur ‚Äî accepterar ~2% s√§mre l√∂sning med ~37% sannolikhet
    const T_end   = 0.0001;                           // Sluttemperatur ‚Äî n√§stan ingen acceptans av s√§mre l√∂sningar
    const cooling = Math.pow(T_end / T0, 1 / ITER);  // Exponentiell kylningsfaktor
    let   T       = T0;

    for (let it = 0; it < ITER; it++) {
      T *= cooling;   // exponentiell kylning: r√§tt SA-schema

      // Omstart var 25k iteration ‚Äî √•terg√•r till b√§sta k√§nda l√∂sning f√∂r att undvika lokala maxima
      if (it % 25000 === 24999) { cur = bestSys.map(s=>new Set(s)); curP13 = bestP13; }

      // Slumpm√§ssigt grannsteg: l√§gg till, ta bort eller byt ett tecken p√• en match
      const newSys = cur.map(s=>new Set(s));
      const mi = Math.floor(Math.random() * 13);
      const move = Math.random();

      if (move < 0.4 && newSys[mi].size < 3) {
        // L√§gg till ett tecken
        const missing = SIGNS.filter(s=>!newSys[mi].has(s));
        newSys[mi].add(missing[Math.floor(Math.random()*missing.length)]);
      } else if (move < 0.7 && newSys[mi].size > 1) {
        // Ta bort ett tecken
        const arr=[...newSys[mi]];
        newSys[mi].delete(arr[Math.floor(Math.random()*arr.length)]);
      } else {
        // Byt hela valet till en slumpm√§ssig garderingsniv√•
        const opts=[['1'],['X'],['2'],['1','X'],['X','2'],['1','2'],['1','X','2']];
        const pick=opts[Math.floor(Math.random()*opts.length)];
        newSys[mi]=new Set(pick);
      }

      if (cost(newSys) > budget) continue;  // √∂verstiger budget

      const newP13 = p13(newSys);
      const delta  = newP13 - curP13;
      // Korrekt Boltzmann-acceptansfunktion ‚Äî T √§r i samma enhet som delta (sannolikheter)
      if (delta > 0 || Math.random() < Math.exp(delta / T)) {
        cur    = newSys;
        curP13 = newP13;
      }
      if (curP13 > bestP13) { bestP13=curP13; bestSys=cur.map(s=>new Set(s)); }
    }

    const finalRows = bestSys.reduce((a,s)=>a*s.size,1);
    const finalCost = finalRows * price;
    const chips     = bestSys.map((s,i)=>{
      const key=[...s].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
      return `<div class="rad-chip rc-${key}" style="font-size:.75rem;padding:3px 7px;">${i+1}.${key}</div>`;
    }).join('');
    const sysData = JSON.stringify(bestSys.map(s=>[...s]));

    const res = document.getElementById('sa-result');
    res.innerHTML = `<strong>B√§sta system hittat (${ITER.toLocaleString('sv')} iterationer ¬∑ exp. kylning):</strong><br>
<span style="color:#0369a1;">${finalRows} rader ¬∑ ${finalCost.toFixed(0)} kr ¬∑ Chans: ${fmtChance(bestP13)}</span>
<div style="display:flex;gap:4px;flex-wrap:wrap;margin:8px 0;">${chips}</div>
<button class="btn-apply-budget" onclick='applyBudgetSystem(${sysData})'>‚úÖ Anv√§nd detta system</button>`;
    res.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'üî• K√∂r SA-s√∂kning';
    progress.textContent = `‚úÖ S√∂kning klar! Testade ${ITER.toLocaleString('sv')} kombinationer med exponentiell kylning.`;
  }, 50);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KORRELATIONSMODELL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const corrAdj = { defensive:0, cup:0, endseason:0, topteam:0 };

function applyCorrelation() {
  corrAdj.defensive = document.getElementById('corr-defensive').checked ? 0.03 : 0;
  corrAdj.cup       = document.getElementById('corr-cup').checked ? 1 : 0;
  corrAdj.endseason = document.getElementById('corr-endseason').checked ? 0.05 : 0;
  corrAdj.topteam   = document.getElementById('corr-topteam').checked ? 1 : 0;

  const active = Object.values(corrAdj).some(v=>v>0);
  document.getElementById('corr-status').textContent = active
    ? '‚úÖ Korrelationsjusteringar aktiva ‚Äî sannolikheterna i Min kupong √§r uppdaterade'
    : '';

  renderMatches(); recalc();
}

// Exponeras via getBlendedProb ‚Äì l√§gg till korr-justering p√• toppen
const _origGetBlended = getBlendedProb;
// Patch: wrappa getBlendedProb med korrelationsjusteringar
function getBlendedProbWithCorr(m, i) {
  let { p1, px, p2 } = _origGetBlended(m, i);

  // Tr√∂g ligaomg√•ng ‚Üí kryss mer sannolikt
  if (corrAdj.defensive) { px = Math.min(px + corrAdj.defensive, 0.5); }

  // Slutspurt ‚Üí hemmalag desperat, fler ettor
  if (corrAdj.endseason) { p1 = Math.min(p1 + corrAdj.endseason, 0.8); }

  // Cup ‚Üí rotation skadar favoritlag borta (bortavinst minskar)
  if (corrAdj.cup) { p2 = Math.max(p2 - 0.03, 0.05); px = Math.min(px + 0.02, 0.5); }

  // Stortopplag borta ‚Üí bortavinst underskattas av folk
  if (corrAdj.topteam && m.f2 < 20 && m.xp2 > m.f2 + 8) {
    p2 = Math.min(p2 + 0.04, 0.75);
  }

  const tot = p1 + px + p2;
  return { p1: p1/tot, px: px/tot, p2: p2/tot };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INL√ÑMNINGS-TIMER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function initTimer() {
  // Stryktipset st√§nger normalt l√∂rdag 15:59 (eller s√∂ndag f√∂r vissa omg√•ngar)
  // Hittar n√§rmaste l√∂rdag 15:59 ‚Äî inkl. om det √§r l√∂rdag idag men f√∂re st√§ngningstid
  function nextClose() {
    const now = new Date();
    const d = new Date(now);
    const day = d.getDay(); // 0=s√∂n, 6=l√∂r
    // Antal dagar till l√∂rdag (0 om det redan √§r l√∂rdag)
    const daysToSat = (6 - day + 7) % 7;
    d.setDate(d.getDate() + daysToSat);
    d.setHours(15, 59, 0, 0);
    if (d <= now) d.setDate(d.getDate() + 7); // st√§ngningen passerad ‚Üí n√§sta l√∂rdag
    return d;
  }

  const closeTime = nextClose();
  const OPTIMAL_WINDOW = 75 * 60 * 1000; // 75 min innan st√§ngning

  document.getElementById('timer-closes').textContent =
    closeTime.toLocaleDateString('sv-SE',{weekday:'short'}) + ' ' +
    closeTime.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'});

  function tick() {
    const now  = new Date();
    const diff = closeTime - now;
    if (diff <= 0) {
      document.getElementById('timer-clock').textContent = 'ST√ÑNGD';
      document.getElementById('timer-msg').textContent   = 'üîí Kupongen √§r st√§ngd';
      document.getElementById('submit-timer').className  = 'danger';
      return;
    }
    const h = Math.floor(diff/3600000);
    const m = Math.floor((diff%3600000)/60000);
    const s = Math.floor((diff%60000)/1000);
    document.getElementById('timer-clock').textContent =
      `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

    const el = document.getElementById('submit-timer');
    if (diff < 30*60*1000) {
      // <30 min ‚Üí DANGER, l√§mna in NU
      el.className = 'danger';
      document.getElementById('timer-msg').textContent  = 'üö® L√§mna in din kupong NU!';
      document.getElementById('timer-hint').textContent = 'St√§nger snart ‚Äì du riskerar att missa!';
    } else if (diff < OPTIMAL_WINDOW) {
      // <75 min ‚Üí OK-f√∂nster
      el.className = 'ok';
      document.getElementById('timer-msg').textContent  = '‚úÖ Optimalt inl√§mningsf√∂nster!';
      document.getElementById('timer-hint').textContent = 'Laguppst√§llningar klara ‚Äì l√§mna in nu';
    } else {
      // Gott om tid
      el.className = '';
      const waitMin = Math.floor((diff - OPTIMAL_WINDOW)/60000);
      document.getElementById('timer-msg').textContent  = `‚è≥ V√§nta ${waitMin} min till`;
      document.getElementById('timer-hint').textContent = 'Laguppst√§llningar kan √§ndras ‚Äì v√§nta med inl√§mning';
    }
  }
  tick();
  setInterval(tick, 1000);
})();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KONTEXTUELLA FLAGGOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ctxFlags = MATCHES.map(() => ({ cup:false, wet:false, derby:false, degrad:false, tired:false }));

// Effekter per flagga p√• (p1, px, p2)
const CTX_EFFECTS = {
  cup:   { px:+0.04, p2:-0.03 },          // rotation, hemmalag roterar
  wet:   { px:+0.06, p1:-0.03, p2:-0.03}, // regn/bl√•st ‚Üí fler kryss
  derby: { p1:+0.05, px:+0.02, p2:-0.07}, // hemmaf√∂rdel f√∂rst√§rks i derby
  degrad:{ p1:+0.06, px:-0.02, p2:-0.04}, // hemmalag desperat vid degradering
  tired: { p2:+0.04, px:+0.02, p1:-0.06}, // bortalag piggare (hemmalag tr√∂tt)
};

function renderCtxFlags() {
  const el = document.getElementById('ctx-match-list');
  if (!el) return;
  el.innerHTML = MATCHES.map((m,i) => {
    const f = ctxFlags[i];
    return `<div class="ctx-match">
      <div class="ctx-match-name">${i+1}. ${m.home} vs ${m.away}</div>
      <div class="ctx-flags">
        <button class="ctx-flag ctx-cup${f.cup?' active':''}"   onclick="toggleCtx(${i},'cup')">üèÜ Cup</button>
        <button class="ctx-flag ctx-wet${f.wet?' active':''}"   onclick="toggleCtx(${i},'wet')">üåßÔ∏è V√§der</button>
        <button class="ctx-flag ctx-derby${f.derby?' active':''}" onclick="toggleCtx(${i},'derby')">‚ö° Derby</button>
        <button class="ctx-flag ctx-degrad${f.degrad?' active':''}" onclick="toggleCtx(${i},'degrad')">üèÅ Degradering</button>
        <button class="ctx-flag ctx-tired${f.tired?' active':''}" onclick="toggleCtx(${i},'tired')">üò¥ Tr√∂tt (cups)</button>
      </div>
    </div>`;
  }).join('');
}

function toggleCtx(i, flag) {
  ctxFlags[i][flag] = !ctxFlags[i][flag];
  renderCtxFlags();
}

function applyContextFlags() {
  const active = ctxFlags.filter(f=>Object.values(f).some(v=>v)).length;
  recalc();
  renderMarginal();
  document.getElementById('ctx-status').textContent =
    active ? `‚úÖ ${active} matcher med aktiva flaggor ‚Äî sannolikheterna uppdaterade!` : 'Inga flaggor aktiva.';
  showToast('‚úÖ Kontextuella flaggor applicerade!');
}

// Patch getBlendedProbWithCorr att √§ven inkludera ctx-flaggor
const _origWithCorr = getBlendedProbWithCorr;
getBlendedProbWithCorr = function(m, i) {
  let { p1, px, p2 } = _origWithCorr(m, i);
  const f = ctxFlags[i];
  for (const [flag, adj] of Object.entries(CTX_EFFECTS)) {
    if (!f[flag]) continue;
    if (adj.p1) p1 = Math.min(Math.max(p1 + adj.p1, 0.05), 0.90);
    if (adj.px) px = Math.min(Math.max(px + adj.px, 0.05), 0.60);
    if (adj.p2) p2 = Math.min(Math.max(p2 + adj.p2, 0.05), 0.90);
  }
  const tot = p1+px+p2;
  return { p1:p1/tot, px:px/tot, p2:p2/tot };
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MULTI-SYSTEM SPLITTER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runMultiSystem() {
  const budget = parseFloat(document.getElementById('msys-budget').value) || 500;
  const price  = parseFloat(document.getElementById('price-input').value) || 1;

  // System A (60%): konservativt ‚Äî SA-optimering med 60% av budget
  // System B (30%): kontr√§rt ‚Äî v√§rde-tecken-prioriterat
  // System C (10%): jackpott-j√§gare ‚Äî maximalt kontr√§r
  const budA = Math.floor(budget * 0.60 / price) * price;
  const budB = Math.floor(budget * 0.30 / price) * price;
  const budC = Math.floor(budget * 0.10 / price) * price;

  function sysFromSels(sels) {
    return {
      rows: sels.reduce((a,s)=>a*s.size,1),
      p13:  calcStats(sels).p13,
      chips: sels.map((s,i)=>{
        const key=[...s].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
        return `<span class="rad-chip rc-${key}" style="font-size:.72rem;padding:2px 6px;">${i+1}.${key}</span>`;
      }).join(''),
      sysArr: sels.map(s=>[...s])
    };
  }

  // System A: SA-optimering konservativ (h√∂g P(13))
  function buildA(bud) {
    const sys = MATCHES.map((m,i)=>{
      const bp=activeProb(m,i); const mx=Math.max(bp.p1,bp.px,bp.p2);
      return new Set([mx===bp.p1?'1':mx===bp.px?'X':'2']);
    });
    function cost(s){return s.reduce((a,x)=>a*x.size,1)*price;}
    function p13(s){
      const cov=MATCHES.map((m,i)=>{const bp=activeProb(m,i);
        return Math.min((s[i].has('1')?bp.p1:0)+(s[i].has('X')?bp.px:0)+(s[i].has('2')?bp.p2:0),1);});
      return poissonBinomialPMF(cov)[13];
    }
    for(let it=0;it<3000;it++){
      const mi=Math.floor(Math.random()*13);
      if(sys[mi].size===3) continue;
      const newSys=sys.map((s,j)=>j===mi?new Set([...s,'1X2'.split('').find(c=>!s.has(c)&&'1X2'.includes(c))||'1']):s);
      const sign=['1','X','2'].find(sg=>!sys[mi].has(sg));
      if(!sign) continue;
      const test=sys.map((s,j)=>j===mi?new Set([...s,sign]):s);
      if(cost(test)<=bud && p13(test)>p13(sys)){sys[mi].add(sign);}
    }
    return sys;
  }

  // System B: v√§rde-bet ‚Äî underviktade tecken
  function buildB() {
    return MATCHES.map((m,i)=>{
      const bp=activeProb(m,i);
      const mktTot=1/m.o1+1/m.ox+1/m.o2;
      const edges={
        '1':(bp.p1-(1/m.o1/mktTot)),
        'X':(bp.px-(1/m.ox/mktTot)),
        '2':(bp.p2-(1/m.o2/mktTot))
      };
      const bestEdge=Math.max(...Object.values(edges));
      if(bestEdge>0.06){
        // Spika b√§sta edge-tecknet
        const best=Object.entries(edges).sort((a,b)=>b[1]-a[1])[0][0];
        return new Set([best]);
      } else if(bestEdge>0.02){
        // Gardera: ta de med positiv edge
        const pos=Object.entries(edges).filter(([,e])=>e>0).map(([s])=>s);
        return new Set(pos.length?pos:['1','X','2']);
      } else {
        // Fullgardera os√§kra
        return new Set(['1','X','2']);
      }
    });
  }

  // System C: max kontr√§r ‚Äî v√§lj alltid understreckat (l√•gt folk, h√∂g xP)
  function buildC() {
    return MATCHES.map((m,i)=>{
      const bp=activeProb(m,i);
      const gaps=[
        {s:'1',gap:bp.p1-m.f1/100},
        {s:'X',gap:bp.px-m.fx/100},
        {s:'2',gap:bp.p2-m.f2/100},
      ].sort((a,b)=>b.gap-a.gap);
      // Alltid det mest understreckat tecknet
      return new Set([gaps[0].s]);
    });
  }

  const sA = buildA(budA);
  const sB = buildB();
  const sC = buildC();
  const rA = sysFromSels(sA), rB = sysFromSels(sB), rC = sysFromSels(sC);

  const res = document.getElementById('msys-result');
  res.innerHTML = `
    <div class="msys-system msys-A">
      <div class="msys-title" style="color:#1e40af;">üõ°Ô∏è System A ‚Äî Konservativt (${(budA).toFixed(0)} kr / 60%)</div>
      <div class="msys-chips">${rA.chips}</div>
      <div class="msys-meta">${rA.rows} rader ¬∑ Chans: ${fmtChance(rA.p13)}</div>
      <button class="btn-apply-sys btn-apply-A" onclick='applyBudgetSystem(${JSON.stringify(rA.sysArr)})'>‚ñ∂ Anv√§nd A</button>
    </div>
    <div class="msys-system msys-B">
      <div class="msys-title" style="color:#14532d;">üí∞ System B ‚Äî V√§rde/Kontr√§rt (${(budB).toFixed(0)} kr / 30%)</div>
      <div class="msys-chips">${rB.chips}</div>
      <div class="msys-meta">${rB.rows} rader ¬∑ Chans: ${fmtChance(rB.p13)}</div>
      <button class="btn-apply-sys btn-apply-B" onclick='applyBudgetSystem(${JSON.stringify(rB.sysArr)})'>‚ñ∂ Anv√§nd B</button>
    </div>
    <div class="msys-system msys-C">
      <div class="msys-title" style="color:#581c87;">üé≤ System C ‚Äî Max kontr√§rt (${(budC).toFixed(0)} kr / 10%)</div>
      <div class="msys-chips">${rC.chips}</div>
      <div class="msys-meta">${rC.rows} rad ¬∑ Chans: ${fmtChance(rC.p13)} ¬∑ Dela med f√• om r√§tt!</div>
      <button class="btn-apply-sys btn-apply-C" onclick='applyBudgetSystem(${JSON.stringify(rC.sysArr)})'>‚ñ∂ Anv√§nd C</button>
    </div>
    <div style="font-size:.75rem;color:#93b8d8;margin-top:8px;line-height:1.6;">
      üí° Spela alla tre varje vecka. A ger jackpott-chans, B ger b√§st EV, C multiplar om understreckat sl√•r in.
      Totalt: ${(rA.rows+rB.rows+rC.rows)} rader ¬∑ ${(rA.rows+rB.rows+rC.rows)*price} kr
    </div>`;
  res.style.display = 'block';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  POPULATIONSM√ñNSTER-DETEKTOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runPopDetector() {
  // "Standardkupongen" = alla spelare v√§ljer favorit (max folk) per match
  // Score = hur mycket du avviker fr√•n det
  let totalScore = 0;
  const matchDetails = MATCHES.map((m, i) => {
    const sel = selections[i];
    // Folkandel f√∂r dina valda tecken
    const myFolk = ((sel.has('1')?m.f1:0)+(sel.has('X')?m.fx:0)+(sel.has('2')?m.f2:0));
    const maxFolk = Math.max(m.f1, m.fx, m.f2);
    const folkDiff = maxFolk - myFolk;  // 0 = du spelar som alla, +50 = max avvikelse
    totalScore += folkDiff;
    const key = [...sel].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('');
    return { i, name:`${m.home} vs ${m.away}`, myFolk, maxFolk, folkDiff, key };
  });

  const maxPossible = MATCHES.reduce((a,m)=>a+Math.max(m.f1,m.fx,m.f2)-Math.min(m.f1,m.fx,m.f2),0);
  const score = Math.round(totalScore / maxPossible * 100);

  const ringColor = score>60?'#16a34a':score>35?'#eab308':'#dc6060';
  const ringText  = score>60?'Kontr√§r üéØ':score>35?'Blandat':'Folkmassan üò∂';

  const rows = matchDetails.sort((a,b)=>b.folkDiff-a.folkDiff).map(d => {
    const pct = Math.min(d.folkDiff / 60 * 100, 100);
    const color = d.folkDiff>20?'#86efac':d.folkDiff>8?'#93c5fd':'#fde68a';
    return `<div class="pop-match-row">
      <span style="font-size:.75rem;color:#93b8d8;min-width:20px;">${d.i+1}.</span>
      <span class="marg-sign marg-sign-${d.key[0]}" style="font-size:.75rem;">${d.key}</span>
      <span style="font-size:.8rem;font-weight:600;flex:1;min-width:80px;">${d.name}</span>
      <div class="pop-folk-bar"><div class="pop-folk-fill" style="width:${pct}%;background:${color};"></div></div>
      <span class="pop-diff" style="color:${d.folkDiff>20?'#16a34a':d.folkDiff>8?'#3b82f6':'#dc6060'};">
        ${d.folkDiff>0?'+':''}${d.folkDiff.toFixed(0)}pp
      </span>
    </div>`;
  }).join('');

  document.getElementById('pop-result').innerHTML = `
    <div style="display:flex;gap:18px;align-items:center;margin-bottom:14px;flex-wrap:wrap;">
      <div class="pop-score-ring" style="color:${ringColor};border-color:${ringColor};">
        <div style="font-size:1.6rem;">${score}</div>
        <div style="font-size:.65rem;text-align:center;line-height:1.2;">${ringText}</div>
      </div>
      <div style="flex:1;min-width:180px;">
        <div style="font-size:.85rem;font-weight:700;color:#1e3a5f;margin-bottom:6px;">
          Kontr√§r-score: ${score}/100
        </div>
        <div style="font-size:.82rem;color:#3b6ea8;line-height:1.6;">
          ${score>60?'üéâ Bra! Du avviker tydligt fr√•n folkmassan. Om du vinner delar du med f√§rre.':
            score>35?'üëç Okej avvikelse. Kan f√∂rb√§ttras ‚Äî titta p√• matcherna l√§ngst ned i listan.':
            '‚ö†Ô∏è Du spelar som alla andra. Om du vinner delar du jackpotten med m√•nga. L√§gg till fler understreckat-tecken.'}
        </div>
        <div style="font-size:.75rem;color:#93b8d8;margin-top:4px;">
          Gr√∂n = du avviker mycket (bra EV) ¬∑ R√∂d = du spelar som folket (delar mer)
        </div>
      </div>
    </div>
    <div style="font-size:.78rem;font-weight:700;color:#93b8d8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;">Avvikelse per match (st√∂rst ‚Üí minst)</div>
    ${rows}`;
  document.getElementById('pop-result').style.display = 'block';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  UPPDATERA EV-KALKYLATORN MED ALLA PRISNIV√ÖER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Typiska Stryktipset-priser (SEK) baserat p√• jackpott-storlek
function estimatePrize(jackpot, tier) {
  // tier: 13, 12, 11
  if (tier === 13) return jackpot;
  if (tier === 12) return Math.max(jackpot * 0.003, 5000);   // ~0.3% av jackpott
  if (tier === 11) return Math.max(jackpot * 0.0003, 200);   // ~0.03% av jackpott
  return 0;
}

const _origRunEV = runJackpotEV;
function runJackpotEV() {
  _origRunEV();
  // L√§gg till prislevel-till√§gg
  const jackpot  = parseFloat(document.getElementById('ev-jackpot').value) || 10e6;
  const nCoupons = parseFloat(document.getElementById('ev-coupons').value) || 350000;
  const price    = parseFloat(document.getElementById('price-input').value) || 1;
  const st       = calcStats();

  const folkP12  = MATCHES.reduce((p,m)=>{ const sorted=[m.f1,m.fx,m.f2].sort((a,b)=>b-a); return p*(sorted[0]+sorted[1])/100; },1);
  const folkP11  = MATCHES.reduce((p,m)=>{ return p*(m.f1+m.fx+m.f2-Math.min(m.f1,m.fx,m.f2))/100; },1);

  const prize12  = estimatePrize(jackpot, 12);
  const prize11  = estimatePrize(jackpot, 11);
  const winners12 = nCoupons * folkP12;
  const winners11 = nCoupons * folkP11;

  const ev12 = st.p12 * (prize12 / Math.max(winners12, 1));
  const ev11 = (poissonBinomialPMF(MATCHES.map((m,i)=>{
    const bp=activeProb(m,i); const s=selections[i];
    return Math.min((s.has('1')?bp.p1:0)+(s.has('X')?bp.px:0)+(s.has('2')?bp.p2:0),1);
  }))[11]) * (prize11 / Math.max(winners11, 1));

  const totalEV_all = (st.p13 * jackpot/Math.max(nCoupons*0.0001,1)) + ev12 + ev11;

  const existing = document.getElementById('ev-result');
  if (existing && existing.style.display !== 'none') {
    const extra = document.createElement('div');
    extra.style.cssText = 'margin-top:10px;padding:10px 14px;background:#f0fdf4;border-radius:10px;border-left:4px solid #86efac;font-size:.82rem;line-height:1.8;';
    extra.innerHTML = `<strong style="color:#14532d;">üìä Alla prisniv√•er inkluderade:</strong><br>
      12 r√§tt (f√∂rv. pris ~${(prize12/1000).toFixed(0)}k kr): EV ${ev12.toFixed(2)} kr/rad<br>
      11 r√§tt (f√∂rv. pris ~${(prize11).toFixed(0)} kr): EV ${ev11.toFixed(4)} kr/rad<br>
      <strong>Total EV (alla niv√•er): ${(totalEV_all/price*100).toFixed(1)}% av insatsen</strong>`;
    existing.appendChild(extra);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PASTE-PARSER ‚Äî klistra in r√•text fr√•n Svenska Spel
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseStryktipsetText(raw) {
  // Steg 1: normalisera sidnavigation "1. 2" ‚Üí "\n2\n"
  // (mellanrum kr√§vs runt punkt f√∂r att inte sl√• p√• odds som "1,54")
  let normalized = raw.replace(/\r\n/g, '\n');
  // "N. M" med space: typisk SP-navigering
  normalized = normalized.replace(/\b(\d{1,2})\.\s+(\d{1,2})\b/g, '\n$2\n');

  const lines = normalized.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  const result = [];
  let i = 0;

  while (i < lines.length && result.length < 13) {
    const line = lines[i];

    // Starta ett nytt matchblock n√§r vi ser enbart en siffra 1‚Äì13
    if (/^\d{1,2}$/.test(line) && parseInt(line) >= 1 && parseInt(line) <= 13) {
      i++;

      // Hoppa √∂ver k√§nda header-rader tills vi hittar lagnamn
      while (i < lines.length && (
        lines[i] === '1X2' ||
        lines[i].startsWith('Tipsinformation') ||
        lines[i].startsWith('Tipsinfo') ||
        /^\d{1,2}$/.test(lines[i])
      )) i++;

      const teamLine = lines[i] || '';
      const tmatch = teamLine.match(/^(.+?)\s*[-‚Äì]\s*(.+)$/);
      if (!tmatch) { i++; continue; }
      const home = tmatch[1].trim();
      const away = tmatch[2].trim();
      i++;

      let folk = [], odds = [], startOdds = [];
      let phase = 'seeking_folk';
      let safetyBreak = 0;

      while (i < lines.length && safetyBreak < 50) {
        safetyBreak++;
        const l = lines[i];

        // Stoppa om vi tr√§ffar n√§sta matchnummer
        if (/^\d{1,2}$/.test(l) && parseInt(l) >= 1 && parseInt(l) <= 13) break;

        if (phase === 'seeking_folk') {
          // Enstaka %-rad: "77%"
          const pct = l.match(/^(\d{1,3})%$/);
          if (pct) {
            folk.push(parseInt(pct[1]));
            if (folk.length === 3) phase = 'seeking_odds';
          } else {
            // Sammanslagen rad: "Svenska folket77%14%9%" eller "Tipsinfo1X2Svenska folket77%14%9%"
            const allPct = [...l.matchAll(/\b(\d{1,3})%/g)].map(m => parseInt(m[1]));
            if (allPct.length >= 3 && folk.length === 0) {
              folk = allPct.slice(0, 3);
              phase = 'seeking_odds';
            }
          }
        } else if (phase === 'seeking_odds') {
          if (l === 'Aktuellt odds') { i++; continue; }
          // Enstaka odds: "1,54"
          const oddMatch = l.match(/^(\d{1,2})[,\.](\d{2})$/);
          if (oddMatch) {
            odds.push(parseFloat(l.replace(',', '.')));
            if (odds.length === 3) phase = 'seeking_startodds';
          } else {
            // Sammanslagen: "1,545,006,40" eller "1.545.006.40"
            const allOdds = [...l.matchAll(/\b(\d{1,2}[,\.]\d{2})\b/g)].map(m => parseFloat(m[1].replace(',','.')));
            if (allOdds.length >= 3 && odds.length === 0) {
              odds = allOdds.slice(0, 3);
              phase = 'seeking_startodds';
            }
          }
        } else if (phase === 'seeking_startodds') {
          // Startodds kan finnas inline: "Favoritskap63%20%17%Startodds1,495,006,40"
          // eller p√• separat rad
          if (l.includes('Startodds') || l === 'Startodds') {
            const rest = l.replace(/^.*?Startodds/, '');
            const allOdds = [...rest.matchAll(/\b(\d{1,2}[,\.]\d{2,3})\b/g)].map(m => parseFloat(m[1].replace(',','.')));
            if (allOdds.length >= 3) { startOdds = allOdds.slice(0, 3); i++; break; }
          }
          const oddMatch = l.match(/^(\d{1,2})[,\.](\d{2,3})$/);
          if (oddMatch) {
            startOdds.push(parseFloat(l.replace(',', '.')));
            if (startOdds.length === 3) { i++; break; }
          }
          // Avsluta om vi hittar Favoritskap-rad (startodds inte kritiska)
          if (l.startsWith('Favoritskap')) {
            const allOdds = [...l.matchAll(/\b(\d{1,2}[,\.]\d{2,3})\b/g)].map(m => parseFloat(m[1].replace(',','.')));
            if (allOdds.length >= 3) startOdds = allOdds.slice(0, 3);
            i++; break;
          }
        }
        i++;
      }

      if (folk.length >= 3 && odds.length >= 3) {
        const entry = {
          home, away,
          o1: odds[0], ox: odds[1], o2: odds[2],
          f1: folk[0], fx: folk[1], f2: folk[2],
        };
        if (startOdds.length >= 3) {
          entry.so1 = startOdds[0]; entry.sox = startOdds[1]; entry.so2 = startOdds[2];
        }
        result.push(entry);
      }
    } else {
      i++;
    }
  }
  return result;
}

function reloadWithMatches(newMs, newRound) {
  if (!newMs || newMs.length !== 13) {
    alert(`‚ö†Ô∏è Hittade ${newMs ? newMs.length : 0} matcher ‚Äî beh√∂ver exakt 13. Kontrollera texten och f√∂rs√∂k igen.`);
    return false;
  }
  MATCHES = newMs;
  if (newRound) ROUND = newRound;
  computeMatchDerived(MATCHES);
  selections.length = 0;
  MATCHES.forEach(m => selections.push(defaultSel(m)));
  xpSport.length = 0;
  MATCHES.forEach(() => xpSport.push({ s1:null, sx:null, s2:null }));
  ctxFlags.length = 0;
  MATCHES.forEach(() => ctxFlags.push({ cup:false, wet:false, derby:false, degrad:false, tired:false }));
  document.getElementById('round-label').textContent = ROUND + ' ¬∑ V√§lj dina tecken nedan ‚Äì allt r√§knas ut direkt!';
  renderMatches();
  recalc();
  renderCtxFlags();
  renderMarginal();
  showToast('‚úÖ Ny omg√•ngsdata laddad ‚Äî ' + MATCHES.length + ' matcher!');
  return true;
}

function showPasteModal() {
  document.getElementById('paste-modal').style.display = 'flex';
  document.getElementById('paste-textarea').value = '';
  document.getElementById('paste-status').textContent = '';
  document.getElementById('paste-textarea').focus();
}
function hidePasteModal() {
  document.getElementById('paste-modal').style.display = 'none';
}

async function fetchLatestData() {
  const btn = document.getElementById('fetch-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ H√§mtar‚Ä¶';
  try {
    const proxy = 'https://corsproxy.io/?url=';

    async function fetchGame(slug) {
      const url = 'https://api.spela.svenskaspel.se/draw/1/' + slug + '/draws';
      const res = await fetch(proxy + encodeURIComponent(url));
      if (!res.ok) return null;
      const json = await res.json();
      return (json && json.draws && json.draws.length > 0) ? {data: json, slug} : null;
    }

    // H√§mta b√•da parallellt f√∂r att fylla pickern och ladda aktuell omg√•ng
    const [stryk, euro] = await Promise.all([fetchGame('stryktipset'), fetchGame('europatipset')]);

    const allOptions = [];
    if (stryk) stryk.data.draws.forEach(d => allOptions.push({draw:d, gameName:'Stryktipset', minEvents:13, slug:'stryktipset'}));
    if (euro)  euro.data.draws.forEach(d => allOptions.push({draw:d, gameName:'Europatipset', minEvents:8,  slug:'europatipset'}));
    allOptions.sort((a,b) => {
      const ta = a.draw.closeTime ? new Date(a.draw.closeTime).getTime() : Infinity;
      const tb = b.draw.closeTime ? new Date(b.draw.closeTime).getTime() : Infinity;
      return ta - tb;
    });

    if (!allOptions.length) throw new Error('Ingen √∂ppen omg√•ng hittades i Stryktipset eller Europatipset');

    populateRoundPicker(allOptions);

    const first = allOptions[0];
    const ok = applyDrawToApp(first.draw, first.gameName, first.minEvents);
    if (!ok) throw new Error('Omg√•ngdata ofullst√§ndig');

    renderMarginal();
    showToast(`‚úÖ H√§mtade ${MATCHES.length} matcher ‚Äì ${ROUND}`);
  } catch (e) {
    showToast('‚ùå Kunde inte h√§mta data: ' + e.message);
    console.error(e);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîÑ H√§mta senaste odds';
  }
}

function importPastedData() {
  const raw = document.getElementById('paste-textarea').value;
  if (!raw.trim()) { document.getElementById('paste-status').textContent = '‚ö†Ô∏è Ingen text inklistrad.'; return; }
  const ms = parseStryktipsetText(raw);
  document.getElementById('paste-status').textContent = `Hittade ${ms.length} matcher...`;
  const roundMatch = raw.match(/Omg[√•a]ng\s+\d+/i);
  const roundLabel = roundMatch ? roundMatch[0] : ROUND;
  if (reloadWithMatches(ms, roundLabel)) hidePasteModal();
  else document.getElementById('paste-status').textContent = `‚ùå Hittade ${ms.length}/13 matcher. Kontrollera texten.`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FLIKAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(tab) {
  document.getElementById('start-panel').style.display   = tab==='start'   ? 'block' : 'none';
  document.getElementById('kupong-panel').style.display  = tab==='kupong'  ? 'block' : 'none';
  document.getElementById('history-panel').style.display = tab==='historik'? 'block' : 'none';
  document.getElementById('mer-panel').style.display     = tab==='mer'     ? 'block' : 'none';
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',
    (i===0&&tab==='start')||(i===1&&tab==='kupong')||(i===2&&tab==='historik')||(i===3&&tab==='mer')));
  if (tab==='historik') renderHistory();
  if (tab==='mer')      { renderMarginal(); renderCtxFlags(); renderSystemTab(); renderUSystemTab(); renderRowEV(); }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  R-SYSTEM DATA & RENDERING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const R_SYSTEMS = [
  {name:'R 4-0-9',   helg:4, halvg:0, rader:9,   gar:12},
  {name:'R 2-2-12',  helg:2, halvg:2, rader:12,  gar:12},
  {name:'R 5-3-12',  helg:5, halvg:3, rader:12,  gar:11},
  {name:'R 5-5-12',  helg:5, halvg:5, rader:12,  gar:11},
  {name:'R 0-7-16',  helg:0, halvg:7, rader:16,  gar:12},
  {name:'R 1-6-16',  helg:1, halvg:6, rader:16,  gar:12},
  {name:'R 5-0-18',  helg:5, halvg:0, rader:18,  gar:11},
  {name:'R 3-3-24',  helg:3, halvg:3, rader:24,  gar:12},
  {name:'R 4-4-24',  helg:4, halvg:4, rader:24,  gar:11},
  {name:'R 5-1-24',  helg:5, halvg:1, rader:24,  gar:11},
  {name:'R 6-0-36',  helg:6, halvg:0, rader:36,  gar:11},
  {name:'R 5-2-36',  helg:5, halvg:2, rader:36,  gar:11},
  {name:'R 4-5-48',  helg:4, halvg:5, rader:48,  gar:11},
  {name:'R 4-7-48',  helg:4, halvg:7, rader:48,  gar:12},
  {name:'R 5-4-48',  helg:5, halvg:4, rader:48,  gar:11},
  {name:'R 5-5-48',  helg:5, halvg:5, rader:48,  gar:11},
  {name:'R 5-6-48',  helg:5, halvg:6, rader:48,  gar:12},
  {name:'R 6-2-48',  helg:6, halvg:2, rader:48,  gar:11},
  {name:'R 6-6-48',  helg:6, halvg:6, rader:48,  gar:12},
  {name:'R 4-6-72',  helg:4, halvg:6, rader:72,  gar:12},
  {name:'R 5-5-108', helg:5, halvg:5, rader:108, gar:11},
  {name:'R 5-6-108', helg:5, halvg:6, rader:108, gar:12},
  {name:'R 7-2-108', helg:7, halvg:2, rader:108, gar:11},
  {name:'R 4-4-144', helg:4, halvg:4, rader:144, gar:12},
  {name:'R 4-7-144', helg:4, halvg:7, rader:144, gar:12},
  {name:'R 5-4-144', helg:5, halvg:4, rader:144, gar:11},
  {name:'R 9-0-243', helg:9, halvg:0, rader:243, gar:11},
  {name:'R 5-5-432', helg:5, halvg:5, rader:432, gar:11},
  {name:'R 5-6-432', helg:5, halvg:6, rader:432, gar:12},
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  U-SYSTEM DATA  (25 system, k√§lla: Svenska Spel systembroschyr)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const U_SYSTEMS = [
  {name:'U 0-7-10',   helg:0,  halvg:7,  rader:10},
  {name:'U 0-10-38',  helg:0,  halvg:10, rader:38},
  {name:'U 0-11-65',  helg:0,  halvg:11, rader:65},
  {name:'U 3-6-20',   helg:3,  halvg:6,  rader:20},
  {name:'U 3-6-50',   helg:3,  halvg:6,  rader:50},
  {name:'U 3-7-98',   helg:3,  halvg:7,  rader:98},
  {name:'U 4-3-66',   helg:4,  halvg:3,  rader:66},
  {name:'U 4-4-16',   helg:4,  halvg:4,  rader:16},
  {name:'U 4-4-44',   helg:4,  halvg:4,  rader:44},
  {name:'U 4-5-30',   helg:4,  halvg:5,  rader:30},
  {name:'U 4-5-68',   helg:4,  halvg:5,  rader:68},
  {name:'U 4-7-200',  helg:4,  halvg:7,  rader:200},
  {name:'U 5-5-44',   helg:5,  halvg:5,  rader:44},
  {name:'U 5-5-176',  helg:5,  halvg:5,  rader:176},
  {name:'U 5-6-274',  helg:5,  halvg:6,  rader:274},
  {name:'U 6-3-36',   helg:6,  halvg:3,  rader:36},
  {name:'U 6-4-66',   helg:6,  halvg:4,  rader:66},
  {name:'U 6-4-224',  helg:6,  halvg:4,  rader:224},
  {name:'U 7-3-100',  helg:7,  halvg:3,  rader:100},
  {name:'U 7-4-464',  helg:7,  halvg:4,  rader:464},
  {name:'U 8-2-253',  helg:8,  halvg:2,  rader:253},
  {name:'U 8-3-598',  helg:8,  halvg:3,  rader:598},
  {name:'U 9-2-202',  helg:9,  halvg:2,  rader:202},
  {name:'U 11-0-133', helg:11, halvg:0,  rader:133},
  {name:'U 13-0-105', helg:13, halvg:0,  rader:105},
];

function renderSystemTab() {
  let helgCount = 0, halvgCount = 0;
  MATCHES.forEach((m, i) => {
    const sel = selections[i];
    if (sel.size === 3) helgCount++;
    else if (sel.size === 2) halvgCount++;
  });
  document.getElementById('sys-info-box').textContent =
    'Du har f√∂r n√§rvarande: ' + helgCount + ' helgarderad' + (helgCount!==1?'e':'') +
    ' och ' + halvgCount + ' halvgarderad' + (halvgCount!==1?'e':'');
  const fits = R_SYSTEMS.filter(s => s.helg <= helgCount && s.halvg <= halvgCount);
  const bestSafe = fits.filter(s => s.gar >= 12).sort((a,b) => a.rader-b.rader)[0];
  const tbody = document.getElementById('sys-tbody');
  tbody.innerHTML = R_SYSTEMS.map(s => {
    const isExact = s.helg === helgCount && s.halvg === halvgCount;
    const isBest  = bestSafe && s.name === bestSafe.name;
    const garCls  = s.gar >= 12 ? 'sys-gar12' : 'sys-gar11';
    const rowCls  = isBest ? 'sys-row-best' : isExact ? 'sys-row-match' : '';
    const badge   = isBest ? ' ‚≠ê' : isExact ? ' ‚úì' : '';
    return '<tr class="' + rowCls + '"><td><strong>' + s.name + badge + '</strong></td>' +
           '<td>' + s.helg + '</td><td>' + s.halvg + '</td>' +
           '<td><strong>' + s.rader + ' kr</strong></td>' +
           '<td class="' + garCls + '">' + s.gar + ' r√§tt</td></tr>';
  }).join('');
  const recBox = document.getElementById('sys-rec-box');
  if (bestSafe) {
    recBox.innerHTML = '<h3>‚≠ê Rekommenderat: ' + bestSafe.name + '</h3>' +
      '<p>Med ' + helgCount + ' helg och ' + halvgCount + ' halvg passar ' + bestSafe.name +
      ' b√§st. Kostar ' + bestSafe.rader + ' kr och garanterar ' + bestSafe.gar + ' r√§tt om ramen st√§mmer.</p>';
  } else {
    recBox.innerHTML = '<h3>üí° Tips</h3><p>Markera garderingar i Min kupong f√∂r att se vilket R-system som passar dig b√§st.</p>';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  U-SYSTEM TAB
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderUSystemTab() {
  let helgCount = 0, halvgCount = 0;
  MATCHES.forEach((m, i) => {
    const sel = selections[i];
    if (sel.size === 3) helgCount++;
    else if (sel.size === 2) halvgCount++;
  });
  const infoEl = document.getElementById('usys-info-box');
  if (infoEl) infoEl.textContent =
    'Du har f√∂r n√§rvarande: ' + helgCount + ' helgarderad' + (helgCount!==1?'e':'') +
    ' och ' + halvgCount + ' halvgarderad' + (halvgCount!==1?'e':'');

  const fits = U_SYSTEMS.filter(s => s.helg <= helgCount && s.halvg <= halvgCount);
  const bestFit = fits.sort((a,b) => a.rader - b.rader)[0];

  const tbody = document.getElementById('usys-tbody');
  if (!tbody) return;
  tbody.innerHTML = U_SYSTEMS.map(s => {
    const isExact = s.helg === helgCount && s.halvg === halvgCount;
    const isBest  = bestFit && s.name === bestFit.name;
    const rowCls  = isBest ? 'sys-row-best' : isExact ? 'sys-row-match' : '';
    const badge   = isBest ? ' ‚≠ê' : isExact ? ' ‚úì' : '';
    return '<tr class="' + rowCls + '"><td><strong>' + s.name + badge + '</strong></td>' +
           '<td>' + s.helg + '</td><td>' + s.halvg + '</td>' +
           '<td><strong>' + s.rader + ' kr</strong></td>' +
           '<td class="sys-gar12">12 r√§tt*</td></tr>';
  }).join('');

  const recBox = document.getElementById('usys-rec-box');
  if (!recBox) return;
  if (bestFit && (helgCount > 0 || halvgCount > 0)) {
    recBox.innerHTML = '<h3>‚≠ê Rekommenderat: ' + bestFit.name + '</h3>' +
      '<p>Med ' + helgCount + ' helg och ' + halvgCount + ' halvg passar <strong>' + bestFit.name +
      '</strong> b√§st. Kostar ' + bestFit.rader + ' kr. Kom ih√•g att fylla i U-tecknet f√∂r varje garderad match!</p>';
  } else {
    recBox.innerHTML = '<h3>üí° Tips</h3><p>Markera garderingar i Min kupong f√∂r att se vilket U-system som passar dig b√§st.</p>';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RAD-EV KALKYLATOR  (Bennis & Hanna 2024)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRowEV() {
  const tbody = document.getElementById('rev-tbody');
  const info  = document.getElementById('rev-info');
  if (!tbody || !info) return;

  if (!MATCHES || !MATCHES.length) {
    info.textContent = 'Ladda en omg√•ng f√∂r att se rad-rankingen.';
    tbody.innerHTML  = '';
    return;
  }

  const nRows = selections.reduce((prod, s) => prod * s.size, 1);

  if (nRows > 10000) {
    info.textContent = 'Ditt system har ' + nRows.toLocaleString('sv') +
      ' rader ‚Äî f√∂r m√•nga f√∂r att ber√§kna (max 10 000). Minska antalet garderingar.';
    tbody.innerHTML = '';
    return;
  }

  // Enumerera alla rader i systemet
  const allRows = [];
  (function genRows(idx, cur) {
    if (idx === MATCHES.length) { allRows.push(cur.slice()); return; }
    for (const s of selections[idx]) { cur.push(s); genRows(idx + 1, cur); cur.pop(); }
  })(0, []);

  // Ber√§kna x1 (odds-sannolikhetsprodukt) och x3 (folkandelsprodukt) per rad
  const ranked = allRows.map(function(row) {
    let x1 = 1, x3 = 1;
    row.forEach(function(sign, i) {
      const m = MATCHES[i];
      const p = sign === '1' ? (m.xp1 || 33) / 100
              : sign === 'X' ? (m.xpx || 33) / 100
              :                (m.xp2 || 34) / 100;
      const f = sign === '1' ? (m.folk1 || m.f1 || 33) / 100
              : sign === 'X' ? (m.folkX || m.fx || 33) / 100
              :                (m.folk2 || m.f2 || 34) / 100;
      x1 *= p;
      x3 *= f;
    });
    return { row, x1, x3, ratio: x3 > 0 ? x1 / x3 : 0 };
  });

  ranked.sort((a, b) => b.ratio - a.ratio);

  const maxRatio = ranked[0] ? ranked[0].ratio : 1;
  const top = ranked.slice(0, 25);

  info.textContent = 'Ditt system har ' + nRows.toLocaleString('sv') + ' rad' +
    (nRows === 1 ? '' : 'er') + '. Visar de ' + top.length + ' med h√∂gst relativ EV.';

  tbody.innerHTML = top.map((r, rank) => {
    const signs  = r.row.join('');
    const barW   = Math.round((r.ratio / maxRatio) * 72);
    const relEV  = (r.ratio * 100).toFixed(1) + '%';
    const x1fmt  = r.x1 < 0.0001 ? r.x1.toExponential(2) : (r.x1 * 100).toFixed(3) + '%';
    const x3fmt  = r.x3 < 0.0001 ? r.x3.toExponential(2) : (r.x3 * 100).toFixed(3) + '%';
    const badge  = rank === 0 ? '<span class="rev-top-badge">B√ÑST</span>' : '';
    const cls    = rank < 3 ? ' class="rev-top"' : '';
    return '<tr' + cls + '>' +
      '<td>' + (rank + 1) + '</td>' +
      '<td><span class="rev-signs">' + signs + '</span>' + badge + '</td>' +
      '<td>' + relEV + '<span class="rev-ev-bar" style="width:' + barW + 'px"></span></td>' +
      '<td>' + x1fmt + '</td>' +
      '<td>' + x3fmt + '</td>' +
      '</tr>';
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GUIDE TOGGLE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleGuide() {
  const wrap = document.getElementById('guide-wrap');
  const showBar = document.getElementById('guide-show-bar');
  const hidden = wrap.style.display === 'none';
  wrap.style.display = hidden ? '' : 'none';
  showBar.style.display = hidden ? 'none' : 'block';
  try { localStorage.setItem('guide-hidden', hidden ? '0' : '1'); } catch(e){}
}
(function initGuide() {
  try {
    if (localStorage.getItem('guide-hidden') === '1') {
      const wrap = document.getElementById('guide-wrap');
      const showBar = document.getElementById('guide-show-bar');
      if (wrap) wrap.style.display = 'none';
      if (showBar) showBar.style.display = 'block';
    }
  } catch(e){}
})();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DELAD LOGIK ‚Äî parsa events + ladda omg√•ng i appen
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseDrawEvents(events, count) {
  return events.slice(0, count).map(e => {
    const desc = e.eventDescription || e.description || '';
    const sep  = desc.includes(' - ') ? ' - ' : ' ‚Äì ';
    const parts = desc.split(sep);
    const home = (e.homeTeam && (e.homeTeam.name||e.homeTeam.cleanName))
              || (e.participants && e.participants.find(p=>p.type==='home')?.name)
              || parts[0] || 'Hemma';
    const away = (e.awayTeam && (e.awayTeam.name||e.awayTeam.cleanName))
              || (e.participants && e.participants.find(p=>p.type==='away')?.name)
              || parts[1] || 'Borta';
    // API-format: odds = {one:"5,40", x:"4,40", two:"1,63"} ‚Äî komma som decimaltecken
    const pf = s => parseFloat(String(s||'0').replace(',','.'))||0;
    const o = e.odds || {};
    const o1 = pf(o.one  || o['1'] || o.home  ) || 2.00;
    const ox = pf(o.x    || o.X    || o['X']  ) || 3.50;
    const o2 = pf(o.two  || o['2'] || o.away  ) || 4.00;
    // Folkprocent: betMetrics.values[].distribution.distribution (str√§ng t.ex. "51")
    const vals = e.betMetrics?.values || [];
    const v1 = vals.find(v=>v.outcome==='1')||{};
    const vx = vals.find(v=>v.outcome==='X')||{};
    const v2 = vals.find(v=>v.outcome==='2')||{};
    const f1 = Math.round(pf(v1.distribution?.distribution)) || 33;
    const fx = Math.round(pf(vx.distribution?.distribution)) || 33;
    const f2 = Math.round(pf(v2.distribution?.distribution)) || 33;
    // Svenska Folket (separat fr√•n totala f√∂rdelningen)
    const sf = e.svenskaFolket || {};
    const folk1 = parseInt(sf.one)  || f1;
    const folkX = parseInt(sf.x)    || fx;
    const folk2 = parseInt(sf.two)  || f2;
    // Oddsr√∂relse sedan √∂ppning
    const so = e.startOdds || {};
    const startO1 = pf(so.one||so['1']) || o1;
    const startOx = pf(so.x  ||so['X']) || ox;
    const startO2 = pf(so.two||so['2']) || o2;
    const drift1 = Math.round((o1 - startO1) * 100) / 100;
    const driftX = Math.round((ox - startOx) * 100) / 100;
    const drift2 = Math.round((o2 - startO2) * 100) / 100;
    const hasDrift = Math.abs(drift1)>=0.1 || Math.abs(driftX)>=0.1 || Math.abs(drift2)>=0.1;
    // Matchinfo
    const liga = e.match?.league?.name || '';
    const ms = e.match?.matchStart;
    const startTime = ms ? (() => {
      const d = new Date(ms);
      return d.toLocaleDateString('sv-SE',{weekday:'short'}) + ' ' +
             d.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'});
    })() : '';
    const landIso = e.match?.participants?.[0]?.isoCode || '';
    const flag = {ENG:'üá¨üáß',SCO:'üá¨üáß',WAL:'üá¨üáß',NIR:'üá¨üáß',GER:'üá©üá™',ESP:'üá™üá∏',
      FRA:'üá´üá∑',ITA:'üáÆüáπ',NED:'üá≥üá±',POR:'üáµüáπ',BEL:'üáßüá™',SWE:'üá∏üá™',NOR:'üá≥üá¥',
      DEN:'üá©üá∞',GRE:'üá¨üá∑',TUR:'üáπüá∑',SCH:'üá®üá≠',AUT:'üá¶üáπ',CRO:'üá≠üá∑',SRB:'üá∑üá∏',
      USA:'üá∫üá∏',BRA:'üáßüá∑',ARG:'üá¶üá∑',MEX:'üá≤üáΩ',JPN:'üáØüáµ',CHN:'üá®üá≥',
      RUS:'üá∑üá∫',UKR:'üá∫üá¶',POL:'üáµüá±',CZE:'üá®üáø',HUN:'üá≠üá∫',ROU:'üá∑üá¥'}[landIso] || '';
    return {home:home.trim(), away:away.trim(), o1, ox, o2, f1, fx, f2,
            folk1, folkX, folk2, drift1, driftX, drift2, hasDrift,
            liga, startTime, flag};
  });
}

function applyDrawToApp(draw, gameName, minEvents) {
  const events = draw.events || draw.drawEvents || [];
  if (!events || events.length < minEvents) return false;
  const newMatches = parseDrawEvents(events, events.length);
  ROUND = gameName + ' Omg√•ng ' + draw.drawNumber;
  MATCHES = newMatches;
  // Spara slug + omg√•ngsnummer f√∂r auto-refresh
  _lastFetchedSlug = gameName === 'Stryktipset' ? 'stryktipset' : 'europatipset';
  _lastFetchedDrawNumber = draw.drawNumber;
  ctxFlags.length = 0;
  MATCHES.forEach(() => ctxFlags.push({ cup:false, wet:false, derby:false, degrad:false, tired:false }));
  const rl = document.getElementById('round-label');
  if (rl) rl.textContent = ROUND + ' ¬∑ V√§lj dina tecken nedan ‚Äì allt r√§knas ut direkt!';
  if (draw.closeTime) {
    const ct = new Date(draw.closeTime);
    const timerEl = document.getElementById('timer-closes');
    if (timerEl) timerEl.textContent =
      ct.toLocaleDateString('sv-SE',{weekday:'short'}) + ' ' +
      ct.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'});
  }
  computeMatchDerived(MATCHES);
  // √Öterst√§ll sparade val om de finns f√∂r denna omg√•ng
  selections = MATCHES.map(m => defaultSel(m));
  if (typeof loadSelections === 'function') {
    const restored = loadSelections();
    if (restored) showToast('üíæ Sparade val √•terst√§llda!');
  }
  renderMatches();
  recalc();
  renderCtxFlags();
  return true;
}

// Global: alla h√§mtade omg√•ngar (f√∂r pickern)
window._availableDraws = [];

function populateRoundPicker(drawOptions) {
  const picker = document.getElementById('round-picker');
  if (!picker || drawOptions.length === 0) return;
  picker.innerHTML = '<option value="">üìÖ Byt omg√•ng ‚Üí</option>';
  drawOptions.forEach((opt, i) => {
    const el = document.createElement('option');
    el.value = String(i);
    const closeStr = opt.draw.closeTime
      ? ' ¬∑ st√§nger ' + new Date(opt.draw.closeTime).toLocaleDateString('sv-SE',{weekday:'short',day:'numeric',month:'short'})
      : '';
    el.textContent = (opt.gameName === 'Stryktipset' ? 'üü° ' : 'üîµ ')
      + opt.gameName + ' Omg√•ng ' + opt.draw.drawNumber + closeStr;
    if (i === 0) el.selected = true;
    picker.appendChild(el);
  });
  picker.style.display = '';
  window._availableDraws = drawOptions;
}

async function fetchDrawByPicker(select) {
  const idx = parseInt(select.value);
  if (isNaN(idx) || !window._availableDraws[idx]) return;
  const {draw, gameName, minEvents} = window._availableDraws[idx];
  const ok = applyDrawToApp(draw, gameName, minEvents);
  if (ok) showToast('‚úÖ Laddade ' + gameName + ' Omg√•ng ' + draw.drawNumber);
  else showToast('‚ö†Ô∏è Omg√•ngdata ofullst√§ndig');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  AUTO-FETCH OMG√ÖNG (Svenska Spel API ‚Äî Stryktipset + Europatipset)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function fetchDrawData() {
  const banner = document.getElementById('api-banner');
  function showBanner(msg, bg, color, autohide) {
    if (!banner) return;
    banner.innerHTML = msg;
    banner.style.background = bg;
    banner.style.color = color;
    banner.style.display = 'block';
    if (autohide) setTimeout(() => { banner.style.display = 'none'; }, autohide);
  }

  async function tryFetch(gameSlug) {
    const API = 'https://api.spela.svenskaspel.se/draw/1/' + gameSlug + '/draws';
    const URLS = [
      'https://corsproxy.io/?url=' + encodeURIComponent(API),
      'https://api.codetabs.com/v1/proxy?quest=' + API,
      API,
    ];
    for (const url of URLS) {
      try {
        const r = await fetch(url);
        if (!r.ok) continue;
        const json = await r.json();
        if (json && 'draws' in json) return json;
      } catch(_) { continue; }
    }
    return null;
  }

  try {
    // H√§mta alla tillg√§ngliga omg√•ngar fr√•n B√ÖDA spelformerna parallellt
    const [stryk, euro] = await Promise.all([
      tryFetch('stryktipset'),
      tryFetch('europatipset'),
    ]);

    const allOptions = [];
    if (stryk && stryk.draws) {
      stryk.draws.forEach(d => allOptions.push({draw:d, gameName:'Stryktipset', minEvents:13, slug:'stryktipset'}));
    }
    if (euro && euro.draws) {
      euro.draws.forEach(d => allOptions.push({draw:d, gameName:'Europatipset', minEvents:8, slug:'europatipset'}));
    }

    // Sortera: Stryktipset alltid f√∂re Europatipset, sedan efter closeTime
    allOptions.sort((a,b) => {
      if (a.gameName !== b.gameName) {
        return a.gameName === 'Stryktipset' ? -1 : 1;
      }
      const ta = a.draw.closeTime ? new Date(a.draw.closeTime).getTime() : Infinity;
      const tb = b.draw.closeTime ? new Date(b.draw.closeTime).getTime() : Infinity;
      return ta - tb;
    });

    if (allOptions.length === 0) {
      showBanner('üì° Ingen √∂ppen omg√•ng just nu ‚Äî ny kupong √∂ppnar normalt onsdag‚Äìtorsdag. Visar demo-data.', '#fef3c7', '#78350f', 0);
      return;
    }

    // Fyll pickern med alla alternativ
    populateRoundPicker(allOptions);

    // Ladda Stryktipset i f√∂rsta hand ‚Äî prova alla alternativ i ordning tills ett lyckas
    let loadedOpt = null;
    for (const opt of allOptions) {
      const ok = applyDrawToApp(opt.draw, opt.gameName, opt.minEvents);
      if (ok) { loadedOpt = opt; break; }
    }
    if (!loadedOpt) {
      showBanner('‚ö†Ô∏è Ingen fullst√§ndig omg√•ng tillg√§nglig just nu ‚Äî provar igen om en stund.', '#fef3c7', '#78350f', 0);
      const rl = document.getElementById('round-label');
      if (rl) rl.textContent = 'Ingen aktiv omg√•ng ‚Äî f√∂rs√∂k igen snart';
      return;
    }
    const first = loadedOpt;

    const closeStr = first.draw.closeTime
      ? ' ¬∑ St√§nger ' + new Date(first.draw.closeTime).toLocaleDateString('sv-SE',{weekday:'long',day:'numeric',month:'short'})
        + ' ' + new Date(first.draw.closeTime).toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'})
      : '';
    const otherGames = allOptions.slice(1).map(o => o.gameName + ' Omg√•ng ' + o.draw.drawNumber).join(', ');
    const multiStr = otherGames ? ' ¬∑ √Ñven tillg√§nglig: ' + otherGames + ' (v√§lj i rullistan ‚Üë)' : '';
    showBanner('‚úÖ ' + ROUND + ' h√§mtad fr√•n Svenska Spel' + closeStr + multiStr, '#d1fae5', '#064e3b', 12000);
  } catch(err) {
    console.error('Svenska Spel API fetch failed:', err.message, err.stack);
    const rl2 = document.getElementById('round-label');
    if (rl2) rl2.textContent = '‚ö†Ô∏è Kunde inte ladda omg√•ng ‚Äî ladda om sidan (Cmd+R)';
    const banner2 = document.getElementById('api-banner');
    if (banner2) {
      banner2.innerHTML = '‚ùå Fel: ' + err.message + ' ‚Äî prova att ladda om sidan';
      banner2.style.background = '#fee2e2';
      banner2.style.color = '#7f1d1d';
      banner2.style.display = 'block';
    }
  }
})();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOCALSTORAGE ‚Äî Spara/√•terst√§ll val
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveSelections() {
  try {
    const key = 'stryk_sel_' + ROUND.replace(/\s+/g,'_');
    const data = selections.map(s => [...s]);
    localStorage.setItem(key, JSON.stringify(data));
  } catch(_) {}
}

function loadSelections() {
  try {
    const key = 'stryk_sel_' + ROUND.replace(/\s+/g,'_');
    const raw = localStorage.getItem(key);
    if (!raw) return false;
    const data = JSON.parse(raw);
    if (!Array.isArray(data) || data.length !== MATCHES.length) return false;
    const valid = ['1','X','2'];
    data.forEach((arr, i) => {
      const signs = arr.filter(s => valid.includes(s));
      if (signs.length > 0) selections[i] = new Set(signs);
    });
    return true;
  } catch(_) { return false; }
}

// Koppla saveSelections till alla val-√§ndringar
const _origToggleSimple = toggleSignSimple;
toggleSignSimple = function(matchIdx, sign) {
  _origToggleSimple(matchIdx, sign);
  saveSelections();
};
const _origToggleSign = toggleSign;
toggleSign = function(matchIdx, opt) {
  _origToggleSign(matchIdx, opt);
  saveSelections();
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KOPIERA KUPONG
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyKupong() {
  const rows = MATCHES.map((m, i) => {
    const sel = selections[i];
    const signs = [...sel].sort((a,b)=>'1X2'.indexOf(a)-'1X2'.indexOf(b)).join('/');
    return `${String(i+1).padStart(2,' ')}. ${m.home} - ${m.away}  ‚Üí  ${signs}`;
  });
  const nSigns = selections.reduce((sum, s) => sum + s.size, 0);
  const nRows = selections.reduce((prod, s) => prod * s.size, 1);
  const header = `${ROUND}\n${'‚îÄ'.repeat(40)}`;
  const footer = `${'‚îÄ'.repeat(40)}\n${nSigns} tecken ¬∑ ${nRows} rad${nRows===1?'':'er'}`;
  const text = [header, ...rows, footer].join('\n');
  navigator.clipboard.writeText(text).then(() => {
    showToast('üìã Kupong kopierad!');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('üìã Kupong kopierad!');
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SORTERING AV MATCHER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sortMode = 'round';
let sortOrder = [];  // originalindex ‚Üí sorterad position

function setSortMode(mode) {
  sortMode = mode;
  // Uppdatera knappar
  ['round','value','uncertain','time'].forEach(m => {
    const btn = document.getElementById('sort-'+m);
    if (btn) btn.classList.toggle('sort-btn-active', m===mode);
  });
  renderMatches();
}

function getSortedIndices() {
  const idxs = MATCHES.map((_,i)=>i);
  if (sortMode === 'value') {
    idxs.sort((a,b) => Math.max(MATCHES[b].vg1,MATCHES[b].vgx,MATCHES[b].vg2)
                      - Math.max(MATCHES[a].vg1,MATCHES[a].vgx,MATCHES[a].vg2));
  } else if (sortMode === 'uncertain') {
    // Mest os√§kra = mest j√§mna odds, l√§gst max-folkprocent
    idxs.sort((a,b) => {
      const ua = Math.max(MATCHES[a].folk1||MATCHES[a].f1||33, MATCHES[a].folkX||MATCHES[a].fx||33, MATCHES[a].folk2||MATCHES[a].f2||34);
      const ub = Math.max(MATCHES[b].folk1||MATCHES[b].f1||33, MATCHES[b].folkX||MATCHES[b].fx||33, MATCHES[b].folk2||MATCHES[b].f2||34);
      return ua - ub;
    });
  } else if (sortMode === 'time') {
    idxs.sort((a,b) => {
      const ta = MATCHES[a].startTime || '√∂';
      const tb = MATCHES[b].startTime || '√∂';
      return ta.localeCompare(tb, 'sv');
    });
  }
  // 'round' = beh√•ll originalordning
  return idxs;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  AUTO-REFRESH ODDS VAR 5:E MINUT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startAutoRefresh() {
  setInterval(async () => {
    if (!_lastFetchedSlug || !_lastFetchedDrawNumber) return;
    try {
      const API = 'https://api.spela.svenskaspel.se/draw/1/' + _lastFetchedSlug + '/draws';
      const url = 'https://corsproxy.io/?url=' + encodeURIComponent(API);
      const r = await fetch(url);
      if (!r.ok) return;
      const json = await r.json();
      if (!json || !json.draws) return;
      const draw = json.draws.find(d => d.drawNumber === _lastFetchedDrawNumber);
      if (!draw) return;
      // Kontrollera om odds f√∂r√§ndrats
      const events = draw.events || draw.drawEvents || [];
      if (!events.length) return;
      const pf = s => parseFloat(String(s||'0').replace(',','.'))||0;
      let changed = false;
      events.slice(0, MATCHES.length).forEach((e, i) => {
        const o = e.odds || {};
        const newO1 = pf(o.one||o['1'])||0;
        if (Math.abs(newO1 - MATCHES[i].o1) >= 0.05) changed = true;
      });
      if (changed) {
        // Uppdatera tyst ‚Äî spara val, re-apply, √•terst√§ll val
        const savedSels = selections.map(s => [...s]);
        const gameName = _lastFetchedSlug === 'stryktipset' ? 'Stryktipset' : 'Europatipset';
        const minEvents = _lastFetchedSlug === 'stryktipset' ? 13 : 8;
        applyDrawToApp(draw, gameName, minEvents);
        // √Öterst√§ll val om matchar
        if (savedSels.length === selections.length) {
          savedSels.forEach((arr, i) => {
            const signs = arr.filter(s => ['1','X','2'].includes(s));
            if (signs.length > 0) selections[i] = new Set(signs);
          });
          renderMatches();
          recalc();
        }
        showToast('‚ö° Odds uppdaterade!');
      }
    } catch(_) {}
  }, 5 * 60 * 1000); // var 5:e minut
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('round-label').textContent = ROUND+' ¬∑ V√§lj dina tecken nedan ‚Äì allt r√§knas ut direkt!';
// Applicera Elo direkt (inbyggd tabell ‚Äî ingen n√§tverksanrop)
applyEloToMatches();
const _eloFound = MATCHES.filter(m => m.hasElo).length;
const _eloEl = document.getElementById('elo-status');
if (_eloEl) _eloEl.textContent = `‚öΩ Elo: ${_eloFound}/${MATCHES.length} lag`;
renderMatches();
recalc();
renderCtxFlags();
showTab('start');
startAutoRefresh();
</script>
</body>
</html>
